<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIDENOVA CARLIFT</title>
    <link rel="icon" href="https://i.ibb.co/Q3y5smZH/Untitled-design-1.png" type="image/png">  
      <style>
        :root {
            --bg-main: #0a0c10;
            --bg-panel: rgba(17, 20, 28, 0.96);
            --accent: #d4af37; /* Professional Gold */
            --accent-hover: #b8962e;
            --text-main: #f0f0f0;
            --text-secondary: #a0a5b1;
            --shadow: rgba(212, 175, 55, 0.2);
            --border-color: #2c313d;
            --sea-green: #d4af37;
            --status-paid: #2ecc71;
            --status-unpaid: #e74c3c;
            --status-assigned: #3498db;
            --status-unassigned: #f39c12;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* Update Indicator */
         .update-indicator {
             display: inline-block;
             background: rgba(0, 255, 140, 0.15);
             color: #00ff8c;
             border: 1px solid rgba(0, 255, 140, 0.3);
             padding: 4px 8px;
             border-radius: 12px;
             font-size: 0.75rem;
             margin-left: 8px;
             font-weight: 600;
         }
.driver-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s;
}

.driver-item:hover {
    background-color: rgba(52, 152, 219, 0.05);
}

.driver-actions {
    display: flex;
    gap: 10px;
}
/* Ensure consistent table styling for new sections */
#profit-table, #expenses-table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(26, 29, 37, 0.8);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

#profit-table th, #expenses-table th,
#profit-table td, #expenses-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}
.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-edit {
    background-color: var(--primary-color);
    color: white;
}
/* Finance Subsection Styles */
.finance-subsection {
    display: none;
    width: 100%;
}

.finance-subsection.active {
    display: block;
}

.financial-breakdown {
    flex: 1;
    background: rgba(26, 29, 37, 0.6);
    padding: 20px;
    border-radius: 10px;
    border: 1px solid var(--border-color);
}

.financial-breakdown h5 {
    color: var(--accent);
    margin-bottom: 15px;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 8px;
}

.breakdown-item {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.breakdown-item.total {
    font-weight: bold;
    color: var(--accent);
    border-bottom: none;
    margin-top: 10px;
    padding-top: 15px;
    border-top: 2px solid var(--border-color);
}

.breakdown-item.final-total {
    font-size: 1.2em;
    font-weight: bold;
    color: var(--status-paid);
    background: rgba(0, 255, 140, 0.1);
    padding: 15px;
    border-radius: 8px;
    margin-top: 20px;
}

.net-profit-section {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid var(--accent);
}
.btn-edit:hover {
    background-color: var(--secondary-color);
}
        body, html {
            font-family: 'Poppins', Arial, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
            scroll-behavior: smooth;
            min-height: 100vh;
        }

        /* Background for login page */
        body.login-background {
            background: linear-gradient(rgba(10, 12, 16, 0.85), rgba(10, 12, 16, 0.95)), 
                        url('https://images.unsplash.com/photo-1503376780353-7e6692767b70?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        /* Loader Styles */
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 17, 23, 0.8);
            backdrop-filter: blur(20px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loader-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 48px;
            height: 48px;
            margin: auto;
            position: relative;
        }

        .loader:before {
            content: '';
            width: 48px;
            height: 5px;
            background: rgba(69, 243, 255, 0.3);
            position: absolute;
            top: 60px;
            left: 0;
            border-radius: 50%;
            animation: shadow324 0.5s linear infinite;
        }

        .loader:after {
            content: '';
            width: 100%;
            height: 100%;
            background: var(--accent);
            position: absolute;
            top: 0;
            left: 0;
            border-radius: 4px;
            animation: jump7456 0.5s linear infinite;
        }

        @keyframes jump7456 {
            15% {
                border-bottom-right-radius: 3px;
            }
            25% {
                transform: translateY(9px) rotate(22.5deg);
            }
            50% {
                transform: translateY(18px) scale(1, .9) rotate(45deg);
                border-bottom-right-radius: 40px;
            }
            75% {
                transform: translateY(9px) rotate(67.5deg);
            }
            100% {
                transform: translateY(0) rotate(90deg);
            }
        }

        @keyframes shadow324 {
            0%, 100% {
                transform: scale(1, 1);
            }
            50% {
                transform: scale(1.2, 1);
            }
        }

        /* Navbar / Taskbar */
        #navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 50px;
            background-color: var(--bg-panel);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px var(--shadow);
        }

        #navbar .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: var(--accent);
            text-shadow: 0 0 15px var(--shadow);
        }

        #navbar ul {
            display: flex;
            list-style: none;
            gap: 25px;
        }

        #navbar ul li {
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 5px;
            transition: 0.3s;
        }

        #navbar ul li:hover {
            background-color: var(--accent);
            color: var(--bg-main);
            box-shadow: 0 0 10px var(--accent);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* New Glass Card Styles */
        .card {
            background: rgba(26, 29, 37, 0.7);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(69, 243, 255, 0.1);
            box-shadow: 
                rgba(0, 0, 0, 0.17) 0px -23px 25px 0px inset, 
                rgba(0, 0, 0, 0.15) 0px -36px 30px 0px inset, 
                rgba(0, 0, 0, 0.1) 0px -79px 40px 0px inset, 
                rgba(0, 0, 0, 0.06) 0px 2px 1px, 
                rgba(0, 0, 0, 0.09) 0px 4px 2px, 
                rgba(0, 0, 0, 0.09) 0px 8px 4px, 
                rgba(0, 0, 0, 0.09) 0px 16px 8px, 
                rgba(0, 0, 0, 0.09) 0px 32px 16px,
                0 0 30px rgba(69, 243, 255, 0.1);
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 
                rgba(0, 0, 0, 0.17) 0px -23px 25px 0px inset, 
                rgba(0, 0, 0, 0.15) 0px -36px 30px 0px inset, 
                rgba(0, 0, 0, 0.1) 0px -79px 40px 0px inset, 
                rgba(0, 0, 0, 0.06) 0px 2px 1px, 
                rgba(0, 0, 0, 0.09) 0px 4px 2px, 
                rgba(0, 0, 0, 0.09) 0px 8px 4px, 
                rgba(0, 0, 0, 0.09) 0px 16px 8px, 
                rgba(0, 0, 0, 0.09) 0px 32px 16px,
                0 0 40px rgba(69, 243, 255, 0.2);
            border: 1px solid rgba(69, 243, 255, 0.3);
        }

        /* Header */
        .header {
            text-align: center;
            color: var(--text-main);
            margin-bottom: 30px;
        }

       .header h1 {
    font-size: 3rem;
    margin-bottom: 10px;
    color: var(--accent);
    /* Remove text-shadow glow */
    text-shadow: none;
    font-weight: 800;
    letter-spacing: 2px;
    background: linear-gradient(45deg, var(--accent), #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

        .header p {
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        /* Auth Container */
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(26, 29, 37, 0.8);
        }

        .auth-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: rgba(26, 29, 37, 0.8);
            border: none;
            font-size: 1rem;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }

        .auth-tab.active {
            background: var(--accent);
            color: var(--bg-main);
        }

        /* New Input Box Styles */
        .inputbox {
            position: relative;
            width: 100%;
            margin-bottom: 30px;
        }

        .inputbox input, .inputbox select {
    position: relative;
    width: 100%;
    padding: 20px 10px 10px;
    background: transparent;
    outline: none;
    box-shadow: none;
    border: none;
    color: #000000; /* Changed to black as requested */
    font-size: 1em;
    letter-spacing: 0.05em;
    transition: 0.5s;
    z-index: 10;
}
.notification-item {
    background: rgba(255, 255, 255, 0.05);
    padding: 15px;
    margin-bottom: 10px;
    border-left: 4px solid var(--accent);
    border-radius: 4px;
    color: var(--text-main);
    animation: fadeIn 0.5s;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}
        .inputbox span {
    position: absolute;
    left: 0;
    padding: 20px 10px 10px;
    font-size: 1em;
    color: #8f8f8f;
    letter-spacing: 0.05em;
    transition: 0.5s;
    pointer-events: none;
}

        .inputbox input:valid ~ span,
        .inputbox input:focus ~ span,
        .inputbox select:valid ~ span,
        .inputbox select:focus ~ span {
            color: var(--accent);
            transform: translateX(-10px) translateY(-34px);
            font-size: 0.75em;
        }

        .inputbox i {
            position: absolute;
            left: 0;
            bottom: 0;
            width: 100%;
            height: 2px;
            background: var(--accent);
            border-radius: 4px;
            transition: 0.5s;
            pointer-events: none;
            z-index: 9;
        }

        .inputbox input:valid ~ i,
        .inputbox input:focus ~ i,
        .inputbox select:valid ~ i,
        .inputbox select:focus ~ i {
            height: 44px;
        }

        /* FIXED: URL input fields maintain expanded state */
        .inputbox input:valid,
        .inputbox input:focus {
            height: auto;
            min-height: 44px;
        }

        /* New Button Styles - Bubbles */
        .bubbles {
            --c1: var(--bg-main);
            --c2: var(--accent);
            --size-letter: 16px;
            padding: 12px 24px;
            font-size: var(--size-letter);
            background-color: transparent;
            border: calc(var(--size-letter) / 6) solid var(--c2);
            border-radius: 0.2em;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            transition: 300ms cubic-bezier(0.83, 0, 0.17, 1);
            width: 100%;
        }

        .bubbles > .text {
            font-weight: 700;
            color: var(--c2);
            position: relative;
            z-index: 1;
            transition: color 700ms cubic-bezier(0.83, 0, 0.17, 1);
        }

        .bubbles::before {
            top: 0;
            left: 0;
        }

        .bubbles::after {
            top: 100%;
            left: 100%;
        }

        .bubbles::before,
        .bubbles::after {
            content: "";
            width: 150%;
            aspect-ratio: 1/1;
            scale: 0;
            transition: 1000ms cubic-bezier(0.76, 0, 0.24, 1);
            background-color: var(--c2);
            border-radius: 50%;
            position: absolute;
            translate: -50% -50%;
        }

        .bubbles:hover {
            & > .text {
                color: var(--c1);
            }
            &::before,
            &::after {
                scale: 1;
            }
        }

        .bubbles:active {
            scale: 0.98;
            filter: brightness(0.9);
        }

        /* Button variants */
        .driver-actions {
    display: flex;
    gap: 8px;
}

.btn-edit {
    background-color: var(--accent);
    color: var(--bg-main);
}

.btn-edit:hover {
    background-color: var(--accent-hover);
}
        .btn-small.bubbles {
            --size-letter: 14px;
            padding: 8px 16px;
            width: auto;
        }

        .btn-secondary.bubbles {
            --c2: #6c757d;
        }

        .btn-success.bubbles {
            --c2: #28a745;
        }

        .btn-danger.bubbles {
            --c2: #dc3545;
        }

        /* Dashboard Styles */
        .dashboard {
            display: none;
            width: 100%;
        }

        .dashboard.active {
            display: block;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .dashboard-title {
            font-size: 2rem;
            color: var(--text-main);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-menu {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 10px 20px;
            background: rgba(26, 29, 37, 0.8);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }

        .nav-btn:hover, .nav-btn.active {
            background: var(--accent);
            color: var(--bg-main);
            border-color: var(--accent);
            box-shadow: 0 0 10px var(--shadow);
        }

        .section {
            display: none;
            width: 100%;
        }

        .section.active {
            display: block;
        }

        /* FIXED: Ensure dropdowns appear above table content */
#admin-profiles-table td {
    position: relative;
    overflow: visible;
}

#admin-profiles-table .table-choice-container {
    position: static; /* Change from relative to static */
}

/* FIXED: Dashboard table dropdown width */
#admin-dashboard-table .table-choice-options {
    position: fixed;
    z-index: 10000;
    width: auto;
    min-width: 180px;
    max-width: 250px; /* Add max-width */
    transform: none;
    left: auto;
    top: auto;
    white-space: nowrap; /* Prevent text wrapping */
    overflow-x: hidden; /* Hide horizontal overflow */
}

#admin-dashboard-table .table-choice-option {
    padding: 10px 12px;
    color: var(--text-main);
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: 0.9em;
    white-space: nowrap; /* Prevent text wrapping */
    overflow: hidden; /* Hide overflow */
    text-overflow: ellipsis; /* Show ellipsis for long text */
}

#admin-dashboard-table .table-choice-box {
    width: 100%;
    padding: 8px 12px;
    background: rgba(26, 29, 37, 0.8);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-main);
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 10;
    white-space: nowrap; /* Prevent text wrapping */
    overflow: hidden; /* Hide overflow */
    text-overflow: ellipsis; /* Show ellipsis for long text */
}

        th {
            background: rgba(26, 29, 37, 0.9);
            font-weight: 600;
            color: var(--text-secondary);
        }

        tr:hover {
            background: rgba(26, 29, 37, 0.6);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--accent), #764ba2);
            color: var(--bg-main);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 0 20px var(--shadow);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.info {
            background: var(--accent);
            color: var(--bg-main);
        }

        /* Social Links */
        .social-links {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }

        .social-link {
            display: inline-block;
            padding: 10px 20px;
            background: #25d366;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .social-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .social-link.facebook {
            background: #1877f2;
        }

        .social-link.maps {
            background: #4285f4;
        }

        /* Invoice Form */
        .invoice-form {
            background: rgba(26, 29, 37, 0.8);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        /* Filter Options */
        .filter-options {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .filter-options label {
            margin-right: 10px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .filter-options .nav-btn {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        /* Modal Styles */
        .invoice-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            overflow-y: auto;
        }

        .invoice-modal-content {
            background: var(--bg-panel);
            margin: 50px auto;
            padding: 30px;
            border-radius: 15px;
            max-width: 800px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
            border: 1px solid var(--border-color);
            z-index: 2001;
        }

        .invoice-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--accent);
        }

        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .invoice-section {
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(26, 29, 37, 0.8);
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .invoice-section h4 {
            color: var(--accent);
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-secondary);
            background: none;
            border: none;
        }

        .close-modal:hover {
            color: #dc3545;
        }

        /* Status Styles */
        .hidden {
            display: none !important;
        }

        /* Simplified Status Badges */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            min-width: 90px;
        }

        .status-paid {
            background: rgba(0, 255, 140, 0.15);
            color: #00ff8c;
            border: 1px solid rgba(0, 255, 140, 0.3);
        }

        .status-unpaid {
            background: rgba(255, 0, 87, 0.15);
            color: #ff0057;
            border: 1px solid rgba(255, 0, 87, 0.3);
        }

        .status-assigned {
            background: rgba(0, 234, 255, 0.15);
            color: #00eaff;
            border: 1px solid rgba(0, 234, 255, 0.3);
        }

        .status-unassigned {
            background: rgba(255, 204, 0, 0.15);
            color: #ffcc00;
            border: 1px solid rgba(255, 204, 0, 0.3);
        }

        .status-default {
            background: rgba(157, 163, 176, 0.15);
            color: #9da3b0;
            border: 1px solid rgba(157, 163, 176, 0.3);
        }

        /* Enhanced Status Button Styles */
        .status-container {
            position: relative;
            width: 100%;
        }

        /* Bubble base style */
        .status-bubbles {
            --c1: var(--bg-main);
            --c2: var(--sea-green);
            --size-letter: 16px;
            background-color: transparent;
            border: calc(var(--size-letter) / 6) solid var(--c2);
            border-radius: 50px;
            padding: 14px 40px;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            transition: 400ms cubic-bezier(0.83, 0, 0.17, 1);
            width: 100%;
            text-align: center;
        }

        .status-bubbles > .text {
            font-weight: 600;
            color: var(--c2);
            position: relative;
            z-index: 1;
            transition: color 500ms cubic-bezier(0.83, 0, 0.17, 1);
        }

        /* Background fill circles */
        .status-bubbles::before,
        .status-bubbles::after {
            content: "";
            width: 150%;
            aspect-ratio: 1/1;
            scale: 0;
            background-color: var(--c2);
            border-radius: 50%;
            position: absolute;
            translate: -50% -50%;
            transition: scale 1000ms cubic-bezier(0.76, 0, 0.24, 1);
        }

        .status-bubbles::before {
            top: 0;
            left: 0;
        }

        .status-bubbles::after {
            top: 100%;
            left: 100%;
        }

        /* When filled */
        .status-bubbles.filled::before,
        .status-bubbles.filled::after {
            scale: 1;
        }
        .status-bubbles.filled > .text {
            color: var(--c1);
        }

        .status-bubbles:active {
            scale: 0.98;
            filter: brightness(0.9);
        }

        /* Dropdown */
        .status-options {
            position: absolute;
            top: 65px;
            left: 50%;
            transform: translateX(-50%) scaleY(0);
            transform-origin: top;
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid var(--sea-green);
            border-radius: 15px;
            padding: 10px 0;
            transition: 0.4s ease;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
            overflow: hidden;
            width: 100%;
            opacity: 0;
            z-index: 100;
        }

        .status-container.active .status-options {
            transform: translateX(-50%) scaleY(1);
            opacity: 1;
        }

        .status-option {
            display: block;
            background: transparent;
            border: none;
            color: var(--sea-green);
            padding: 12px 0;
            width: 100%;
            text-align: center;
            font-size: 16px;
            cursor: pointer;
            transition: 0.3s ease;
        }

        .status-option:hover {
            background: var(--sea-green);
            color: white;
        }

        /* Status color themes */
        .status-bubbles.passenger { --c2: var(--sea-green); }
        .status-bubbles.driver { --c2: var(--sea-green); }
        .status-bubbles.paid { --c2: var(--status-paid); }
        .status-bubbles.unpaid { --c2: var(--status-unpaid); }
        .status-bubbles.assigned { --c2: var(--status-assigned); }
        .status-bubbles.unassigned { --c2: var(--status-unpaid); }

        /* Choice Box Styles (without underline) */
        .choice-container {
            position: relative;
            width: 100%;
            margin-bottom: 30px;
        }

        .choice-box {
            width: 100%;
            padding: 15px;
            background: rgba(26, 29, 37, 0.8);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-main);
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .choice-box:hover {
            border-color: var(--accent);
        }

        .choice-options {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: rgba(26, 29, 37, 0.95);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .choice-container.active .choice-options {
            display: block;
        }

        .choice-option {
            padding: 12px 15px;
            color: var(--text-main);
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .choice-option:last-child {
            border-bottom: none;
        }

        .choice-option:hover {
            background: var(--accent);
            color: var(--bg-main);
        }

 /* FIXED: Table dropdown positioning that works */
/* FIXED: Table dropdown positioning */
.table-choice-container {
    position: relative;
    width: 100%;
}

.table-choice-box {
    width: 100%;
    padding: 8px 12px;
    background: rgba(26, 29, 37, 0.8);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-main);
    font-size: 0.9em;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 10;
}

.table-choice-box:hover {
    border-color: var(--accent);
}

.table-choice-options {
    position: fixed; /* Keeps it from getting cut off by the table */
    background: rgba(10, 12, 18, 0.98);
    border: 1px solid var(--accent);
    border-radius: 6px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.8);
    z-index: 10000;
    display: none;
    max-height: 250px; /* Limits height so it doesn't hit the bottom of the screen */
    overflow-y: auto;  /* Makes the list of names scrollable */
    margin-top: 2px;
}

.table-choice-container.active .table-choice-options {
    display: block;
}

.table-choice-option {
    padding: 10px 12px;
    color: var(--text-main);
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: 0.9em;
    white-space: nowrap;
}

.table-choice-option:last-child {
    border-bottom: none;
}

.table-choice-option:hover {
    background: var(--accent);
    color: var(--bg-main);
}

.table-choice-box.selected {
    background: rgba(69, 243, 255, 0.2);
    border-color: var(--accent);
    color: var(--accent);
}

/* FIXED: Ensure table containers allow dropdown overflow */
.table-container {
    overflow-x: auto;
    overflow-y: visible !important; /* Allows dropdowns to be seen */
    position: relative;
}

/* FIXED: Prevent table from clipping dropdowns */
table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(26, 29, 37, 0.8);
    border-radius: 8px;
    overflow: visible; /* Ensure this is visible */
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    position: relative; /* Add this */
}

/* FIXED: Ensure table cells don't clip dropdowns */
th, td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    position: relative;
    overflow: visible; /* This is crucial */
}

/* FIXED: Specific fix for admin tables */
#admin-profiles-table,
#admin-invoices-table {
    overflow: visible;
}

#admin-profiles-table td,
#admin-invoices-table td {
    overflow: visible;
    position: relative;
}

#admin-profiles-table .table-choice-container,
#admin-invoices-table .table-choice-container {
    position: relative;
}

#admin-profiles-table .table-choice-options,
#admin-invoices-table .table-choice-options {
    position: absolute;
    z-index: 1000;
}

               /* FIXED: Better spacing for modal content */
        .invoice-section p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .invoice-section p strong {
            display: inline-block;
            min-width: 150px;
        }

        /* ========== ADD THE DROPDOWN FIX CSS HERE ========== */
        /* FIXED: Invoice table dropdown positioning */
        #admin-invoices-table td {
            position: relative;
            overflow: visible;
        }

        #admin-invoices-table .table-choice-container {
            position: static;
        }

        #admin-invoices-table .table-choice-options {
            position: fixed;
            z-index: 10000;
            width: auto;
            min-width: 120px;
            transform: none;
            left: auto;
            top: auto;
        }

        #admin-invoices-table .table-choice-container.active .table-choice-options {
            display: block;
            position: fixed;
            background: rgba(10, 12, 18, 0.98);
            border: 1px solid var(--accent);
            border-radius: 6px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 10000;
        }

        /* FIXED: Ensure all admin tables have proper dropdown positioning */
        #admin-profiles-table td,
        #admin-invoices-table td {
            position: relative;
            overflow: visible;
        }

        #admin-profiles-table .table-choice-container,
        #admin-invoices-table .table-choice-container {
            position: static;
        }

        #admin-profiles-table .table-choice-options,
        #admin-invoices-table .table-choice-options {
            position: fixed;
            z-index: 10000;
            width: auto;
            min-width: 150px;
            transform: none;
            left: auto;
            top: auto;
        }

        #admin-profiles-table .table-choice-container.active .table-choice-options,
        #admin-invoices-table .table-choice-container.active .table-choice-options {
            display: block;
            position: fixed;
            background: rgba(10, 12, 18, 0.98);
            border: 1px solid var(--accent);
            border-radius: 6px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 10000;
        }
       

        /* Responsive */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .nav-menu {
                flex-direction: column;
            }
            
            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .invoice-details {
                grid-template-columns: 1fr;
            }
            
            .invoice-modal-content {
                margin: 20px;
                padding: 20px;
            }
            
            #navbar {
                flex-direction: column;
                gap: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body class="login-background">
    <!-- Loader Overlay -->
    <div id="loader-overlay" class="loader-overlay">
        <div class="loader"></div>
    </div>

    <!-- Navbar -->
    <div id="navbar">
        <div class="logo">RIDENOVA CARLIFT</div>

    </div>

    <div class="container">
        <div class="header">
            <link rel="icon" href="https://i.ibb.co/Q3y5smZH/Untitled-design-1.png" type="image/png">
            <h1>RIDENOVA CARLIFT</h1>

            <p>Premium Transportation Services Worldwide</p>
        </div>

        <!-- Authentication Section -->
        <div id="auth-section" class="card auth-container">
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Login</button>
                <button class="auth-tab" onclick="switchAuthTab('signin')">Sign Up</button>
            </div>

            <!-- Login Form -->
            <div id="login-form">
                <div class="inputbox">
                    <input type="text" id="login-username" required="required">
                    <span>Username</span>
                    <i></i>
                </div>
                <div class="inputbox">
                    <input type="password" id="login-password" required="required">
                    <span>Password</span>
                    <i></i>
                </div>
                <button class="bubbles" onclick="login()">
                    <span class="text">Login</span>
                </button>
                                <!-- Add this after the login button in the login form -->
                <div style="text-align: center; margin-top: 15px;">
                    <button class="bubbles btn-small" onclick="showForgotPasswordModal()" style="width: auto; --size-letter: 14px;">
                        <span class="text">Forgot Password?</span>
                    </button>
                </div>
            </div>

            <!-- Sign Up Form -->
            <div id="signin-form" class="hidden">
                <div class="inputbox">
                    <input type="text" id="signin-fullname" required="required">
                    <span>Full Name</span>
                    <i></i>
                </div>
                <div class="inputbox">
                    <input type="email" id="signin-email" required="required">
                    <span>Email Address</span>
                    <i></i>
                </div>
                <div class="inputbox">
                    <input type="tel" id="signin-phone" required="required">
                    <span>Phone Number</span>
                    <i></i>
                </div>
                <div class="inputbox">
                    <div class="status-container" id="role-status-container">
                        <button class="status-bubbles" id="role-status-button">
                            <span class="text">Select Role</span>
                        </button>
                        <div class="status-options" id="role-options-menu">
                            <button class="status-option" data-status="passenger">Passenger Employee</button>
                            <button class="status-option" data-status="driver">Driver Employee</button>
                        </div>
                    </div>
                </div>
                <div class="inputbox">
                    <input type="password" id="signin-password" required="required">
                    <span>Password</span>
                    <i></i>
                </div>
                <div class="inputbox">
                    <input type="password" id="signin-confirm-password" required="required">
                    <span>Confirm Password</span>
                    <i></i>
                </div>
                <button class="bubbles" onclick="signUp()">
                    <span class="text">Sign Up</span>
                </button>
            </div>
        </div>

        <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="dashboard">
        <div class="dashboard-header">
            <h2 class="dashboard-title">Admin Dashboard</h2>
            <div class="user-info">
                <span id="admin-welcome">Welcome, Admin</span>
                <button class="bubbles btn-small btn-secondary" onclick="logout()">
                    <span class="text">Logout</span>
                </button>
            </div>
    </div>

    <div class="nav-menu">
        <button class="nav-btn active" onclick="showAdminSection('dashboard')">Dashboard</button>
        <button class="nav-btn" onclick="showAdminSection('employees')">Employees</button>
        <button class="nav-btn" onclick="showAdminSection('targets')">Assign Target</button>
        <button class="nav-btn" onclick="showAdminSection('profiles')">Passenger Profiles</button>
        <button class="nav-btn" onclick="showAdminSection('cancelled')">Cancelled Profiles</button>
        <button class="nav-btn" onclick="showAdminSection('invoices')">Invoices</button>
        <button class="nav-btn" onclick="showAdminSection('split')">Split Profile</button>
        <button class="nav-btn" onclick="showAdminSection('finance')">Finance </button>
        <button class="nav-btn" onclick="showAdminSection('attendance')">Attendance</button>

    </div>

<!-- Dashboard Section -->
<div id="admin-dashboard-section" class="section active">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Dashboard - All Passenger Profiles</h3>
        <div class="inputbox" style="width: 200px; margin-bottom: 0;">
            <input type="month" id="dashboard-month-filter" required="required">
            <span>Select Month</span>
            <i></i>
        </div>
    </div>
    <div class="table-container">
        <table id="admin-dashboard-table">
            <thead>
                <tr>
                    <th>Passenger Name</th>
                    <th>Agent Name</th>
                    <th>Total Budget</th>
                    <th>Driver Agent</th>
                    <th>Pickup Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
            <!-- Employees Section -->
          
<div id="admin-employees" class="section">
                <div class="filter-options" style="margin-bottom: 20px;">
                    <label><strong>Filter by Role:</strong></label>
                    <button class="bubbles btn-small nav-btn active" onclick="filterEmployeesByRole('all')">
                        <span class="text">All Employees</span>
                    </button>
                    <button class="bubbles btn-small nav-btn" onclick="filterEmployeesByRole('passenger')">
                        <span class="text">Passenger Side</span>
                    </button>
                    <button class="bubbles btn-small nav-btn" onclick="filterEmployeesByRole('driver')">
                        <span class="text">Driver Side</span>
                    </button>
                </div>       
                <h3>Employee Management</h3>
                <div class="table-container">
                    <table id="employees-table">
                        <thead>
                            <tr>
                                <th>User Name</th>
                                <th>Username</th>
                                <th>Role</th>
                                <th>Working Hours</th>
                                <th>Earnings</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <!-- Assign Target Section -->
            <div id="admin-targets" class="section">
                <h3>Assign Targets to Employees</h3>
                
                <!-- Search and Filter Section -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; flex-wrap: wrap;">
                    <!-- Search Bar -->
                    <div class="inputbox" style="flex: 1; margin-bottom: 0; min-width: 250px;">
                        <input type="text" id="employee-search" placeholder=" " onkeyup="searchEmployees()">
                        <span>Search Employee by Name</span>
                        <i></i>
                    </div>
                    
                    <!-- Filter Options -->
                    <div class="filter-options" style="margin-bottom: 0;">
                        <button class="bubbles btn-small nav-btn active" onclick="filterEmployees('all')">
                            <span class="text">All Employees</span>
                        </button>
                        <button class="bubbles btn-small nav-btn" onclick="filterEmployees('assigned')">
                            <span class="text">Assigned</span>
                        </button>
                        <button class="bubbles btn-small nav-btn" onclick="filterEmployees('not-assigned')">
                            <span class="text">Not Assigned</span>
                        </button>
                    </div>
                </div>
                
                <!-- Employees Target Table -->
                <div class="table-container">
                    <table id="admin-targets-table">
                        <thead>
                            <tr>
                                <th>Employee Name</th>
                                <th>Role</th>
                                <th>Assigned Target</th>
                                <th>Achieved Target</th>
                                <th>Progress</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <!-- Passenger Profiles Section -->
            <div id="admin-profiles" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Passenger Profile Management</h3>
                    <div class="inputbox" style="width: 200px; margin-bottom: 0;">
                        <input type="month" id="profiles-month-filter" required="required">
                        <span>Select Month</span>
                        <i></i>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="admin-profiles-table">
                        <thead>
                            <tr>
                                <th>passenger name</th>
                                <th>Agent Name</th>
                                <th>Total Budget</th>
                                <th>Driver Agent</th>
                                <th>Pickup Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
<!-- Cancelled Profiles Section -->
            <div id="admin-cancelled" class="section"> 
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"> 
                    <h3>Cancelled Passenger Profiles</h3> 
                    <div class="inputbox" style="width: 200px; margin-bottom: 0;"> 
                        <input type="month" id="cancelled-month-filter" required="required"> 
                        <span>Select Month</span> 
                        <i></i> 
                    </div> 
                </div> 
                 
                <div class="table-container"> 
                    <table id="admin-cancelled-table"> 
                        <thead> 
                            <tr> 
                                <th>Profile ID</th> 
                                <th>Agent Name</th> 
                                <th>Total Budget</th> 
                                <th>Driver Agent</th> 
                                <th>Cancelled Date</th> 
                                <th>Actions</th> 
                            </tr> 
                        </thead> 
                        <tbody></tbody> 
                    </table> 
                </div> 
            </div> 
            <!-- Invoices Section -->
            <div id="admin-invoices" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Invoice Management</h3>
                    <div class="inputbox" style="width: 200px; margin-bottom: 0;">
                        <input type="month" id="invoices-month-filter" required="required">
                        <span>Select Month</span>
                        <i></i>
                    </div>
                </div>
                
                <!-- Filter Options -->
                <div class="filter-options" style="margin-bottom: 20px;">
                    <label><strong>Filter by:</strong></label>
                    <button class="bubbles btn-small nav-btn active" onclick="filterAdminInvoices('all')">
                        <span class="text">All Invoices</span>
                    </button>
                    <button class="bubbles btn-small nav-btn" onclick="filterAdminInvoices('unpaid')">
                        <span class="text">Not Paid</span>
                    </button>
                    <button class="bubbles btn-small nav-btn" onclick="filterAdminInvoices('paid')">
                        <span class="text">Paid</span>
                    </button>
                </div>
                
                <div class="table-container">
                    <table id="admin-invoices-table">
                        <thead>
                            <tr>
                                <th>Agent Name</th>
                                <th>Driver Side Payment</th>
                                <th>Passenger Side Payment</th>
                                <th>Driver Payment Status</th>
                                <th>Passenger Payment Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
<div id="admin-attendance" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Employee Attendance</h3>
        <div class="inputbox" style="width: 200px; margin-bottom: 0;">
            <input type="date" id="attendance-date-filter" required="required" onchange="renderAttendanceSection()">
            <span>Select Date</span>
            <i></i>
        </div>
    </div>

    <div class="table-container">
        <table id="attendance-table">
            <thead>
                <tr>
                    <th>Employee Name</th>
                    <th>Role</th>
                    <th>Hours Worked</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<div id="admin-split" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Split Profile Management</h3>
        <button class="bubbles" onclick="openSplitProfileSelector()" style="width: auto; min-width: 150px;">
            <span class="text">Add Split Profile</span>
        </button>
    </div>

    <div class="table-container">
        <table id="admin-split-table">
            <thead>
                <tr>
                    <th>Profile ID</th>
                    <th>Passenger Name</th>
                    <th>Creator Agent</th>
                    <th>Split With (2nd Agent)</th>
                    <th>Total Budget</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<div id="split-select-profile-modal" class="invoice-modal">
    <div class="invoice-modal-content" style="max-width: 900px;">
        <button class="close-modal" onclick="closeSplitModals()"></button>
        <div class="invoice-header">
            <h2>Step 1: Select Profile</h2>
            <p>Click on a profile to split it</p>
        </div>
        <div class="inputbox">
            <input type="text" id="split-search-profile" placeholder=" " onkeyup="renderSplitProfileSelectionTable()">
            <span>Search Profile (Name or ID)</span>
            <i></i>
        </div>
        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
            <table id="split-selection-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Passenger</th>
                        <th>Current Agent</th>
                        <th>Budget</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<div id="split-select-employee-modal" class="invoice-modal">
    <div class="invoice-modal-content" style="max-width: 600px;">
        <button class="close-modal" onclick="closeSplitModals()"></button>
        <div class="invoice-header">
            <h2>Step 2: Select Employee</h2>
            <p>Who should share this profile?</p>
        </div>
        <div class="inputbox">
            <input type="text" id="split-search-employee" placeholder=" " onkeyup="renderSplitEmployeeSelectionTable()">
            <span>Search Employee</span>
            <i></i>
        </div>
        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
            <table id="split-employee-table">
                <thead>
                    <tr>
                        <th>Employee Name</th>
                        <th>Role</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
<div id="attendance-modal" class="invoice-modal">
    <div class="invoice-modal-content" style="max-width: 500px;">
        <button class="close-modal" onclick="closeAttendanceModal()"></button>
        <div class="invoice-header">
            <h2>Monthly Attendance</h2>
            <p id="attendance-modal-name">Employee Name</p>
        </div>
        
        <div class="invoice-form">
            <div class="stats-grid" style="grid-template-columns: 1fr 1fr; margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-value" id="att-days-worked">0</div>
                    <div class="stat-label">Days Present (4h+)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="att-days-total">0</div>
                    <div class="stat-label">Days in Month</div>
                </div>
            </div>
            
            <div class="inputbox">
                <p style="color: var(--text-secondary); margin-bottom: 10px;">Viewing Month:</p>
                <input type="month" id="attendance-modal-month" onchange="updateAttendanceModal()">
            </div>

            <div id="attendance-progress-container" style="background: rgba(26, 29, 37, 0.8); padding: 15px; border-radius: 8px;">
                <p>Attendance Rate: <span id="att-rate-text" style="float:right; color: var(--accent);">0%</span></p>
                <div style="background: var(--border-color); height: 10px; border-radius: 5px; margin-top: 10px; overflow: hidden;">
                    <div id="att-progress-bar" style="background: var(--status-paid); height: 100%; width: 0%;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Finance Section -->
<div id="admin-finance" class="section">
    <div class="dashboard-header">
        <h2 class="dashboard-title">Financial Management</h2>
        <div class="user-info">
            <div class="inputbox" style="width: 200px; margin-bottom: 0;">
                <input type="month" id="finance-month-filter" required="required">
                <span>Select Month</span>
                <i></i>
            </div>
        </div>
    </div>

    <!-- Finance Sub Navigation -->
    <div class="nav-menu" style="margin-bottom: 30px;">
        <button class="nav-btn active" onclick="showFinanceSubSection('overview')">Financial Overview</button>
        <button class="nav-btn" onclick="showFinanceSubSection('profit')">Profit Details</button>
        <button class="nav-btn" onclick="showFinanceSubSection('expenses')">Expense Details</button>
        <button class="nav-btn" onclick="showFinanceSubSection('salaries')">Salary Management</button>
    </div>

    <!-- Financial Overview Subsection -->
    <div id="finance-overview" class="finance-subsection active">
        <h3>Financial Overview</h3>
        
        <!-- Main Financial Stats -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-profit-overview">AED 0</div>
                <div class="stat-label">Total Profit</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-expenses-overview">AED 0</div>
                <div class="stat-label">Total Expenses</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="net-profit">0</div>
                <div class="stat-label">Net Profit</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="profit-margin">0%</div>
                <div class="stat-label">Profit Margin</div>
            </div>
        </div>

        <!-- Detailed Breakdown -->
        <div class="card" style="margin-top: 20px;">
            <h4>Detailed Financial Breakdown</h4>
            <div class="form-row">
                <div class="financial-breakdown">
                    <h5>Revenue Sources</h5>
                    <div class="breakdown-item">
                        <span>Driver Side Revenue:</span>
                        <span id="driver-revenue">AED 0</span>
                    </div>
                    <div class="breakdown-item">
                        <span>Passenger Side Revenue:</span>
                        <span id="passenger-revenue">AED 0</span>
                    </div>
                    <div class="breakdown-item total">
                        <span>Total Revenue:</span>
                        <span id="total-revenue">AED 0</span>
                    </div>
                </div>
                
                <div class="financial-breakdown">
                    <h5>Expenses</h5>
                    <div class="breakdown-item">
                        <span>Operational Expenses:</span>
                        <span id="operational-expenses">AED 0</span>
                    </div>
                    <div class="breakdown-item">
                        <span>Salary Expenses:</span>
                        <span id="salary-expenses">AED 0</span>
                    </div>
                    <div class="breakdown-item total">
                        <span>Total Expenses:</span>
                        <span id="total-expenses-overview-detailed">AED 0</span>
                    </div>
                </div>
            </div>
            
            <!-- Net Profit Calculation -->
            <div class="net-profit-section">
                <div class="breakdown-item final-total">
                    <span>Net Profit (Revenue - Expenses):</span>
                    <span id="net-profit-detailed">AED 0</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Profit Details Subsection -->
    <div id="finance-profit" class="finance-subsection">
        <h3>Profit Management</h3>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-profit-detailed">AED 0</div>
                <div class="stat-label">Total Profit</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="driver-side-profit">AED 0</div>
                <div class="stat-label">Driver Side Profit</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="passenger-side-profit">AED 0</div>
                <div class="stat-label">Passenger Side Profit</div>
            </div>
        </div>
        
        <div class="table-container">
            <table id="profit-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Invoice ID</th>
                        <th>Amount</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Expense Details Subsection -->
    <div id="finance-expenses" class="finance-subsection">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>Expense Management</h3>
            <button class="bubbles" onclick="showAddExpenseModal()" style="width: auto; min-width: 150px;">
                <span class="text">Add Expense</span>
            </button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="total-expenses-detailed">AED 0</div>
                <div class="stat-label">Total Expenses</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="monthly-expenses">AED 0</div>
                <div class="stat-label">This Month</div>
            </div>
        </div>
        
        <div class="table-container">
            <table id="expenses-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Expense Type</th>
                        <th>Amount</th>
                        <th>Description</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Salary Management Subsection -->
    <div id="finance-salaries" class="finance-subsection">
        <h3>Salary Management</h3>
        
        <!-- Search Bar -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px;">
            <div class="inputbox" style="flex: 1; margin-bottom: 0;">
                <input type="text" id="salary-search" placeholder=" " onkeyup="searchEmployeesForSalary()">
                <span>Search Employee by Name</span>
                <i></i>
            </div>
        </div>
        
        <!-- Salary Table -->
        <div class="table-container">
            <table id="salary-table">
                <thead>
                    <tr>
                        <th>Employee Name</th>
                        <th>Commission</th>
                        <th>Basic Salary</th>
                        <th>Status (Pending)</th>
                        <th>Partial Payment</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    
    <!-- Partial Payment Modal -->
    <div id="partial-payment-modal" class="invoice-modal">
        <div class="invoice-modal-content" style="max-width: 500px;">
            <button class="close-modal" onclick="closePartialPaymentModal()">&times;</button>
            <div class="invoice-header">
                <h2>Partial Salary Payment</h2>
                <p id="partial-payment-employee-name">Employee Name</p>
            </div>
            
            <div class="invoice-form">
                <div class="inputbox">
                    <input type="number" id="partial-payment-amount" step="0.01" required="required">
                    <span>Payment Amount (AED )</span>
                    <i></i>
                </div>
                <div id="partial-payment-info" style="background: rgba(26, 29, 37, 0.8); padding: 15px; border-radius: 8px; margin: 15px 0; display: none;">
                    <p><strong>Total Salary:</strong> AED <span id="partial-total-salary">0.00</span></p>
                    <p><strong>Already Paid:</strong> AED <span id="partial-already-paid">0.00</span></p>
                    <p><strong>Remaining:</strong> AED <span id="partial-remaining">0.00</span></p>
                </div>
                
                <div class="form-row">
                    <button class="bubbles btn-success" onclick="processPartialPayment()">
                        <span class="text">Process Payment</span>
                    </button>
                    <button class="bubbles btn-secondary" onclick="closePartialPaymentModal()">
                        <span class="text">Cancel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Profit Section -->
<div id="admin-profit" class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Profit Management</h3>
        <div class="inputbox" style="width: 200px; margin-bottom: 0;">
            <input type="month" id="profit-month-filter" required="required">
            <span>Select Month</span>
            <i></i>
        </div>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="total-profit">AED 0</div>
            <div class="stat-label">Total Profit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="driver-side-profit">AED 0</div>
            <div class="stat-label">Driver Side Profit</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="passenger-side-profit">AED 0</div>
            <div class="stat-label">Passenger Side Profit</div>
        </div>
    </div>
    
    <div class="table-container">
        <table id="profit-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Invoice ID</th>
                    <th>Amount</th>
                    <th>Description</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

            <!-- Expenses Section -->
            <div id="admin-expenses" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3>Expense Management</h3>
                    <button class="bubbles" onclick="showAddExpenseModal()" style="width: auto; min-width: 150px;">
                        <span class="text">Add Expense</span>
                    </button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-expenses">AED 0</div>
                        <div class="stat-label">Total Expenses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="monthly-expenses">AED 0</div>
                        <div class="stat-label">This Month</div>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="expenses-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Expense Type</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Salaries Section (Placeholder) -->
            <div id="admin-salaries" class="section">
                <h3>Salary Management</h3>
                <div class="card">
                    <p style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        Salary management system will be implemented in the next update.
                    </p>
                </div>
            </div>
            <!-- Settings Section -->
            <div id="admin-settings" class="section">
                <h3>Admin Settings</h3>
                <div class="invoice-form">
                    <h4>Change Password</h4>
                    <div class="inputbox">
                        <input type="password" id="admin-new-password" required="required">
                        <span>New Password</span>
                        <i></i>
                    </div>
                    <button class="bubbles" onclick="changePassword('admin')">
                        <span class="text">Update Password</span>
                    </button>
                </div>
            </div>
        </div>


<!-- Passenger Dashboard -->
<div id="passenger-dashboard" class="dashboard">
    <div class="dashboard-header">
        <h2 class="dashboard-title">Passenger Dashboard</h2>
        <div class="user-info">
            <span id="passenger-welcome">Welcome to RIDENOVA</span>
            <button class="bubbles btn-small btn-secondary" onclick="logout()">
                <span class="text">Logout</span>
            </button>
        </div>
    </div>

    <!-- MOVED NAV MENU TO TOP -->
    <div class="nav-menu">
        <button class="nav-btn active" onclick="showPassengerSection('home')">Home</button>
        <button class="nav-btn" onclick="showPassengerSection('dashboard')">Dashboard</button>
        <button class="nav-btn" onclick="showPassengerSection('monthly-gross')">Monthly Gross</button>
        <button class="nav-btn" onclick="showPassengerSection('fare')">Calculate Fare</button>
        <button class="nav-btn" onclick="showPassengerSection('invoice')">Create Passenger Profile</button>
        <button class="nav-btn" onclick="showPassengerSection('profiles')">View Profiles</button>
        <button class="nav-btn" onclick="showPassengerSection('settings')">Settings</button>
    </div>
    <!-- Home Section -->
    <div id="passenger-home" class="section active">
        <h3>Quick Links</h3>
        <div class="social-links">
            <a href="https://wa.me/" target="_blank" class="social-link"> WhatsApp</a>
            <a href="https://facebook.com" target="_blank" class="social-link facebook"> Facebook</a>
            <a href="https://maps.google.com" target="_blank" class="social-link maps"> Google Maps</a>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="passenger-invoices-count">0</div>
                <div class="stat-label">Total Invoices</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="passenger-targets-count">0</div>
                <div class="stat-label">Active Targets</div>
            </div>
        </div>
    </div>
    <!-- Monthly Gross Section - UPDATED -->
    <div id="passenger-monthly-gross" class="section">
        <h3>Monthly Gross Performance</h3>
        
        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="monthly-target">AED 0</div>
                <div class="stat-label">Monthly Target</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="monthly-achieved">AED 0</div>
                <div class="stat-label">Achieved</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="profiles-created">0</div>
                <div class="stat-label">Profiles Created</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="profiles-booked">0</div>
                <div class="stat-label">Profiles Booked</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="profiles-picked">0</div>
                <div class="stat-label">Profiles Picked</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="achievement-rate">0%</div>
                <div class="stat-label">Achievement Rate</div>
            </div>
        </div>

        <!-- Monthly Progress Chart -->
        <div style="background: rgba(26, 29, 37, 0.8); padding: 20px; border-radius: 10px; margin-top: 20px;">
            <h4>Monthly Progress</h4>
            <div style="background: var(--border-color); height: 30px; border-radius: 15px; margin: 15px 0; overflow: hidden;">
                <div id="progress-bar" style="background: linear-gradient(90deg, var(--accent), #764ba2); height: 100%; width: 0%; border-radius: 15px; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: var(--bg-main); font-weight: bold; font-size: 0.9rem;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-secondary);">
                <span>Start: AED 0</span>
                <span id="progress-text">0% Complete</span>
                <span>Target: AED <span id="target-amount">0</span></span>
            </div>
        </div>
    </div>
    <!-- Passenger Dashboard Section -->
    <div id="passenger-dashboard-section" class="section">
        <h3>Dashboard - All Passenger Profiles</h3>
        
        <div class="table-container">
            <table id="passenger-dashboard-table">
                <thead>
                    <tr>
                        <th>Profile ID</th>
                        <th>Agent Name</th>
                        <th>Total Budget</th>
                        <th>Driver Agent</th>
                        <th>Pickup Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

            <!-- Home Section -->
            <div id="passenger-home" class="section active">
                <h3>Quick Links</h3>
                <div class="social-links">
                    <a href="https://wa.me/" target="_blank" class="social-link"> WhatsApp</a>
                    <a href="https://facebook.com" target="_blank" class="social-link facebook"> Facebook</a>
                    <a href="https://maps.google.com" target="_blank" class="social-link maps"> Google Maps</a>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="passenger-invoices-count">0</div>
                        <div class="stat-label">Total Invoices</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="passenger-targets-count">0</div>
                        <div class="stat-label">Active Targets</div>
                    </div>
                </div>
            </div>

            <!-- Fare Calculator Section -->
            <div id="passenger-fare" class="section">
                <h3>Fare Calculator</h3>
                
                <!-- Rate List Button -->
                <div style="margin-bottom: 20px;">
                    <button class="bubbles btn-small" onclick="showRateList()">
                        <span class="text">View Rate List</span>
                    </button>
                </div>

                <div class="invoice-form">
                    <div class="form-row">
                        <div class="choice-container" id="passenger-type-container">
                            <div class="choice-box" id="passenger-type-choice">
                                <span>Select Passenger Type</span>
                                <span></span>
                            </div>
                            <div class="choice-options">
                                <div class="choice-option" data-value="1">One-Time</div>
                                <div class="choice-option" data-value="2">Permanent</div>
                            </div>
                        </div>
                        <div class="choice-container" id="ride-way-container">
                            <div class="choice-box" id="ride-way-choice">
                                <span>Select Ride Type</span>
                                <span></span>
                            </div>
                            <div class="choice-options">
                                <div class="choice-option" data-value="1">One Way</div>
                                <div class="choice-option" data-value="2">Two Way</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="inputbox">
                            <input type="number" id="distance" required="required">
                            <span>Distance (km)</span>
                            <i></i>
                        </div>
                        <div class="inputbox">
                            <input type="number" id="days" placeholder="Enter days per month" min="1" max="31" required="required">
                            <span>Days per Month</span>
                            <i></i>
                        </div>
                    </div>
                    
                    <button class="bubbles" onclick="calculateFare()">
                        <span class="text">Calculate Fare</span>
                    </button>
                    
                    <div id="fare-result" style="margin-top: 15px; padding: 15px; background: rgba(26, 29, 37, 0.8); border-radius: 8px; display: none;"></div>
                    
                    <button id="nextBtn" class="bubbles btn-success" style="margin-top: 15px; display: none;" onclick="useCalculatedFare()">
                        <span class="text">Use This Fare</span>
                    </button>
                </div>
            </div>

            <!-- Rate List Modal -->
            <div id="rate-list-modal" class="invoice-modal">
                <div class="invoice-modal-content">
                    <button class="close-modal" onclick="closeRateList()">&times;</button>
                    <div class="invoice-header">
                        <h2>Fare Rate List</h2>
                        <p>Base fares for different distance ranges</p>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Distance Range (km)</th>
                                    <th>Base Fare (AED )</th>
                                </tr>
                            </thead>
                            <tbody id="rate-list-body">
                                <!-- Rate list will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: rgba(26, 29, 37, 0.8); border-radius: 8px;">
                        <h4>Calculation Formula:</h4>
                        <p><strong>Step 1:</strong> Fare per km = Base Fare / Max Distance</p>
                        <p><strong>Step 2:</strong> Multiply by actual distance</p>
                        <p><strong>Step 3:</strong> Divide by passenger type (5 for one-time, 20 for permanent)</p>
                        <p><strong>Step 4:</strong> Multiply by days per week</p>
                        <p><strong>Step 5:</strong> One Way = 60% of private fare</p>
                        <p><strong>Step 6:</strong> Shared always = 60% of private fare</p>
                        <p><strong>Step 7:</strong> Add 20% service charges</p>
                    </div>
                </div>
            </div>

            <!-- View Profiles Section -->
            <div id="passenger-profiles" class="section">
                <h3>All Passenger Profiles</h3>
                
                <!-- Filter Options for Profiles -->
                <div class="filter-options" style="margin-bottom: 20px;">
                    <label><strong>Filter by:</strong></label>
                    <button class="bubbles btn-small nav-btn active" onclick="filterPassengerProfiles('all')">
                        <span class="text">All Profiles</span>
                    </button>
                    <button class="bubbles btn-small nav-btn" onclick="filterPassengerProfiles('recent')">
                        <span class="text">Recent</span>
                    </button>
                    <button class="bubbles btn-small nav-btn" onclick="filterPassengerProfiles('active')">
                        <span class="text">Active</span>
                    </button>
                </div>
                
                <div class="table-container">
                    <table id="passenger-profiles-table">
                        <thead>
                            <tr>
                                <th>Profile ID</th>
                                <th>Passenger Name</th>
                                <th>Phone</th>
                                <th>Created Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Create Passenger Profile Section -->
            <div id="passenger-invoice" class="section">
                <h3>Create Passenger Profile</h3>
                <div class="invoice-form">
                    <div class="form-row">
                        <div class="inputbox">
                            <input type="text" id="passenger-name" required="required">
                            <span>Passenger Name</span>
                            <i></i>
                        </div>
                        <div class="inputbox">
                            <input type="tel" id="passenger-phone" required="required">
                            <span>Phone Number</span>
                            <i></i>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="inputbox">
                            <input type="time" id="pickup-time" required="required">
                            <span>Pickup Time</span>
                            <i></i>
                        </div>
                        <div class="inputbox">
                            <input type="time" id="dropoff-time" required="required">
                            <span>Dropoff Time</span>
                            <i></i>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="choice-container" id="days-per-week-container">
                            <div class="choice-box" id="days-per-week-choice">
                                <span>Select Days per Week</span>
                                <span></span>
                            </div>
                            <div class="choice-options">
                                <div class="choice-option" data-value="1">1 Day</div>
                                <div class="choice-option" data-value="2">2 Days</div>
                                <div class="choice-option" data-value="3">3 Days</div>
                                <div class="choice-option" data-value="4">4 Days</div>
                                <div class="choice-option" data-value="5">5 Days</div>
                                <div class="choice-option" data-value="6">6 Days</div>
                                <div class="choice-option" data-value="7">7 Days</div>
                            </div>
                        </div>
                        <div class="choice-container" id="ride-way-profile-container">
                            <div class="choice-box" id="ride-way-profile-choice">
                                <span>Select Ride Way</span>
                                <span></span>
                            </div>
                            <div class="choice-options">
                                <div class="choice-option" data-value="one-way">One Way</div>
                                <div class="choice-option" data-value="two-way">Two Way</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="choice-container" id="ride-type-container">
                            <div class="choice-box" id="ride-type-choice">
                                <span>Select Ride Type</span>
                                <span></span>
                            </div>
                            <div class="choice-options">
                                <div class="choice-option" data-value="shared">Shared</div>
                                <div class="choice-option" data-value="private">Private</div>
                            </div>
                        </div>
                        <div class="choice-container" id="passenger-gender-container">
                            <div class="choice-box" id="passenger-gender-choice">
                                <span>Select Gender</span>
                                <span></span>
                            </div>
                            <div class="choice-options">
                                <div class="choice-option" data-value="male">Male</div>
                                <div class="choice-option" data-value="female">Female</div>
                                <div class="choice-option" data-value="other">Other</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="inputbox">
                            <input type="number" id="total-budget" step="0.01" required="required">
                            <span>Total Budget (AED )</span>
                            <i></i>
                        </div>
                        <div class="inputbox">
                            <input type="number" id="service-charges" step="0.01" required="required">
                            <span>Service Charges (AED )</span>
                            <i></i>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="inputbox">
                            <input type="number" id="driver-charges" step="0.01" required="required">
                            <span>Driver Charges (AED )</span>
                            <i></i>
                        </div>
                        <input type="hidden" id="transport-amount" step="0.01" readonly>
                    </div>
                    
                    <div class="form-row">
                        <div class="choice-container" id="passenger-agent-container">
                            <div class="choice-box" id="passenger-agent-choice">
                                <span>Select Passenger Agent</span>
                                <span></span>
                            </div>
                            <div class="choice-options" id="passenger-agent-options"></div>
                        </div>
                        <div class="inputbox">
                            <input type="text" id="passenger-nationality" required="required">
                            <span>Nationality</span>
                            <i></i>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="inputbox">
                            <input type="url" id="pickup-location" required="required">
                            <span>Pickup Location Link</span>
                            <i></i>
                        </div>
                        <div class="inputbox">
                            <input type="url" id="dropoff-location" required="required">
                            <span>Dropoff Location Link</span>
                            <i></i>
                        </div>
                    </div>
                    
                    <div class="inputbox">
                        <input type="url" id="route-link" required="required">
                        <span>Whole Route Link</span>
                        <i></i>
                    </div>

                    <div class="inputbox">
                        <input type="text" id="profile-note" required="required">
                        <span>Detail Note (Day to Day / Specifics)</span>
                        <i></i>
                    </div>
                    
                    <div id="calculated-results" style="background: rgba(26, 29, 37, 0.8); padding: 15px; border-radius: 8px; margin: 15px 0; display: none;">
                        <h4>Calculated Results:</h4>
                        <p><strong>Daily Budget:</strong> AED <span id="daily-budget-result">0.00</span></p>
                    </div>
                    
                    <button class="bubbles" onclick="calculateAndCreateInvoice()">
                        <span class="text">Create Profile</span>
                    </button>
                </div>
            </div>

            <!-- Profile & Targets Section -->
            <div id="passenger-profile" class="section">
                <h3>Profile & Targets</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="profile-total-invoices">0</div>
                        <div class="stat-label">Total Invoices</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="profile-completed-targets">0</div>
                        <div class="stat-label">Completed Targets</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="profile-service-charges">AED 0</div>
                        <div class="stat-label">Service Charges Paid</div>
                    </div>
                </div>
                <div class="table-container">
                    <table id="passenger-targets-table">
                        <thead>
                            <tr>
                                <th>Target</th>
                                <th>Deadline</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="passenger-settings" class="section">
                <h3>Account Settings</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="settings-total-invoices">0</div>
                        <div class="stat-label">Total Invoices</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="settings-pending-payments">0</div>
                        <div class="stat-label">Pending Payments</div>
                    </div>
                </div>
                <div class="invoice-form">
                    <h4>Change Password</h4>
                    <div class="inputbox">
                        <input type="password" id="passenger-new-password" required="required">
                        <span>New Password</span>
                        <i></i>
                    </div>
                    <button class="bubbles" onclick="changePassword('passenger')">
                        <span class="text">Update Password</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="driver-dashboard" class="dashboard">
    <div class="dashboard-header">
        <h2 class="dashboard-title">Driver Dashboard</h2>
        <div class="user-info">
            <span id="driver-welcome">Welcome, Driver</span>
            <button class="bubbles btn-small btn-secondary" onclick="logout()">
                <span class="text">Logout</span>
            </button>
        </div>
    </div>

    <div class="nav-menu">
        <button class="nav-btn active" onclick="showDriverSection('home')">Home</button>
        <button class="nav-btn" onclick="showDriverSection('dashboard')">Dashboard</button>
        <button class="nav-btn" onclick="showDriverSection('monthly-gross')">Monthly Gross</button>
        <button class="nav-btn" onclick="showDriverSection('targets')">My Targets</button> <button class="nav-btn" onclick="showDriverSection('invoices')">Assigned profiles</button>
        <button class="nav-btn" onclick="showDriverSection('invoices')">Assigned profiles</button>
        <button class="nav-btn" onclick="showDriverSection('drivers')">Drivers Details</button>
        <button class="nav-btn" onclick="showDriverSection('earnings')">Earnings</button>
        <button class="nav-btn" onclick="showDriverSection('settings')">Settings</button>
    </div>
    <!-- Home Section -->
    <div id="driver-home" class="section active">
        <h3>Quick Links</h3>
        <div class="social-links">
            <a href="https://wa.me/" target="_blank" class="social-link"> WhatsApp</a>
            <a href="https://facebook.com" target="_blank" class="social-link facebook"> Facebook</a>
            <a href="https://maps.google.com" target="_blank" class="social-link maps"> Google Maps</a>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="driver-assigned-count">0</div>
                <div class="stat-label">Assigned Invoices</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="driver-completed-count">0</div>
                <div class="stat-label">Completed Jobs</div>
            </div>
        </div>
    </div>
  <!-- Driver Dashboard Section - EXACT COPY OF ADMIN DASHBOARD -->
<div id="driver-dashboard-section" class="section active">
    <h3>Dashboard - All Passenger Profiles</h3>
    
    <div class="table-container">
        <table id="driver-dashboard-table">
            <thead>
                <tr>
                    <th>Profile ID</th>
                    <th>Agent Name</th>
                    <th>Total Budget</th>
                    <th>Driver Agent</th>
                    <th>Pickup Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
<!-- Driver Monthly Gross Section -->
<div id="driver-monthly-gross" class="section">
    <h3>Monthly Gross Performance</h3>
    
    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value" id="driver-monthly-target">AED 0</div>
            <div class="stat-label">Monthly Target</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="driver-monthly-achievement">AED 0</div>
            <div class="stat-label">Achievement</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="driver-assigned-profiles">0</div>
            <div class="stat-label">Assigned Profiles</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="driver-booked-profiles">0</div>
            <div class="stat-label">Booked Profiles</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="driver-picked-profiles">0</div>
            <div class="stat-label">Picked Profiles</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="driver-achievement-rate">0%</div>
            <div class="stat-label">Achievement Rate</div>
        </div>
    </div>

    <!-- Monthly Progress Chart -->
    <div style="background: rgba(26, 29, 37, 0.8); padding: 20px; border-radius: 10px; margin-top: 20px;">
        <h4>Monthly Progress</h4>
        <div style="background: var(--border-color); height: 30px; border-radius: 15px; margin: 15px 0; overflow: hidden;">
            <div id="driver-progress-bar" style="background: linear-gradient(90deg, var(--accent), #764ba2); height: 100%; width: 0%; border-radius: 15px; transition: width 0.5s ease; display: flex; align-items: center; justify-content: center; color: var(--bg-main); font-weight: bold; font-size: 0.9rem;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--text-secondary);">
            <span>Start: AED 0</span>
            <span id="driver-progress-text">0% Complete</span>
            <span>Target: AED <span id="driver-target-amount">0</span></span>
        </div>
    </div>
</div>
    <!-- Home Section -->
    <div id="driver-home" class="section">
        <h3>Quick Links</h3>
        <div class="social-links">
            <a href="https://wa.me/" target="_blank" class="social-link"> WhatsApp</a>
            <a href="https://facebook.com" target="_blank" class="social-link facebook"> Facebook</a>
            <a href="https://maps.google.com" target="_blank" class="social-link maps"> Google Maps</a>
        </div>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="driver-assigned-count">0</div>
                <div class="stat-label">Assigned Invoices</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="driver-completed-count">0</div>
                <div class="stat-label">Completed Jobs</div>
            </div>
        </div>
    </div>

        <!-- Assigned Invoices Section -->
<div id="driver-invoices" class="section">
    <h3>My Assigned Jobs</h3>
    
    <!-- Filter Options for Driver -->
    <div class="filter-options" style="margin-bottom: 20px;">
        <label><strong>Filter by:</strong></label>
        <button class="bubbles btn-small nav-btn active" onclick="filterDriverInvoices('all')">
            <span class="text">All Assigned</span>
        </button>
        <button class="bubbles btn-small nav-btn" onclick="filterDriverInvoices('unpaid')">
            <span class="text">Not Paid</span>
        </button>
        <button class="bubbles btn-small nav-btn" onclick="filterDriverInvoices('paid')">
            <span class="text">Completed</span>
        </button>
    </div>
    
    <div class="table-container">
        <table id="driver-invoices-table">
            <thead>
                <tr>
                    <th>Invoice ID</th>
                    <th>Passenger Name</th>
                    <th>Amount</th>
                    <th>Description</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>
                        <!-- Drivers Details Section -->
            <div id="driver-drivers" class="section">
                <h3>Drivers Details</h3>
                
                <!-- Search and Add Driver Section -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; gap: 15px;">
                    <!-- Search Bar -->
                    <div class="inputbox" style="flex: 1; margin-bottom: 0;">
                        <input type="text" id="driver-search" placeholder=" " onkeyup="searchDrivers()">
                        
                        <i></i>
                    </div>
                    
                    <!-- Add Driver Button -->
                    <button class="bubbles" onclick="showAddDriverModal()" style="width: auto; min-width: 150px;">
                        <span class="text">Add Drivers</span>
                    </button>
                </div>

                <!-- Drivers List Table -->
                <div class="table-container">
                    <table id="drivers-table">
                        <thead>
                            <tr>
                                <th>Driver Name</th>
                                <th>Phone Number</th>
                                <th>From Location</th>
                                <th>To Location</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Add Driver Modal -->
            <div id="add-driver-modal" class="invoice-modal">
                <div class="invoice-modal-content">
                    <button class="close-modal" onclick="closeAddDriverModal()">&times;</button>
                    <div class="invoice-header">
                        <h2>Add New Driver</h2>
                        <p>Enter driver details</p>
                    </div>
                    
                    <div class="invoice-form">
                        <div class="form-row">
                            <div class="inputbox">
                                <input type="text" id="new-driver-name" required="required">
                                <span>Name of Driver</span>
                                <i></i>
                            </div>
                            <div class="inputbox">
                                <input type="tel" id="new-driver-phone" required="required">
                                <span>Phone Number</span>
                                <i></i>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="inputbox">
                                <input type="text" id="new-driver-from" required="required">
                                <span>From Location</span>
                                <i></i>
                            </div>
                            <div class="inputbox">
                                <input type="text" id="new-driver-to" required="required">
                                <span>To Location</span>
                                <i></i>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <button class="bubbles btn-success" onclick="addNewDriver()">
                                <span class="text">Save Driver</span>
                            </button>
                            <button class="bubbles btn-secondary" onclick="closeAddDriverModal()">
                                <span class="text">Cancel</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Earnings Section -->
            <div id="driver-earnings" class="section">
                <h3>My Earnings</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="driver-daily-earnings">AED 0</div>
                        <div class="stat-label">Today's Earnings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="driver-weekly-earnings">AED 0</div>
                        <div class="stat-label">This Week</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="driver-monthly-earnings">AED 0</div>
                        <div class="stat-label">This Month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="driver-total-earnings">AED 0</div>
                        <div class="stat-label">Total Earnings</div>
                    </div>
                </div>
            </div>
            <div id="driver-targets" class="section">
                <h3>My Assigned Targets</h3>
                <div class="table-container">
                    <table id="driver-targets-table">
                        <thead>
                            <tr>
                                <th>Target Amount</th>
                                <th>Deadline</th>
                                <th>Assigned Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <!-- Settings Section -->
            <div id="driver-settings" class="section">
                <h3>Account Settings</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="driver-total-jobs">0</div>
                        <div class="stat-label">Total Jobs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="driver-success-rate">0%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>
                <div class="invoice-form">
                    <h4>Change Password</h4>
                    <div class="inputbox">
                        <input type="password" id="driver-new-password" required="required">
                        <span>New Password</span>
                        <i></i>
                    </div>
                    <button class="bubbles" onclick="changePassword('driver')">
                        <span class="text">Update Password</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <!-- Invoice Detail Modal -->
    <div id="invoice-modal" class="invoice-modal">
        <div class="invoice-modal-content">
            <button class="close-modal" onclick="closeInvoiceModal()">&times;</button>
            <div class="invoice-header">
                <h2>Invoice Details</h2>
                <p id="invoice-modal-id">Invoice #</p>
            </div>
            
            <div class="invoice-details">
                <div class="invoice-section">
                    <h4>Passenger Information</h4>
                    <p><strong>Name:</strong> <span id="modal-passenger-name"></span></p>
                    <p><strong>Phone:</strong> <span id="modal-passenger-phone"></span></p>
                    <p><strong>Gender:</strong> <span id="modal-passenger-gender"></span></p>
                    <p><strong>Nationality:</strong> <span id="modal-passenger-nationality"></span></p>
                    <p><strong>Agent:</strong> <span id="modal-passenger-agent"></span></p>
                </div>
                
                <div class="invoice-section">
                    <h4>Ride Details</h4>
                    <p><strong>Pickup Time:</strong> <span id="modal-pickup-time"></span></p>
                    <p><strong>Dropoff Time:</strong> <span id="modal-dropoff-time"></span></p>
                    <p><strong>Days per Week:</strong> <span id="modal-days-week"></span></p>
                    <p><strong>Total Monthly Days:</strong> <span id="modal-monthly-days"></span></p> 
                    <p><strong>Ride Way:</strong> <span id="modal-ride-way"></span></p>
                    <p><strong>Ride Type:</strong> <span id="modal-ride-type"></span></p>
                </div>
                
                <div class="invoice-section">
                    <h4>Financial Details</h4>
                    <p><strong>Total Budget:</strong> AED <span id="modal-total-budget"></span></p>
                    <p><strong>Service Charges:</strong> AED <span id="modal-service-charges"></span></p>
                    <p><strong>Driver Charges:</strong> AED <span id="modal-driver-charges"></span></p>
                    <p><strong>Daily Budget:</strong> AED <span id="modal-daily-budget"></span></p>
                    <p><strong>Status:</strong> <span id="modal-status"></span></p>
                </div>
            
                <div class="invoice-section" style="grid-column: span 1;">
                    <h4>Detail Note</h4>
                    <p id="modal-note-content" style="color: var(--accent); font-style: italic; white-space: pre-wrap;"></p>
                </div>
                
                <div class="invoice-section">
                    <h4>Location Details</h4>
                    <p><strong>Pickup:</strong> <a href="#" id="modal-pickup-link" target="_blank" class="social-link maps btn-small">View Map</a></p>
                    <p><strong>Dropoff:</strong> <a href="#" id="modal-dropoff-link" target="_blank" class="social-link maps btn-small">View Map</a></p>
                    <p><strong>Route:</strong> <a href="#" id="modal-route-link" target="_blank" class="social-link maps btn-small">View Route</a></p>
                </div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
            <button class="bubbles btn-success" id="download-passenger-pdf-btn" style="width: auto;">
                <span class="text"> Passenger PDF</span>
            </button>
            <button class="bubbles" id="download-driver-pdf-btn" style="width: auto; --c2: #3498db;">
                <span class="text"> Driver PDF</span>
            </button>
            <button class="bubbles" id="copy-details-btn" style="width: auto; --c2: #9b59b6;">
                <span class="text"> Copy All Details</span>
            </button>
        </div>       
    </div>
<!-- Add EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="module">
    // 1. Import Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    // 2. YOUR UPDATED CONFIGURATION
    const firebaseConfig = {
        apiKey: "AIzaSyBhOkjszbaWjdfdhMF9vegemTsPNV1nwK4",
        authDomain: "ridenova-badb8.firebaseapp.com",
        projectId: "ridenova-badb8",
        storageBucket: "ridenova-badb8.firebasestorage.app",
        messagingSenderId: "589130055534",
        appId: "1:589130055534:web:bc20e8cb988338e303cb7f"
    };
    
    // 3. Initialize
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
      // 4. Make Database Tools Available to Your Code
      window.db = db;
      window.doc = doc;
      window.setDoc = setDoc;
      window.updateDoc = updateDoc;
      window.deleteDoc = deleteDoc;
      window.collection = collection;
    
      // 5. LISTENERS (Keep your website updated automatically)
    
      // A. Load Users & Targets
// A. Load Users & Targets
      onSnapshot(collection(db, "users"), (snapshot) => {
          window.users = [];
          snapshot.forEach((doc) => window.users.push(doc.data()));
          
          // Refresh current user data if logged in
          // Use window.currentUser to ensure global access
          if (window.currentUser || currentUser) {
              // Handle both variable cases
              const currentId = window.currentUser ? window.currentUser.id : currentUser.id;
              const updatedUser = window.users.find(u => u.id === currentId);
              
              if (updatedUser) {
                  // Update the global variables
                  currentUser = updatedUser;
                  window.currentUser = updatedUser;
                  
                  // CHECK FOR NOTIFICATIONS IMMEDIATELY
                  if (typeof window.checkLoginNotifications === "function") {
                      window.checkLoginNotifications();
                  }
                  
                  // Refresh Dashboard Stats Live
                  if (typeof updateDriverStats === "function") updateDriverStats();
                  if (typeof updatePassengerStats === "function") updatePassengerStats();
              }
          }
          
          if (typeof renderEmployeesTable === "function") renderEmployeesTable();
          if (typeof renderSalarySection === "function") renderSalarySection();
          if (typeof renderAdminTargetsTable === "function") renderAdminTargetsTable();
          if (typeof populatePassengerAgentDropdown === "function") populatePassengerAgentDropdown();
          
          // Force table refresh
          if (typeof refreshAllTables === "function") refreshAllTables();
      });
    
      // B. Load Drivers Details List
      onSnapshot(collection(db, "drivers_list"), (snapshot) => {
          window.driversList = [];
          snapshot.forEach((doc) => window.driversList.push(doc.data()));
          if (typeof renderDriversTable === "function") renderDriversTable();
      });
    
      // C. Load Expenses
      onSnapshot(collection(db, "expenses"), (snapshot) => {
          window.expenses = [];
          snapshot.forEach((doc) => window.expenses.push(doc.data()));
          if (typeof renderExpensesSection === "function") renderExpensesSection();
          if (typeof renderFinanceOverview === "function") renderFinanceOverview();
      });
    
      // D. Load Invoices & Auto-Calculate Finance
      onSnapshot(collection(db, "invoices"), (snapshot) => {
          window.invoices = [];
          window.finance = { totalPaid: 0, transactions: [] }; // Reset Finance
    
          snapshot.forEach((doc) => {
              const inv = doc.data();
              window.invoices.push(inv);
    
              // Auto-build Finance Transactions based on saved Invoice status
              if (inv.paymentStatus === 'paid') {
                  window.finance.transactions.push({
                      invoiceId: inv.id,
                      amount: (inv.driverCharges || 0),
                      date: inv.date, time: inv.time,
                      driverId: inv.driverId,
                      type: 'driver_payment'
                  });
                  window.finance.totalPaid += (inv.driverCharges || 0);
              }
              if (inv.serviceChargesPaid) {
                  window.finance.transactions.push({
                      invoiceId: inv.id,
                      amount: inv.serviceCharges,
                      date: inv.date, time: inv.time,
                      type: 'service_charges'
                  });
                  window.finance.totalPaid += inv.serviceCharges;
              }
          });
    
          // Refresh Tables
          if (typeof refreshAllTables === "function") refreshAllTables();
          if (typeof renderFinanceSection === "function") renderFinanceSection();
      });
    </script>
    <script>
        // EmailJS Configuration
        const EMAILJS_CONFIG = {
            SERVICE_ID: 'service_2zu34x7',
            TEMPLATE_ID: 'template_5zalydf', // For Signups
            PUBLIC_KEY: 'B9JAA9omLIKaQDpM7',
            ADMIN_EMAIL: 'ridenovacarlift.rnc@gmail.com'
        };
        
        (function() {
            emailjs.init(EMAILJS_CONFIG.PUBLIC_KEY);
            console.log('EmailJS initialized for RIDENOVA');
        })();
        let currentEmployeeRoleFilter = 'all'; // Add this at the top of your script with other global variables
        function sendSignupNotification(userData) {
            return new Promise((resolve, reject) => {
                const templateParams = {
                    to_email: EMAILJS_CONFIG.ADMIN_EMAIL, // Now correctly targets rnc@gmail.com
                    from_name: 'RIDENOVA CARLIFT System',
                    fullname: userData.fullname,
                    email: userData.email,
                    phone: userData.phone,
                    role: userData.role,
                    date: userData.registrationDate,
                    time: userData.registrationTime,
                    userid: userData.id
                };
        
                emailjs.send(
                    EMAILJS_CONFIG.SERVICE_ID,
                    EMAILJS_CONFIG.TEMPLATE_ID, // template_5zalydf
                    templateParams
                )
                .then((response) => {
                    console.log('Signup email sent:', response);
                    resolve(response);
                }, (error) => {
                    console.error('Signup email failed:', error);
                    resolve(); 
                });
            });
        }
        // Loader Functions
        function showLoader() {
            const loader = document.getElementById('loader-overlay');
            loader.classList.remove('hidden');
        }
// Add this function to calculate basic salary
function getBasicSalary(role) {
    const baseSalaries = {
        'driver': 16000,
        'passenger': 12000,
        'admin': 20000
    };
    return baseSalaries[role] || 10000;
}
// Add this function with your other utility functions
function getBasicSalary(role) {
    const baseSalaries = {
        'driver': 16000,
        'passenger': 16000,
      
    };
    return baseSalaries[role] || 10000;
}
// Forgot Password Functions
function showForgotPasswordModal() {
    document.getElementById('forgot-password-email').value = '';
    document.getElementById('forgot-password-message').style.display = 'none';
    document.getElementById('forgot-password-modal').style.display = 'block';
}

function closeForgotPasswordModal() {
    document.getElementById('forgot-password-modal').style.display = 'none';
}
// --- SPLIT PROFILE LOGIC START ---

let pendingSplitProfileId = null;

// 1. Update showAdminSection to include 'split'
// Note: You must manually update your existing showAdminSection function switch case
/* Example update inside showAdminSection:
   case 'split':
       renderAdminSplitTable();
       break;
*/

// 2. Render the Main Split Section Table (Shows already split profiles)
function renderAdminSplitTable() {
    const tbody = document.querySelector('#admin-split-table tbody');
    tbody.innerHTML = '';

    // Filter invoices that have been split
    const splitInvoices = invoices.filter(inv => inv.isSplit === true);

    if (splitInvoices.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px;">No split profiles found.</td></tr>`;
        return;
    }

    splitInvoices.forEach(inv => {
        const creator = users.find(u => u.id === inv.passengerId);
        const splitAgent = users.find(u => u.id === inv.splitWithId);

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${inv.id}</td>
            <td>${inv.passengerName}</td>
            <td>${creator ? creator.username : 'Unknown'}</td>
            <td style="color: var(--status-paid); font-weight:bold;">${splitAgent ? splitAgent.username : 'Unknown'}</td>
            <td>AED ${inv.totalBudget}</td>
            <td>
                <button class="bubbles btn-small btn-danger" onclick="removeSplit('${inv.id}')">
                    <span class="text">Un-Split</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}
window.generatePDFInvoice = function(invoiceId, type = 'passenger') {
    const { jsPDF } = window.jspdf;
    const inv = window.invoices.find(i => i.id === invoiceId);
    if (!inv) return;

    const doc = new jsPDF();
    const gold = [212, 175, 55]; 
    const black = [0, 0, 0];

    // --- Header Banner ---
    doc.setFillColor(10, 12, 16);
    doc.rect(0, 0, 210, 45, 'F');
    doc.setFontSize(28);
    doc.setTextColor(212, 175, 55);
    doc.setFont("helvetica", "bold");
    doc.text("RIDENOVA CARLIFT", 105, 25, { align: "center" });
    doc.setFontSize(10);
    doc.setTextColor(255, 255, 255);
    doc.text("PREMIUM TRANSPORTATION SERVICES", 105, 35, { align: "center" });

    // --- Invoice Type Ribbon ---
    doc.setFillColor(212, 175, 55);
    doc.rect(0, 45, 210, 10, 'F');
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(12);
    doc.text(`${type.toUpperCase()} INVOICE: ${inv.id}`, 105, 52, { align: "center" });

    let currentY = 70;
    let finalGrandTotal = 0;

    if (type === 'passenger') {
        // Passenger Logic: Monthly Budget (1300) + Service Charges (260) = 1560
        const baseTransport = parseFloat(inv.totalBudget) || 0;
        const sCharges = parseFloat(inv.serviceCharges) || 0;
        finalGrandTotal = baseTransport + sCharges;

        doc.setTextColor(0, 0, 0);
        doc.text("PASSENGER DETAILS", 15, currentY);
        doc.line(15, currentY + 2, 80, currentY + 2);
        doc.setFontSize(10);
        currentY += 10;
        doc.text(`Name: ${inv.passengerName}`, 15, currentY);
        doc.text(`Date: ${inv.date}`, 140, currentY);

        const tableRows = [
            ["Description", "Amount (AED)"],
            ["Monthly Transportation Charges", `${baseTransport.toFixed(2)} AED`],
            ["Service & Management Charges", `${sCharges.toFixed(2)} AED`]
        ];

        doc.autoTable({
            startY: currentY + 20,
            head: [tableRows[0]],
            body: tableRows.slice(1),
            theme: 'grid',
            headStyles: { fillColor: gold, textColor: [0,0,0] }
        });
    } else {
        // Driver Logic: Monthly Budget (1300) + Driver Charges (130) = 1430
        const baseTransport = parseFloat(inv.totalBudget) || 0;
        const dCharges = parseFloat(inv.driverCharges) || 0;
        finalGrandTotal = baseTransport + dCharges;

        doc.setTextColor(0, 0, 0);
        doc.text("DRIVER PAYMENT SUMMARY", 15, currentY);
        doc.line(15, currentY + 2, 80, currentY + 2);
        doc.setFontSize(10);
        currentY += 10;
        doc.text(`Passenger: ${inv.passengerName}`, 15, currentY);
        doc.text(`Billing Date: ${inv.date}`, 140, currentY);

        const tableRows = [
            ["Account Description", "Balance (AED)"],
            ["Driver Contract Amount", `${baseTransport.toFixed(2)} AED`],
            ["Driver Side Service Surcharge", `${dCharges.toFixed(2)} AED`]
        ];

        doc.autoTable({
            startY: currentY + 20,
            head: [tableRows[0]],
            body: tableRows.slice(1),
            theme: 'striped',
            headStyles: { fillColor: [40, 40, 40], textColor: [255,255,255] }
        });
    }

    // --- Final Total (Corrected Summation) ---
    const finalY = doc.lastAutoTable.finalY + 15;
    doc.setFillColor(240, 240, 240);
    doc.rect(130, finalY - 8, 65, 12, 'F');
    doc.setFont("helvetica", "bold");
    doc.setTextColor(0, 0, 0);
    doc.text("TOTAL AMOUNT:", 135, finalY);
    // Display the sum of Budget + Charges
    doc.text(`${finalGrandTotal.toFixed(2)} AED`, 190, finalY, { align: "right" });

    doc.save(`Ridenova_${type}_${inv.id}.pdf`);
};
window.copyInvoiceDetails = function(invoiceId) {
            const inv = window.invoices.find(i => i.id === invoiceId);
            if (!inv) return;
        
            // Formatting the text exactly as requested: "Key : Value" per row
            const detailsText = `
        RIDENOVA CARLIFT DETAILS
        ------------------------
        Invoice ID : ${inv.id}
        Passenger Name : ${inv.passengerName}
        Phone Number : ${inv.passengerPhone}
        Gender : ${inv.passengerGender || 'N/A'}
        Nationality : ${inv.passengerNationality || 'N/A'}
        Agent : ${inv.passengerAgent || 'N/A'}
        
        RIDE DETAILS
        Pickup Time : ${inv.pickupTime}
        Dropoff Time : ${inv.dropoffTime}
        Days per Week : ${inv.daysPerWeek}
        Ride Way : ${inv.rideWay === 'one-way' ? 'One Way' : 'Two Way'}
        Ride Type : ${inv.rideType}
        Note : ${inv.note || 'None'}
        
        FINANCIALS
        Total Budget : AED ${inv.totalBudget}
        Daily Budget : AED ${inv.dailyBudget ? inv.dailyBudget.toFixed(2) : '0.00'}
        
        LOCATIONS
        Pickup Link : ${inv.pickupLocation}
        Dropoff Link : ${inv.dropoffLocation}
        Route Link : ${inv.routeLink}
            `.trim();
        
            // Copy to Clipboard
            navigator.clipboard.writeText(detailsText).then(() => {
                showNotification('Details copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                showNotification('Failed to copy details', 'error');
            });
};
// Update the View function to link the new buttons
const originalViewInvoiceDetails = window.viewInvoiceDetails;
window.viewInvoiceDetails = function(invoiceId) {
    const invoice = window.invoices.find(inv => inv.id === invoiceId);
    if (!invoice) {
        showNotification('Invoice not found', 'error');
        return;
    }

    // 1. Set Passenger Info
    document.getElementById('invoice-modal-id').textContent = `Invoice #${invoice.id}`;
    document.getElementById('modal-passenger-name').textContent = invoice.passengerName || 'N/A';
    document.getElementById('modal-passenger-phone').textContent = invoice.passengerPhone || 'N/A';
    document.getElementById('modal-passenger-gender').textContent = invoice.passengerGender || 'N/A';
    document.getElementById('modal-passenger-nationality').textContent = invoice.passengerNationality || 'N/A';
    document.getElementById('modal-passenger-agent').textContent = invoice.passengerAgent || 'N/A';

    // 2. Set Ride Details & Calculate Days
    document.getElementById('modal-pickup-time').textContent = invoice.pickupTime || 'N/A';
    document.getElementById('modal-dropoff-time').textContent = invoice.dropoffTime || 'N/A';
    
    const daysPerWeek = parseInt(invoice.daysPerWeek) || 0;
    document.getElementById('modal-days-week').textContent = daysPerWeek + " Days";
    // Automatic Monthly Days calculation (Days per week * 4)
    document.getElementById('modal-monthly-days').textContent = (daysPerWeek * 4) + " Days";
    
    document.getElementById('modal-ride-way').textContent = (invoice.rideWay === 'one-way' ? 'One Way' : 'Two Way');
    document.getElementById('modal-ride-type').textContent = invoice.rideType ? invoice.rideType.toUpperCase() : 'N/A';

    // 3. Set Note
    document.getElementById('modal-note-content').textContent = invoice.note || 'No special notes provided.';

    // 4. Set Financials
    document.getElementById('modal-total-budget').textContent = (invoice.totalBudget || 0).toFixed(2);
    document.getElementById('modal-service-charges').textContent = (invoice.serviceCharges || 0).toFixed(2);
    document.getElementById('modal-driver-charges').textContent = (invoice.driverCharges || 0).toFixed(2);
    document.getElementById('modal-daily-budget').textContent = (invoice.dailyBudget || 0).toFixed(2);
    document.getElementById('modal-status').textContent = (invoice.status || 'unpaid').toUpperCase();

    // 5. Set Links
    document.getElementById('modal-pickup-link').href = invoice.pickupLocation || '#';
    document.getElementById('modal-dropoff-link').href = invoice.dropoffLocation || '#';
    document.getElementById('modal-route-link').href = invoice.routeLink || '#';

    // Show Modal
    document.getElementById('invoice-modal').style.display = 'block';

    // Set Button Actions
    document.getElementById('download-passenger-pdf-btn').onclick = () => window.generatePDFInvoice(invoiceId, 'passenger');
    document.getElementById('download-driver-pdf-btn').onclick = () => window.generatePDFInvoice(invoiceId, 'driver');
    document.getElementById('copy-details-btn').onclick = () => window.copyInvoiceDetails(invoiceId);
};
// 3. Step 1: Open Modal to Select Profile
function openSplitProfileSelector() {
    document.getElementById('split-select-profile-modal').style.display = 'block';
    renderSplitProfileSelectionTable();
}

function renderSplitProfileSelectionTable() {
    const searchTerm = document.getElementById('split-search-profile').value.toLowerCase();
    const tbody = document.querySelector('#split-selection-table tbody');
    tbody.innerHTML = '';

    // Filter: Not already split, and matches search
    const candidates = invoices.filter(inv => 
        !inv.isSplit && 
        (inv.passengerName.toLowerCase().includes(searchTerm) || inv.id.toLowerCase().includes(searchTerm))
    );

    candidates.forEach(inv => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${inv.id}</td>
            <td>${inv.passengerName}</td>
            <td>${inv.passengerAgent}</td>
            <td>AED ${inv.totalBudget}</td>
            <td>
                <button class="bubbles btn-small" onclick="selectProfileForSplit('${inv.id}')">
                    <span class="text">Select</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// 4. Step 2: Store Profile ID and Open Employee Selector
function selectProfileForSplit(invoiceId) {
    pendingSplitProfileId = invoiceId;
    document.getElementById('split-select-profile-modal').style.display = 'none';
    document.getElementById('split-select-employee-modal').style.display = 'block';
    renderSplitEmployeeSelectionTable();
}

function renderSplitEmployeeSelectionTable() {
    const searchTerm = document.getElementById('split-search-employee').value.toLowerCase();
    const tbody = document.querySelector('#split-employee-table tbody');
    tbody.innerHTML = '';

    // Get current invoice to avoid selecting the creator
    const invoice = invoices.find(inv => inv.id === pendingSplitProfileId);
    
    // Filter: Exclude Admin, Exclude Creator
    const candidates = users.filter(u => 
        u.role !== 'admin' && 
        u.id !== invoice.passengerId &&
        (u.username.toLowerCase().includes(searchTerm))
    );

    candidates.forEach(emp => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${emp.username}</td>
            <td>${emp.role.toUpperCase()}</td>
            <td>
                <button class="bubbles btn-small btn-success" onclick="confirmSplit('${emp.id}', '${emp.username}')">
                    <span class="text">Assign Split</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// 5. Finalize Split Logic
function confirmSplit(employeeId, employeeName) {
    if(!pendingSplitProfileId) return;

    if(confirm(`Are you sure you want to split profile ${pendingSplitProfileId} with ${employeeName}?`)) {
        
        // Update Firebase
        if (window.updateDoc && window.db) {
            window.updateDoc(window.doc(window.db, "invoices", pendingSplitProfileId), {
                isSplit: true,
                splitWithId: employeeId,
                splitWithAgent: employeeName,
                splitDate: new Date().toISOString().split('T')[0]
            });
            
            showNotification('Profile split successfully!', 'success');
            closeSplitModals();
            renderAdminSplitTable(); // Refresh the split table
        }
    }
}

// 6. Remove Split (Revert)
function removeSplit(invoiceId) {
    if(confirm('Remove the split from this profile? Returns to original owner only.')) {
        if (window.updateDoc && window.db) {
            window.updateDoc(window.doc(window.db, "invoices", invoiceId), {
                isSplit: false,
                splitWithId: null,
                splitWithAgent: null,
                splitDate: null
            });
            showNotification('Split removed', 'info');
            renderAdminSplitTable();
        }
    }
}

function closeSplitModals() {
    document.getElementById('split-select-profile-modal').style.display = 'none';
    document.getElementById('split-select-employee-modal').style.display = 'none';
    pendingSplitProfileId = null;
}
// --- SPLIT PROFILE LOGIC END ---
window.renderAttendanceSection = function() {
    const tbody = document.querySelector('#attendance-table tbody');
    tbody.innerHTML = '';
    
    const selectedDate = document.getElementById('attendance-date-filter').value;
    if (!selectedDate) return;

    // Filter employees (exclude admin)
    const employees = window.users.filter(u => u.role !== 'admin');

    if (employees.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; padding: 20px;">No employees found</td></tr>`;
        return;
    }

    employees.forEach(user => {
        // Calculate hours for the specific selected date
        const hours = calculateDailyHours(user, selectedDate);
        const isDone = hours >= 4;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${user.fullname || user.username}</td>
            <td>${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</td>
            <td>${hours.toFixed(2)} Hrs</td>
            <td>
                <span class="status-badge ${isDone ? 'status-paid' : 'status-unpaid'}">
                    ${isDone ? 'Done' : 'Not Done Yet'}
                </span>
            </td>
            <td>
                <button class="bubbles btn-small" onclick="viewAttendanceDetails('${user.id}')">
                    <span class="text">View Monthly</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}
function calculateDailyHours(user, dateString) {
    if (!user.loginTimes || !user.logoutTimes) return 0;
    
    let totalMs = 0;
    // Iterate through logins
    for (let i = 0; i < Math.min(user.loginTimes.length, user.logoutTimes.length); i++) {
        const loginDate = user.loginTimes[i];
        const logoutDate = user.logoutTimes[i];
        
        // Check if this login happened on the selected date (using local date string comparison)
        if (loginDate.startsWith(dateString)) {
            const start = new Date(loginDate);
            const end = new Date(logoutDate);
            totalMs += (end - start);
        }
    }
    return totalMs / (1000 * 60 * 60); // Convert ms to hours
}

window.currentAttendanceUserId = null;

window.viewAttendanceDetails = function(userId) {
    window.currentAttendanceUserId = userId;
    const user = window.users.find(u => u.id === userId);
    if(!user) return;

    document.getElementById('attendance-modal-name').textContent = user.fullname || user.username;
    
    // Default to current month for the modal view
    const today = new Date().toISOString().substr(0, 7);
    document.getElementById('attendance-modal-month').value = today;
    
    updateAttendanceModal();
    document.getElementById('attendance-modal').style.display = 'block';
}

window.updateAttendanceModal = function() {
    if(!window.currentAttendanceUserId) return;
    
    const userId = window.currentAttendanceUserId;
    const user = window.users.find(u => u.id === userId);
    const selectedMonth = document.getElementById('attendance-modal-month').value; // YYYY-MM
    
    if(!selectedMonth) return;

    const [year, month] = selectedMonth.split('-');
    const daysInMonth = new Date(year, month, 0).getDate();
    
    let daysWorked = 0;

    // Loop through every day of the selected month
    for(let d = 1; d <= daysInMonth; d++) {
        // Format day as YYYY-MM-DD (pad with 0 if needed)
        const dayString = `${selectedMonth}-${d.toString().padStart(2, '0')}`;
        
        // Calculate hours for that specific day
        const hours = calculateDailyHours(user, dayString);
        
        if (hours >= 4) {
            daysWorked++;
        }
    }

    // Update UI
    document.getElementById('att-days-worked').textContent = daysWorked;
    document.getElementById('att-days-total').textContent = daysInMonth;
    
    const rate = (daysWorked / daysInMonth) * 100;
    document.getElementById('att-rate-text').textContent = `${daysWorked} out of ${daysInMonth}`;
    document.getElementById('att-progress-bar').style.width = `${rate}%`;
}

window.closeAttendanceModal = function() {
    document.getElementById('attendance-modal').style.display = 'none';
    window.currentAttendanceUserId = null;
}
function generateRandomPassword(length = 12) {
    const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#AED %^&*";
    let password = "";
    for (let i = 0; i < length; i++) {
        const randomIndex = Math.floor(Math.random() * charset.length);
        password += charset[randomIndex];
    }
    return password;
}

function sendPasswordReset() {
    const email = document.getElementById('forgot-password-email').value.trim();
    const messageDiv = document.getElementById('forgot-password-message');
    
    if (!email) {
        messageDiv.textContent = "Please enter your email address";
        messageDiv.style.backgroundColor = "rgba(220, 53, 69, 0.1)";
        messageDiv.style.color = "#dc3545";
        messageDiv.style.display = "block";
        return;
    }
    
    // Find user by email
    const user = window.users.find(u => u.email === email);
    
    if (!user) {
        messageDiv.textContent = "No account found with this email address";
        messageDiv.style.backgroundColor = "rgba(220, 53, 69, 0.1)";
        messageDiv.style.color = "#dc3545";
        messageDiv.style.display = "block";
        return;
    }
    
    showLoader();
    
    // Generate new random password
    const newPassword = generateRandomPassword();
    
    // Local Update for the user object
    user.password = newPassword;
    
    // Prepare email template parameters
    const templateParams = {
        to_email: email, // This MUST match the "To Email" field in your template settings
        from_name: 'RIDENOVA CARLIFT System',
        subject: 'Password Reset Request',
        username: user.username,
        new_password: newPassword, // This MUST match the {{new_password}} tag in your email body
        date: getCurrentDateTime().date,
        time: getCurrentDateTime().time,
        userid: user.id,
        fullname: user.fullname || user.username
    };
    
    // Send email using EmailJS
    emailjs.send(
        EMAILJS_CONFIG.SERVICE_ID, // service_2zu34x7
        'template_lg1yuua',        // CORRECTED: Your new Reset Template ID
        templateParams
    )
    .then(function(response) {
        hideLoader();
        messageDiv.textContent = "New password has been sent to your email address.";
        messageDiv.style.backgroundColor = "rgba(40, 167, 69, 0.1)";
        messageDiv.style.color = "#28a745";
        messageDiv.style.display = "block";
        
        // Clear the email field
        document.getElementById('forgot-password-email').value = '';
        
        // If you are using Firebase, update the password in the database
        if (window.updateDoc && window.db) {
            window.updateDoc(window.doc(window.db, "users", user.id), { password: newPassword });
        }
        
        setTimeout(() => {
            closeForgotPasswordModal();
        }, 5000);
    }, function(error) {
        hideLoader();
        console.error('EmailJS Error:', error);
        messageDiv.textContent = "Error: " + (error.text || "Check EmailJS template settings");
        messageDiv.style.backgroundColor = "rgba(220, 53, 69, 0.1)";
        messageDiv.style.color = "#dc3545";
        messageDiv.style.display = "block";
    });
}

function updateSalaryStatus(employeeId, newStatus) {
    const employee = users.find(u => u.id === employeeId);
    if (!employee) return;

    // 1. Update User Status in Database
    if (window.updateDoc && window.db) {
        window.updateDoc(window.doc(window.db, "users", employeeId), { salaryStatus: newStatus });
    }

    // 2. If Paid, Create Expense in Database
    if (newStatus === 'paid') {
        const salaryData = calculateEmployeeSalary(employeeId);
        const newExpense = {
            id: generateId('exp'),
            type: 'Salary Payment',
            amount: salaryData.totalSalary,
            description: `Salary for ${employee.username}`,
            date: getCurrentDateTime().date,
            time: getCurrentDateTime().time,
            addedBy: currentUser.id
        };
        
        if (window.setDoc && window.db) {
            window.setDoc(window.doc(window.db, "expenses", newExpense.id), newExpense);
        }
    }
    showNotification(`Salary status updated`, 'success');
}        
        // Salary Management Functions
        
// Salary Management Functions
let currentSelectedEmployeeId = null;

function renderSalarySection() {
    const tbody = document.querySelector('#salary-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Get all non-admin employees
    const allEmployees = users.filter(u => u.role !== 'admin');
    
    if (allEmployees.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px;">
                No employees found
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    allEmployees.forEach(employee => {
        const salaryData = calculateEmployeeSalary(employee.id);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${employee.username} (${employee.role})</td>
            <td>AED ${salaryData.commission.toFixed(2)}</td>
            <td>AED ${salaryData.basicSalary.toFixed(2)}</td>
            <td>
                <span class="status-badge ${salaryData.pendingAmount > 0 ? 'status-unpaid' : 'status-paid'}">
                    AED ${salaryData.pendingAmount.toFixed(2)}
                </span>
            </td>
            <td>
                <button class="bubbles btn-small" onclick="showPartialPaymentModal('${employee.id}')" ${salaryData.pendingAmount <= 0 ? 'disabled' : ''}>
                    <span class="text">Partial Pay</span>
                </button>
            </td>
            <td>
                <button class="bubbles btn-small btn-success" onclick="markSalaryPaid('${employee.id}')" ${salaryData.pendingAmount <= 0 ? 'disabled' : ''}>
                    <span class="text">Mark Paid</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function calculateEmployeeSalary(employeeId) {
    const employee = users.find(u => u.id === employeeId);
    if (!employee) return { commission: 0, basicSalary: 0, totalSalary: 0, pendingAmount: 0 };
    
    // Calculate commission (total earnings for the month)
    const commission = calculateEmployeeCommission(employeeId);
    
    // Calculate basic salary based on achievement
    const achievementRate = calculateAchievementRate(employeeId);
    const basicSalary = achievementRate >= 60 ? (16000 * (achievementRate / 100)) : 0;
    
    const totalSalary = commission + basicSalary;
    
    // Calculate pending amount (total salary minus any partial payments)
    const paidAmount = employee.partialPayments ? employee.partialPayments.reduce((sum, payment) => sum + payment.amount, 0) : 0;
    const pendingAmount = totalSalary - paidAmount;
    
    return {
        commission,
        basicSalary,
        totalSalary,
        pendingAmount,
        paidAmount,
        achievementRate
    };
}



function calculateAchievementRate(employeeId) {
    const employee = users.find(u => u.id === employeeId);
    if (!employee || !employee.targets) return 0;
    
    const currentMonth = currentFinanceMonth;
    
    // Get active targets for current month
    const monthlyTargets = employee.targets.filter(target => {
        const targetMonth = target.assignedDate ? target.assignedDate.substr(0, 7) : '';
        return target.status === 'Active' && targetMonth === currentMonth;
    });
    
    if (monthlyTargets.length === 0) return 0;
    
    const totalTarget = monthlyTargets.reduce((sum, target) => sum + (parseFloat(target.amount) || 0), 0);
    const totalAchieved = monthlyTargets.reduce((sum, target) => sum + (parseFloat(target.achievedAmount) || 0), 0);
    
    return totalTarget > 0 ? (totalAchieved / totalTarget) * 100 : 0;
}
// Helper function to remove commissions when payment is reversed
function removeCommissions(invoiceId, commissionType) {
    // Remove commissions from all users for this invoice
    users.forEach(user => {
        if (user.commissionEarnings) {
            user.commissionEarnings = user.commissionEarnings.filter(
                commission => !(commission.invoiceId === invoiceId && commission.type === commissionType)
            );
        }
    });
    console.log(`Commissions removed for invoice ${invoiceId}, type: ${commissionType}`);
}
function searchEmployeesForSalary() {
    const searchTerm = document.getElementById('salary-search').value.toLowerCase().trim();
    const tbody = document.querySelector('#salary-table tbody');
    tbody.innerHTML = '';
    
    let filteredEmployees = users.filter(u => u.role !== 'admin');
    
    if (searchTerm) {
        filteredEmployees = filteredEmployees.filter(emp => 
            emp.username.toLowerCase().includes(searchTerm)
        );
    }
    
    if (filteredEmployees.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px;">
                ${searchTerm ? 'No employees found for "' + searchTerm + '"' : 'No employees found'}
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    filteredEmployees.forEach(employee => {
        const salaryData = calculateEmployeeSalary(employee.id);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${employee.username} (${employee.role})</td>
            <td>AED ${salaryData.commission.toFixed(2)}</td>
            <td>AED ${salaryData.basicSalary.toFixed(2)}</td>
            <td>
                <span class="status-badge ${salaryData.pendingAmount > 0 ? 'status-unpaid' : 'status-paid'}">
                    AED ${salaryData.pendingAmount.toFixed(2)}
                </span>
            </td>
            <td>
                <button class="bubbles btn-small" onclick="showPartialPaymentModal('${employee.id}')" ${salaryData.pendingAmount <= 0 ? 'disabled' : ''}>
                    <span class="text">Partial Pay</span>
                </button>
            </td>
            <td>
                <button class="bubbles btn-small btn-success" onclick="markSalaryPaid('${employee.id}')" ${salaryData.pendingAmount <= 0 ? 'disabled' : ''}>
                    <span class="text">Mark Paid</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function showPartialPaymentModal(employeeId) {
    const employee = users.find(u => u.id === employeeId);
    if (!employee) {
        showNotification('Employee not found', 'error');
        return;
    }
    
    currentSelectedEmployeeId = employeeId;
    const salaryData = calculateEmployeeSalary(employeeId);
    
    document.getElementById('partial-payment-employee-name').textContent = employee.username;
    document.getElementById('partial-payment-amount').value = '';
    
    // Show payment info
    document.getElementById('partial-total-salary').textContent = salaryData.totalSalary.toFixed(2);
    document.getElementById('partial-already-paid').textContent = salaryData.paidAmount.toFixed(2);
    document.getElementById('partial-remaining').textContent = salaryData.pendingAmount.toFixed(2);
    document.getElementById('partial-payment-info').style.display = 'block';
    
    document.getElementById('partial-payment-modal').style.display = 'block';
}

function closePartialPaymentModal() {
    document.getElementById('partial-payment-modal').style.display = 'none';
    currentSelectedEmployeeId = null;
    document.getElementById('partial-payment-amount').value = '';
}

function processPartialPayment() {
    if (!currentSelectedEmployeeId) { showNotification('No employee selected', 'error'); return; }
    
    const paymentAmount = parseFloat(document.getElementById('partial-payment-amount').value);
    if (isNaN(paymentAmount) || paymentAmount <= 0) { showNotification('Invalid amount', 'error'); return; }

    const employee = users.find(u => u.id === currentSelectedEmployeeId);
    const salaryData = calculateEmployeeSalary(currentSelectedEmployeeId);

    if (paymentAmount > salaryData.pendingAmount) {
        showNotification('Amount exceeds pending', 'error'); return;
    }

    const partialPayment = {
        id: generateId('partpay'),
        amount: paymentAmount,
        date: getCurrentDateTime().date,
        time: getCurrentDateTime().time,
        processedBy: currentUser.id
    };

    const expense = {
        id: generateId('exp'),
        type: 'Salary Payment',
        amount: paymentAmount,
        description: `Partial salary for ${employee.username}`,
        date: getCurrentDateTime().date,
        time: getCurrentDateTime().time,
        addedBy: currentUser.id
    };

    // SAVE TO DATABASE
    if (window.updateDoc && window.db) {
        let currentPayments = employee.partialPayments || [];
        currentPayments.push(partialPayment);
        
        // Update Employee
        window.updateDoc(window.doc(window.db, "users", employee.id), { partialPayments: currentPayments });
        
        // Add to Expenses
        window.setDoc(window.doc(window.db, "expenses", expense.id), expense);
        
        showNotification('Partial payment saved', 'success');
        closePartialPaymentModal();
    }
}

function markSalaryPaid(employeeId) {
    const employee = users.find(u => u.id === employeeId);
    if (!employee) return;
    
    const salaryData = calculateEmployeeSalary(employeeId);

    if (confirm(`Mark remaining AED ${salaryData.pendingAmount.toFixed(2)} as paid?`)) {
        const finalPayment = {
            id: generateId('finalpay'),
            amount: salaryData.pendingAmount,
            date: getCurrentDateTime().date,
            time: getCurrentDateTime().time,
            processedBy: currentUser.id,
            isFinalPayment: true
        };

        const expense = {
            id: generateId('exp'),
            type: 'Salary Payment',
            amount: salaryData.pendingAmount,
            description: `Final salary for ${employee.username}`,
            date: getCurrentDateTime().date,
            time: getCurrentDateTime().time,
            addedBy: currentUser.id
        };

        const historyEntry = {
            month: currentFinanceMonth,
            totalSalary: salaryData.totalSalary,
            paidAmount: salaryData.totalSalary,
            paymentDate: getCurrentDateTime().date
        };

        // SAVE TO DATABASE
        if (window.updateDoc && window.db) {
            let currentPayments = employee.partialPayments || [];
            currentPayments.push(finalPayment);

            let currentHistory = employee.salaryHistory || [];
            currentHistory.push(historyEntry);

            // Update Employee
            window.updateDoc(window.doc(window.db, "users", employee.id), { 
                partialPayments: currentPayments,
                salaryHistory: currentHistory
            });

            // Add to Expenses
            window.setDoc(window.doc(window.db, "expenses", expense.id), expense);
            
            showNotification('Salary marked fully paid', 'success');
        }
    }
}










// Update the finance subsection navigation to include salary management
function showFinanceSubSection(subsection) {
    // Remove active class from all finance nav buttons
    document.querySelectorAll('#admin-finance .nav-btn').forEach(btn => btn.classList.remove('active'));
    // Add active class to clicked button
    event.target.classList.add('active');
    
    // Hide all finance subsections
    document.querySelectorAll('#admin-finance .finance-subsection').forEach(sub => sub.classList.remove('active'));
    
    // Show selected subsection
    document.getElementById(`finance-${subsection}`).classList.add('active');
    
    // Render subsection content
    switch(subsection) {
        case 'overview':
            renderFinanceOverview();
            break;
        case 'profit':
            renderProfitSection();
            break;
        case 'expenses':
            renderExpensesSection();

        case 'salaries':
           renderSalarySection(); // Add this line
           break;
    }
}

function showFinanceSubSection(subsection) {
    // Remove active class from all finance nav buttons
    document.querySelectorAll('#admin-finance .nav-btn').forEach(btn => btn.classList.remove('active'));
    // Add active class to clicked button
    event.target.classList.add('active');
    
    // Hide all finance subsections
    document.querySelectorAll('#admin-finance .finance-subsection').forEach(sub => sub.classList.remove('active'));
    
    // Show selected subsection
    document.getElementById(`finance-${subsection}`).classList.add('active');
    
    // Render subsection content
    switch(subsection) {
        case 'overview':
            renderFinanceOverview();
            break;
        case 'profit':
            renderProfitSection();
            break;
        case 'expenses':
            renderExpensesSection();
            break;
        case 'salaries':
           renderSalarySection(); // Add this line
            break;
    }
}

// Financial Overview Calculation
function renderFinanceOverview() {
    const selectedMonth = currentFinanceMonth;
    
    // Calculate total profit (from both driver and passenger sides)
    const monthTransactions = finance.transactions.filter(t => 
        t.date.startsWith(selectedMonth) && 
        (t.type === 'driver_payment' || t.type === 'service_charges')
    );
    
    const driverSideProfit = monthTransactions
        .filter(t => t.type === 'driver_payment')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const passengerSideProfit = monthTransactions
        .filter(t => t.type === 'service_charges')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const totalProfit = driverSideProfit + passengerSideProfit;
    
    // Calculate total expenses
    const monthExpenses = expenses.filter(exp => exp.date.startsWith(selectedMonth));
    const totalExpenses = monthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
    
    // Calculate net profit
    const netProfit = totalProfit - totalExpenses;
    
    // Calculate profit margin
    const profitMargin = totalProfit > 0 ? (netProfit / totalProfit) * 100 : 0;
    
    // Update overview stats
    document.getElementById('total-profit-overview').textContent = `AED ${totalProfit.toFixed(2)}`;
    document.getElementById('total-expenses-overview').textContent = `AED ${totalExpenses.toFixed(2)}`;
    document.getElementById('net-profit').textContent = `AED ${netProfit.toFixed(2)}`;
    document.getElementById('profit-margin').textContent = `${profitMargin.toFixed(1)}%`;
    
    // Update detailed breakdown
    document.getElementById('driver-revenue').textContent = `AED ${driverSideProfit.toFixed(2)}`;
    document.getElementById('passenger-revenue').textContent = `AED ${passengerSideProfit.toFixed(2)}`;
    document.getElementById('total-revenue').textContent = `AED ${totalProfit.toFixed(2)}`;
    document.getElementById('operational-expenses').textContent = `AED ${totalExpenses.toFixed(2)}`;
    document.getElementById('salary-expenses').textContent = `AED 0.00`; // Placeholder for now
    document.getElementById('total-expenses-overview-detailed').textContent = `AED ${totalExpenses.toFixed(2)}`;
    document.getElementById('net-profit-detailed').textContent = `AED ${netProfit.toFixed(2)}`;
    
    // Color code net profit
    const netProfitElement = document.getElementById('net-profit-detailed');
    netProfitElement.style.color = netProfit >= 0 ? 'var(--status-paid)' : 'var(--status-unpaid)';
}

// Update the existing showAdminSection function to handle finance
function showAdminSection(section) {
    // 1. Remove active class from all buttons
    document.querySelectorAll('#admin-dashboard .nav-btn').forEach(btn => btn.classList.remove('active'));
    
    // 2. Add active class safely
    if (window.event && window.event.target && window.event.target.classList.contains('nav-btn')) {
        window.event.target.classList.add('active');
    } else {
        const targetBtn = document.querySelector(`#admin-dashboard .nav-btn[onclick*="'${section}'"]`);
        if (targetBtn) targetBtn.classList.add('active');
    }
    
    // 3. Hide all sections
    document.querySelectorAll('#admin-dashboard .section').forEach(sec => sec.classList.remove('active'));
    
    // 4. Show selected section
    if (section === 'dashboard') {
        document.getElementById('admin-dashboard-section').classList.add('active');
        renderAdminDashboardSection();
    } else {
        const targetSection = document.getElementById(`admin-${section}`);
        if (targetSection) targetSection.classList.add('active');
    }
    
    // 5. Reset filters logic
    const currentMonth = getCurrentMonth();
    if (section === 'dashboard') {
        document.getElementById('dashboard-month-filter').value = currentMonth;
        currentDashboardMonth = currentMonth;
    } else if (section === 'profiles') {
        document.getElementById('profiles-month-filter').value = currentMonth;
        currentProfilesMonth = currentMonth;
    } else if (section === 'cancelled') {
        document.getElementById('cancelled-month-filter').value = currentMonth;
        currentCancelledMonth = currentMonth;
    } else if (section === 'invoices') {
        document.getElementById('invoices-month-filter').value = currentMonth;
        currentInvoicesMonth = currentMonth;
    } else if (section === 'finance') {
        document.getElementById('finance-month-filter').value = currentMonth;
        currentFinanceMonth = currentMonth;
    }
    
    // 6. Render content
    switch(section) {
        case 'dashboard': renderAdminDashboardSection(); break;
        case 'employees': renderEmployeesTable(); break;
        case 'targets': renderAdminTargetsTable(); break;
        case 'profiles': renderAdminProfilesTable(); break;
        case 'cancelled': renderAdminCancelledTable(); break;
        case 'invoices': renderAdminInvoicesTable(); break;
        case 'finance': renderFinanceSection(); break;
        case 'profit': renderProfitSection(); break;
        case 'expenses': renderExpensesSection(); break;
        case 'attendance': 
            if (!document.getElementById('attendance-date-filter').value) {
                document.getElementById('attendance-date-filter').value = new Date().toISOString().split('T')[0];
            }
            renderAttendanceSection(); 
            break;
        case 'split': renderAdminSplitTable(); break;
    }
}

// Update month filter for finance section
document.getElementById('finance-month-filter').addEventListener('change', function() {
    currentFinanceMonth = this.value;
    renderFinanceOverview();
    renderProfitSection();
    renderExpensesSection();
});

function updateEmployeeMonthlyGross(employeeId) {
    const employee = users.find(u => u.id === employeeId);
    if (!employee) return;
    
    const userTargets = employee.targets || [];
    const activeTargets = userTargets.filter(target => target.status === 'Active');
    const completedTargets = userTargets.filter(target => target.status === 'Completed');
    
    const assignedAmount = activeTargets.reduce((sum, target) => sum + (parseFloat(target.amount) || 0), 0);
    const achievedAmount = completedTargets.reduce((sum, target) => sum + (parseFloat(target.amount) || 0), 0);
    const progressPercent = assignedAmount > 0 ? (achievedAmount / assignedAmount) * 100 : 0;
    
    // Update the monthly gross section if this employee is currently logged in
    if (currentUser && currentUser.id === employeeId) {
        if (currentUser.role === 'passenger') {
            document.getElementById('monthly-target').textContent = `AED ${assignedAmount.toFixed(2)}`;
            document.getElementById('monthly-achieved').textContent = `AED ${achievedAmount.toFixed(2)}`;
            document.getElementById('achievement-rate').textContent = `${progressPercent.toFixed(1)}%`;
            
            // Update progress bar
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = `${Math.min(progressPercent, 100)}%`;
                progressBar.textContent = `${progressPercent.toFixed(1)}%`;
            }
            document.getElementById('progress-text').textContent = `${progressPercent.toFixed(1)}% Complete`;
            document.getElementById('target-amount').textContent = assignedAmount.toFixed(2);
            
        } else if (currentUser.role === 'driver') {
            document.getElementById('driver-monthly-target').textContent = `AED ${assignedAmount.toFixed(2)}`;
            document.getElementById('driver-monthly-achievement').textContent = `AED ${achievedAmount.toFixed(2)}`;
            document.getElementById('driver-achievement-rate').textContent = `${progressPercent.toFixed(1)}%`;
            
            // Update driver progress bar
            const progressBar = document.getElementById('driver-progress-bar');
            if (progressBar) {
                progressBar.style.width = `${Math.min(progressPercent, 100)}%`;
                progressBar.textContent = `${progressPercent.toFixed(1)}%`;
            }
            document.getElementById('driver-progress-text').textContent = `${progressPercent.toFixed(1)}% Complete`;
            document.getElementById('driver-target-amount').textContent = assignedAmount.toFixed(2);
        }
    }
}        
function renderDriverMonthlyGross() {
    // Get current month and year
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    // Get ALL driver's assigned profiles for counting
    const allDriverProfiles = invoices.filter(inv => inv.driverId === currentUser.id);
    
    // Calculate metrics based on status - COUNT ALL PROFILES
    const assignedProfiles = allDriverProfiles.length;
    const bookedProfiles = allDriverProfiles.filter(inv => inv.pickupStatus === 'pickup confirmed').length;
    const pickedProfiles = allDriverProfiles.filter(inv => inv.paymentStatus === 'paid').length;
    
    // Calculate success rate based on ALL assigned profiles
    const successRate = assignedProfiles > 0 ? (pickedProfiles / assignedProfiles) * 100 : 0;
    
    // FIXED: Calculate achievement from ACTUAL EARNINGS - NOW SHOWING 15% OF DRIVER CHARGES
    const paidInvoices = allDriverProfiles.filter(inv => inv.paymentStatus === 'paid');
    
    // Calculate total achievement - SHOW 15% OF DRIVER CHARGES
    const totalAchievement = paidInvoices.reduce((sum, invoice) => {
        const driverCharges = invoice.driverCharges || 0;
        return sum + (driverCharges * 0.15); // Only 15% of driver charges
    }, 0);
    
    // Get target amount
    const userTargets = currentUser.targets || [];
    const activeTargets = userTargets.filter(target => target.status === 'Active');
    const assignedAmount = activeTargets.reduce((sum, target) => sum + (parseFloat(target.amount) || 0), 0);
    
    // Set targets - use assigned target if available, otherwise default
    const monthlyTarget = assignedAmount > 0 ? assignedAmount : 500;
    
    // Calculate achievement rate based on achievement vs target
    const achievementRate = monthlyTarget > 0 ? (totalAchievement / monthlyTarget) * 100 : 0;
    
    // Update the stats cards - NOW SHOWING 15% OF DRIVER CHARGES
    document.getElementById('driver-monthly-target').textContent = `AED ${monthlyTarget.toFixed(2)}`;
    document.getElementById('driver-monthly-achievement').textContent = `AED ${totalAchievement.toFixed(2)}`;
    document.getElementById('driver-assigned-profiles').textContent = assignedProfiles;
    document.getElementById('driver-booked-profiles').textContent = bookedProfiles;
    document.getElementById('driver-picked-profiles').textContent = pickedProfiles;
    document.getElementById('driver-achievement-rate').textContent = `${achievementRate.toFixed(1)}%`;
    
    // Update progress bar
    const progressPercent = Math.min(achievementRate, 100);
    const progressBar = document.getElementById('driver-progress-bar');
    const progressText = document.getElementById('driver-progress-text');
    const targetAmount = document.getElementById('driver-target-amount');
    
    if (progressBar) {
        progressBar.style.width = `${progressPercent}%`;
        progressBar.textContent = `${progressPercent.toFixed(1)}%`;
    }
    if (progressText) {
        progressText.textContent = `${progressPercent.toFixed(1)}% Complete`;
    }
    if (targetAmount) {
        targetAmount.textContent = monthlyTarget.toFixed(2);
    }
    
    console.log('Driver Monthly Gross - 15% Calculation:', {
        totalAchievement: totalAchievement,
        monthlyTarget: monthlyTarget,
        achievementRate: achievementRate,
        paidInvoicesCount: paidInvoices.length
    });
}
// Add to your existing variables
window.expenses = [];
let currentProfitMonth = getCurrentMonth();
let currentExpenseMonth = getCurrentMonth();
// Month filtering functionality
let currentCancelledMonth = getCurrentMonth();
let currentDashboardMonth = getCurrentMonth();
let currentProfilesMonth = getCurrentMonth();
let currentInvoicesMonth = getCurrentMonth();
let currentFinanceMonth = getCurrentMonth();

// Profit Management Functions
function renderProfitSection() {
    const selectedMonth = currentProfitMonth;
    
    // Filter profit transactions by month
    const monthTransactions = finance.transactions.filter(t => 
        t.date.startsWith(selectedMonth) && 
        (t.type === 'driver_payment' || t.type === 'service_charges')
    );
    
    // Calculate different profit types
    const driverSideProfit = monthTransactions
        .filter(t => t.type === 'driver_payment')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const passengerSideProfit = monthTransactions
        .filter(t => t.type === 'service_charges')
        .reduce((sum, t) => sum + t.amount, 0);
    
    const totalProfit = driverSideProfit + passengerSideProfit;
    
    // Update profit stats
    document.getElementById('total-profit').textContent = `AED ${totalProfit.toFixed(2)}`;
    document.getElementById('driver-side-profit').textContent = `AED ${driverSideProfit.toFixed(2)}`;
    document.getElementById('passenger-side-profit').textContent = `AED ${passengerSideProfit.toFixed(2)}`;
    
    // Render profit table
    const tbody = document.querySelector('#profit-table tbody');
    tbody.innerHTML = '';
    
    monthTransactions.slice().reverse().forEach(transaction => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${transaction.date}</td>
            <td>${transaction.type === 'driver_payment' ? 'Driver Side' : 'Passenger Side'}</td>
            <td>${transaction.invoiceId}</td>
            <td>AED ${transaction.amount.toFixed(2)}</td>
            <td>${transaction.description || 'N/A'}</td>
        `;
        tbody.appendChild(row);
    });
}

// Expense Management Functions
function showAddExpenseModal() {
    document.getElementById('add-expense-modal').style.display = 'block';
}

function closeAddExpenseModal() {
    document.getElementById('add-expense-modal').style.display = 'none';
    // Clear form fields
    document.getElementById('expense-type').value = '';
    document.getElementById('expense-amount').value = '';
    document.getElementById('expense-description').value = '';
}

function addNewExpense() {
    showLoader();
    setTimeout(() => {
        const type = document.getElementById('expense-type').value.trim();
        const amount = parseFloat(document.getElementById('expense-amount').value);
        const description = document.getElementById('expense-description').value.trim();
        
        if (!type || !amount || !description) {
            showNotification('Please fill all fields', 'error'); hideLoader(); return;
        }

        const newExpense = {
            id: generateId('exp'),
            type: type,
            amount: amount,
            description: description,
            date: getCurrentDateTime().date,
            time: getCurrentDateTime().time,
            addedBy: currentUser.id
        };

        // SAVE TO DATABASE
        if (window.setDoc && window.db) {
            window.setDoc(window.doc(window.db, "expenses", newExpense.id), newExpense);
        }
        
        closeAddExpenseModal();
        showNotification('Expense saved successfully', 'success');
        hideLoader();
    }, 1000);
}

function renderExpensesSection() {
    const selectedMonth = currentExpenseMonth;
    
    // Filter expenses by month
    const monthExpenses = expenses.filter(exp => 
        exp.date.startsWith(selectedMonth)
    );
    
    // Calculate expense totals
    const totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);
    const monthlyExpenses = monthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
    
    // Update expense stats
    document.getElementById('total-expenses').textContent = `AED ${totalExpenses.toFixed(2)}`;
    document.getElementById('monthly-expenses').textContent = `AED ${monthlyExpenses.toFixed(2)}`;
    
    // Render expenses table
    const tbody = document.querySelector('#expenses-table tbody');
    tbody.innerHTML = '';
    
    if (monthExpenses.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="5" style="text-align: center; padding: 20px;">
                No expenses recorded for selected month
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    monthExpenses.slice().reverse().forEach(expense => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${expense.date}</td>
            <td>${expense.type}</td>
            <td>AED ${expense.amount.toFixed(2)}</td>
            <td>${expense.description}</td>
            <td>
                <button class="bubbles btn-small btn-danger" onclick="deleteExpense('${expense.id}')">
                    <span class="text">Delete</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function deleteExpense(expenseId) {
    if (confirm('Are you sure you want to delete this expense?')) {
        // DELETE FROM DATABASE
        if (window.deleteDoc && window.db) {
            window.deleteDoc(window.doc(window.db, "expenses", expenseId));
            showNotification('Expense deleted permanently', 'success');
        }
    }
}

// Update the showAdminSection function to handle new sections
function showAdminSection(section) {
    // Remove active class from all nav buttons
    document.querySelectorAll('#admin-dashboard .nav-btn').forEach(btn => btn.classList.remove('active'));
    // Add active class to clicked button
    event.target.classList.add('active');
    
    // Hide all sections
    document.querySelectorAll('#admin-dashboard .section').forEach(sec => sec.classList.remove('active'));
    
    // Show selected section
    if (section === 'dashboard') {
        document.getElementById('admin-dashboard-section').classList.add('active');
        renderAdminDashboardSection();
    } else {
        document.getElementById(`admin-${section}`).classList.add('active');
    }
    
    // Reset month filters to current month when switching sections
    const currentMonth = getCurrentMonth();
    if (section === 'profit') {
        document.getElementById('profit-month-filter').value = currentMonth;
        currentProfitMonth = currentMonth;
    } else if (section === 'expenses') {
        document.getElementById('expense-month-filter').value = currentMonth;
        currentExpenseMonth = currentMonth;
    }
    
    // Render section-specific content
    switch(section) {
        case 'dashboard':
            renderAdminDashboardSection();
            break;
        case 'employees':
            renderEmployeesTable();
            break;
        case 'targets':
            renderAdminTargetsTable();
            break;
        case 'profiles':
            renderAdminProfilesTable();
            break;
        case 'cancelled':
            renderAdminCancelledTable();
            break;
        case 'invoices':
            renderAdminInvoicesTable();
            break;
        case 'finance':
            renderFinanceSection();
            break;
        case 'profit':
            renderProfitSection();
            break;
        case 'expenses':
            renderExpensesSection();
            break;
    }
}

// Add month filter event listeners (add this to your initializeMonthFilters function)
function initializeMonthFilters() {
    // ... existing code ...
    
    // Add new month filters
    document.getElementById('profit-month-filter').value = currentMonth;
    document.getElementById('expense-month-filter').value = currentMonth;
    
    document.getElementById('profit-month-filter').addEventListener('change', function() {
        currentProfitMonth = this.value;
        renderProfitSection();
    });
    
    document.getElementById('expense-month-filter').addEventListener('change', function() {
        currentExpenseMonth = this.value;
        renderExpensesSection();
    });
}
function getCurrentMonth() {
    const now = new Date();
    return now.toISOString().substr(0, 7); // Returns YYYY-MM format
}

function filterByMonth(items, month, dateField = 'date') {
    if (!month) return items;
    return items.filter(item => {
        // Use the specified date field, fall back to 'date' if not available
        const itemDate = new Date(item[dateField] || item.date);
        const itemMonth = itemDate.toISOString().substr(0, 7);
        return itemMonth === month;
    });
}

// Initialize month filters
function initializeMonthFilters() {
    // Set current month as default for all filters
    const currentMonth = getCurrentMonth();
    
    document.getElementById('dashboard-month-filter').value = currentMonth;
    document.getElementById('profiles-month-filter').value = currentMonth;
    document.getElementById('cancelled-month-filter').value = currentMonth;
    document.getElementById('invoices-month-filter').value = currentMonth;
    document.getElementById('finance-month-filter').value = currentMonth;
    
    // Add event listeners
    document.getElementById('dashboard-month-filter').addEventListener('change', function() {
        currentDashboardMonth = this.value;
        renderAdminDashboardSection();
    });
    
    document.getElementById('profiles-month-filter').addEventListener('change', function() {
        currentProfilesMonth = this.value;
        renderAdminProfilesTable();
    });
    
    document.getElementById('cancelled-month-filter').addEventListener('change', function() {
        currentCancelledMonth = this.value;
        renderAdminCancelledTable();
    });
    
    document.getElementById('invoices-month-filter').addEventListener('change', function() {
        currentInvoicesMonth = this.value;
        renderAdminInvoicesTable();
    });
    
    document.getElementById('finance-month-filter').addEventListener('change', function() {
        currentFinanceMonth = this.value;
        renderFinanceSection();
    });
}

// Update the render functions to include month filtering:

function renderAdminDashboardSection() {
    const tbody = document.querySelector('#admin-dashboard-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Filter by month
    const filteredProfiles = filterByMonth(invoices, currentDashboardMonth);
    
    if (filteredProfiles.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px;">
                No passenger profiles found for selected month
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    // Rest of your existing renderAdminDashboardSection code...
    // Just replace 'invoices' with 'filteredProfiles' in the forEach loop
}

function renderAdminProfilesTable() {
    const tbody = document.querySelector('#admin-profiles-table tbody');
    tbody.innerHTML = '';
    
    // Filter by month
    const pendingProfiles = invoices.filter(inv => 
        (inv.pickupStatus === 'no status yet' || !inv.pickupStatus)
    );
    const filteredProfiles = filterByMonth(pendingProfiles, currentProfilesMonth);
    
    if (filteredProfiles.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px;">
                No pending passenger profiles found for selected month
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    // Initialize admin table choice boxes after rendering
    initializeAdminTableChoiceBoxes();
}

function renderAdminInvoicesTable() {
    const tbody = document.querySelector('#admin-invoices-table tbody');
    tbody.innerHTML = '';
    
    // Filter invoices that are confirmed pickups
    const confirmedInvoices = invoices.filter(inv => inv.pickupStatus === 'pickup confirmed');
    
    // Filter based on current filter
    let filteredInvoices = confirmedInvoices;
    
    switch(currentAdminFilter) {
        case 'unpaid':
            filteredInvoices = confirmedInvoices.filter(inv => inv.paymentStatus === 'unpaid');
            break;
        case 'paid':
            filteredInvoices = confirmedInvoices.filter(inv => inv.paymentStatus === 'paid');
            break;
        case 'all':
        default:
            filteredInvoices = confirmedInvoices;
    }
    
    if (filteredInvoices.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="7" style="text-align: center; padding: 20px;">
                No invoices found
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    // Sort by date (newest first)
    filteredInvoices = sortInvoicesByDate(filteredInvoices);
    
    filteredInvoices.forEach(invoice => {
        // Calculate driver side payment (10% of remaining budget after service charges)
        const driverSidePayment = invoice.driverCharges || 0;
  
        // Payment status
        const paymentStatus = invoice.paymentStatus || 'unpaid';
        const paymentStatusClass = paymentStatus === 'paid' ? 'status-paid' : 'status-unpaid';
        const paymentStatusText = paymentStatus === 'paid' ? 'Paid' : 'Not Yet';
        
        // Service charges payment status
        const serviceChargesStatus = invoice.serviceChargesPaid ? 'Paid' : 'Not Yet';
        const serviceChargesStatusClass = invoice.serviceChargesPaid ? 'status-paid' : 'status-unpaid';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${invoice.passengerAgent || 'N/A'}</td>
            <td>AED ${(invoice.driverCharges || 0).toFixed(2)}</td>
            <td>AED ${invoice.serviceCharges.toFixed(2)}</td>
            <td>
                <div class="table-choice-container" id="payment-status-container-${invoice.id}">
                    <div class="table-choice-box ${paymentStatusClass} ${paymentStatus === 'paid' ? 'selected' : ''}" id="payment-status-choice-${invoice.id}">
                        <span>${paymentStatusText}</span>
                        <span></span>
                    </div>
                    <div class="table-choice-options">
                        <div class="table-choice-option" data-value="unpaid">Not Yet</div>
                        <div class="table-choice-option" data-value="paid">Paid</div>
                    </div>
                </div>
            </td>
            <td>
                <div class="table-choice-container" id="service-charges-status-container-${invoice.id}">
                    <div class="table-choice-box ${serviceChargesStatusClass} ${invoice.serviceChargesPaid ? 'selected' : ''}" id="service-charges-status-choice-${invoice.id}">
                        <span>${serviceChargesStatus}</span>
                        <span></span>
                    </div>
                    <div class="table-choice-options">
                        <div class="table-choice-option" data-value="unpaid">Not Yet</div>
                        <div class="table-choice-option" data-value="paid">Paid</div>
                    </div>
                </div>
            </td>
            <td>
                <button class="bubbles btn-small" onclick="viewInvoiceDetails('${invoice.id}')">
                    <span class="text">View Profile</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Initialize admin table choice boxes after rendering
    initializeAdminTableChoiceBoxes();
}

function renderFinanceSection() {
    const selectedMonth = currentFinanceMonth;
    
    // Filter transactions by month
    const monthTransactions = finance.transactions.filter(t => 
        t.date.startsWith(selectedMonth)
    );
    
    const dailyEarnings = monthTransactions
        .filter(t => t.date === new Date().toISOString().split('T')[0])
        .reduce((sum, t) => sum + t.amount, 0);
    
    const monthlyEarnings = monthTransactions
        .reduce((sum, t) => sum + t.amount, 0);
    
    // Update the display - you might want to adjust these based on your needs
    document.getElementById('daily-earnings').textContent = `AED ${dailyEarnings.toFixed(2)}`;
    document.getElementById('weekly-earnings').textContent = `AED ${monthlyEarnings.toFixed(2)}`; // Adjust as needed
    document.getElementById('monthly-earnings').textContent = `AED ${monthlyEarnings.toFixed(2)}`;
    document.getElementById('total-earnings').textContent = `AED ${finance.totalPaid.toFixed(2)}`;
    
    // Render finance table with filtered transactions
    const tbody = document.querySelector('#finance-table tbody');
    tbody.innerHTML = '';
    
    monthTransactions.slice().reverse().forEach(transaction => {
        const driver = users.find(u => u.id === transaction.driverId);
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${transaction.date}</td>
            <td>${transaction.time}</td>
            <td>${transaction.invoiceId}</td>
            <td>AED ${transaction.amount.toFixed(2)}</td>
            <td>${driver ? driver.username : 'Unknown'}</td>
        `;
        tbody.appendChild(row);
    });
}
function renderMonthlyGrossSection() {
    // Get current month and year
    const now = new Date();
    const currentMonth = now.getMonth();
    const currentYear = now.getFullYear();
    
    // Get user's invoices for current month
    const userInvoices = invoices.filter(inv => 
        inv.passengerId === currentUser.id && 
        new Date(inv.date).getMonth() === currentMonth &&
        new Date(inv.date).getFullYear() === currentYear
    );
    
    // CRITICAL FIX: Only count PAID service charges for passenger earnings
    const paidServiceChargesInvoices = userInvoices.filter(inv => inv.serviceChargesPaid);
    
    // Calculate passenger earnings - ONLY from confirmed service charges payments
    const totalRevenue = paidServiceChargesInvoices.reduce((sum, inv) => sum + (inv.serviceCharges * 0.15), 0);
    
    const profilesCreated = userInvoices.length;
    const profilesBooked = userInvoices.filter(inv => inv.pickupStatus === 'pickup confirmed').length;
    const profilesPicked = userInvoices.filter(inv => inv.paymentStatus === 'paid').length;
    
    // ADD TARGET CALCULATION HERE
    const userTargets = currentUser.targets || [];
    const activeTargets = userTargets.filter(target => target.status === 'Active');
    const assignedAmount = activeTargets.reduce((sum, target) => sum + (parseFloat(target.amount) || 0), 0);
    
    // Set targets - use assigned target if available, otherwise default
    const monthlyTarget = assignedAmount > 0 ? assignedAmount : 1000; // Use assigned target or default to AED 1000
    
    const profilesTarget = 10; // 10 profiles target
    
    // Calculate achievement rate based on ACTUAL PAID service charges only
    const achievementRate = monthlyTarget > 0 ? (totalRevenue / monthlyTarget) * 100 : 0;
    
    // Update the stats cards
    document.getElementById('monthly-target').textContent = `AED ${monthlyTarget.toFixed(2)}`;
    document.getElementById('monthly-achieved').textContent = `AED ${totalRevenue.toFixed(2)}`;
    document.getElementById('profiles-created').textContent = profilesCreated;
    document.getElementById('profiles-booked').textContent = profilesBooked;
    document.getElementById('profiles-picked').textContent = profilesPicked;
    document.getElementById('achievement-rate').textContent = `${achievementRate.toFixed(1)}%`;
    
    // Update progress bar - ONLY BASED ON ACTUAL EARNINGS (paid service charges)
    const progressPercent = Math.min(achievementRate, 100);
    document.getElementById('progress-bar').style.width = `${progressPercent}%`;
    document.getElementById('progress-bar').textContent = `${progressPercent.toFixed(1)}%`;
    document.getElementById('progress-text').textContent = `${progressPercent.toFixed(1)}% Complete`;
    document.getElementById('target-amount').textContent = monthlyTarget.toFixed(2);
    
    console.log('Passenger Monthly Gross - Fixed Calculation:', {
        totalRevenue: totalRevenue,
        monthlyTarget: monthlyTarget,
        achievementRate: achievementRate,
        paidServiceChargesCount: paidServiceChargesInvoices.length,
        paidServiceChargesAmount: paidServiceChargesInvoices.reduce((sum, inv) => sum + inv.serviceCharges, 0)
    });
}
//hide the loader in 5 min
function hideLoader() {
    const loader = document.getElementById('loader-overlay');
    console.log("Hiding loader...", loader); // Debug log
    loader.classList.add('hidden');
}

        // Show loader when page loads
        document.addEventListener('DOMContentLoaded', function() {
            showLoader();
            // Simulate loading time
            setTimeout(() => {
                hideLoader();
            }, 2000);
            
            // Initialize all status buttons
            initializeStatusButtons();
            initializeChoiceBoxes();
        });

        // Global Variables and Data Storage
        let currentUser = null;

        window.users = []; 
        window.invoices = [];

        window.finance = { totalPaid: 0, transactions: [] };
        // Filter variables
        let currentAdminFilter = 'all';
        let currentPassengerFilter = 'all';
        let currentDriverFilter = 'all';

        // Choice box management
        let selectedPassengerType = null;
        let selectedRideWay = null;
        let selectedDaysPerWeek = null;
        let selectedRideWayProfile = null;
        let selectedRideType = null;
        let selectedGender = null;

        // Initialize choice boxes
        function initializeChoiceBoxes() {
            // Initialize all choice boxes
            const choiceBoxes = document.querySelectorAll('.choice-box');
            
            choiceBoxes.forEach(box => {
                box.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const container = this.closest('.choice-container');
                    container.classList.toggle('active');
                });
            });
            
            // Initialize choice options
const choiceOptions = document.querySelectorAll('.choice-option');

choiceOptions.forEach(option => {
    option.addEventListener('click', function(e) {
        e.stopPropagation();
        const container = this.closest('.choice-container');
        const choiceBox = container.querySelector('.choice-box');
        const value = this.getAttribute('data-value');
        const text = this.textContent;
        
        // Update choice box text
        choiceBox.querySelector('span:first-child').textContent = text;
        
        // Add selected class for color fill
        choiceBox.classList.add('selected');
        
        // Store the selected value based on the container ID
        const containerId = container.id;
        
        if (containerId.includes('passenger-type')) {
            selectedPassengerType = value;
        } else if (containerId.includes('ride-way') && !containerId.includes('profile')) {
            selectedRideWay = value;
        } else if (containerId.includes('days-per-week')) {
            selectedDaysPerWeek = value;
        } else if (containerId.includes('ride-way-profile')) {
            selectedRideWayProfile = value;
        } else if (containerId.includes('ride-type')) {
            selectedRideType = value;
            console.log('Ride type selected:', value); // Debug log
        } else if (containerId.includes('passenger-gender')) {
            selectedGender = value;
        }
        
        // Close the dropdown
        container.classList.remove('active');
        
        // Debug log to verify values are set
        console.log('Selected values:', {
            daysPerWeek: selectedDaysPerWeek,
            rideWayProfile: selectedRideWayProfile,
            rideType: selectedRideType,
            gender: selectedGender
        });
    });
});
            // Close dropdowns when clicking outside
            document.addEventListener('click', function() {
                document.querySelectorAll('.choice-container').forEach(container => {
                    container.classList.remove('active');
                });
            });
            
            // Initialize admin table choice boxes
            initializeAdminTableChoiceBoxes();
        }

        // FIXED: Initialize admin table choice boxes with proper event handling
// FIXED: Initialize admin table choice boxes with proper event handling
function initializeAdminTableChoiceBoxes() {
    // Handle all clicks on the document
    document.addEventListener('click', function(e) {
        const choiceBox = e.target.closest('.table-choice-box');
        const isOption = e.target.closest('.table-choice-option');
        
        // 1. If clicking a Choice Box (The button)
        if (choiceBox) {
            const container = choiceBox.closest('.table-choice-container');
            const options = container.querySelector('.table-choice-options');
            const wasActive = container.classList.contains('active');

            // Close ALL other open dropdowns first
            document.querySelectorAll('.table-choice-container').forEach(c => {
                c.classList.remove('active');
                const opt = c.querySelector('.table-choice-options');
                if (opt) opt.style.display = 'none';
            });

            // If it wasn't active before, open it now
            if (!wasActive) {
                container.classList.add('active');
                options.style.display = 'block';
                
                // Position logic
                const rect = choiceBox.getBoundingClientRect();
                options.style.position = 'fixed';
                options.style.left = rect.left + 'px';
                options.style.width = rect.width + 'px';
                
                // Calculate height to see if we should flip it UP
                const dropdownHeight = options.offsetHeight || 250;
                if (rect.bottom + dropdownHeight > window.innerHeight) {
                    options.style.top = (rect.top - dropdownHeight) + 'px';
                } else {
                    options.style.top = (rect.bottom + 2) + 'px';
                }
            } else {
                // If it WAS active, we just closed it (the cleanup above did this)
                container.classList.remove('active');
                options.style.display = 'none';
            }
            e.stopPropagation();
            return;
        }

        // 2. If clicking an Option (The name/choice)
        if (isOption) {
            const option = isOption;
            const container = option.closest('.table-choice-container');
            const choiceBox = container.querySelector('.table-choice-box');
            const options = container.querySelector('.table-choice-options');
            const value = option.getAttribute('data-value');
            const text = option.textContent;

            choiceBox.querySelector('span:first-child').textContent = text;
            choiceBox.classList.add('selected');

            // Close the menu
            container.classList.remove('active');
            options.style.display = 'none';

            // Trigger the backend functions
            const containerId = container.id;
            if (containerId.includes('driver-agent')) {
                assignDriverAgent(containerId.replace('driver-agent-container-', ''), value);
            } else if (containerId.includes('pickup-status')) {
                updatePickupStatus(containerId.replace('pickup-status-container-', ''), value);
            } else if (containerId.includes('payment-status')) {
                updatePaymentStatus(containerId.replace('payment-status-container-', ''), value);
            } else if (containerId.includes('service-charges-status')) {
                updateServiceChargesStatus(containerId.replace('service-charges-status-container-', ''), value);
            } else if (containerId.includes('salary-status')) {
                updateSalaryStatus(containerId.replace('salary-status-container-', ''), value);
            } else if (containerId.includes('dashboard-driver')) {
                 assignDriverAgent(containerId.replace('dashboard-driver-container-', ''), value);
            }
            
            e.stopPropagation();
            return;
        }

        // 3. If clicking anywhere else, close all dropdowns
        document.querySelectorAll('.table-choice-container').forEach(container => {
            container.classList.remove('active');
            const opt = container.querySelector('.table-choice-options');
            if (opt) opt.style.display = 'none';
        });
    });
}

// Fix dropdown positioning for dashboard
function fixDropdownPositioning() {
    document.addEventListener('click', function(e) {
        if (e.target.closest('.table-choice-box')) {
            const choiceBox = e.target.closest('.table-choice-box');
            const container = choiceBox.closest('.table-choice-container');
            
            if (container) {
                // Close all other dropdowns
                document.querySelectorAll('.table-choice-container').forEach(c => {
                    if (c !== container) {
                        c.classList.remove('active');
                    }
                });
                
                container.classList.toggle('active');
                
                // Position the dropdown properly
                const options = container.querySelector('.table-choice-options');
                if (options && container.classList.contains('active')) {
                    const rect = choiceBox.getBoundingClientRect();
                    options.style.left = rect.left + 'px';
                    options.style.top = (rect.bottom + 2) + 'px';
                    options.style.width = rect.width + 'px';
                }
            }
            e.stopPropagation();
        }
        
        // Close dropdowns when clicking outside
        if (!e.target.closest('.table-choice-container')) {
            document.querySelectorAll('.table-choice-container').forEach(container => {
                container.classList.remove('active');
            });
        }
    });
}

            


        // Status button management
        let selectedRole = null;

        // Initialize all status buttons
        function initializeStatusButtons() {
            // Role selection in signup
            const roleStatusBtn = document.getElementById('role-status-button');
            const roleContainer = document.getElementById('role-status-container');

            roleStatusBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                roleContainer.classList.toggle('active');
            });

            document.querySelectorAll('#role-options-menu .status-option').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const status = opt.getAttribute('data-status');
                    const text = opt.textContent;

                    // If clicking the same status  unfill
                    if (selectedRole === status) {
                        roleStatusBtn.className = 'status-bubbles';
                        roleStatusBtn.querySelector('.text').textContent = 'Select Role';
                        selectedRole = null;
                    } 
                    else {
                        // Fill with new color
                        roleStatusBtn.className = 'status-bubbles ' + status + ' filled';
                        roleStatusBtn.querySelector('.text').textContent = text;
                        selectedRole = status;
                    }

                    // Close dropdown
                    roleContainer.classList.remove('active');
                });
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.status-container')) {
                    document.querySelectorAll('.status-container').forEach(container => {
                        container.classList.remove('active');
                    });
                }
            });
        }

        // Utility Functions
        function generateId(prefix) {
            if (prefix === 'inv') {
                const count = (window.invoices ? window.invoices.length : 0) + 1;
                // Pad with zeros to maintain 4 digits
                return "UAE-#" + count.toString().padStart(4, '0');
            }
            // Keep original logic for users/expenses
            return prefix + Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        function getCurrentDateTime() {
            const now = new Date();
            return {
                date: now.toISOString().split('T')[0],
                time: now.toTimeString().split(' ')[0].substr(0, 5)
            };
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
 function getPickupStatusClass(status) {
            switch(status) {
                case 'pickup confirmed': return 'status-paid';
                case 'canceled': return 'status-unpaid';
                default: return 'status-unassigned';
            }
        }

        function getPickupStatusText(status) {
            switch(status) {
                case 'pickup confirmed': return 'Confirmed';
                case 'canceled': return 'Canceled';
                default: return 'Pending';
            }
        }
        function hideAllSections() {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('admin-dashboard').classList.remove('active');
            document.getElementById('passenger-dashboard').classList.remove('active');
            document.getElementById('driver-dashboard').classList.remove('active');
        }

        // Authentication Functions
        function switchAuthTab(tab) {
            const loginForm = document.getElementById('login-form');
            const signinForm = document.getElementById('signin-form');
            const tabs = document.querySelectorAll('.auth-tab');
            
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                signinForm.classList.add('hidden');
                tabs[0].classList.add('active');
            } else {
                loginForm.classList.add('hidden');
                signinForm.classList.remove('hidden');
                tabs[1].classList.add('active');
            }
        }

function login() {
    showLoader();
    
    setTimeout(() => {
        // Maintenance check (12AM - 1AM)
        const now = new Date();
        if (now.getHours() === 0) { 
            showNotification('System is under maintenance. Login allowed after 1:00 AM.', 'error');
            hideLoader();
            return;
        }

        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value.trim();
        
        if (!username || !password) {
            showNotification('Please enter both username and password', 'error');
            hideLoader();
            return;
        }
        
        const user = window.users.find(u => u.username === username && u.password === password);
        
        if (user) {
            currentUser = user;
            
            // --- FIX START: Save Login Time to Database ---
            const newLoginTime = new Date().toISOString();
            
            // 1. Update local array immediately for UI responsiveness
            if (!user.loginTimes) user.loginTimes = [];
            user.loginTimes.push(newLoginTime);

            // 2. Send update to Firebase so Admin sees it instantly
            if (window.updateDoc && window.db) {
                window.updateDoc(window.doc(window.db, "users", user.id), { 
                    loginTimes: user.loginTimes 
                }).catch(err => console.error("Failed to update online status:", err));
            }
            // --- FIX END ---

            hideAllSections();
            
            switch (user.role) {
                case 'admin':
                    document.getElementById('admin-dashboard').classList.add('active');
                    document.getElementById('admin-welcome').textContent = `Welcome, ${user.username}`;
                    renderAdminDashboard();
                    break;
                case 'passenger':
                    document.getElementById('passenger-dashboard').classList.add('active');
                    document.getElementById('passenger-welcome').textContent = `Welcome, ${user.username}`;
                    renderPassengerDashboard();
                    break;
                case 'driver':
                    document.getElementById('driver-dashboard').classList.add('active');
                    document.getElementById('driver-welcome').textContent = `Welcome, ${user.username}`;
                    renderDriverDashboard();
                    break;
            }
            
            showNotification(`Welcome back, ${user.username}!`, 'success');
            if (window.checkLoginNotifications) window.checkLoginNotifications();
        } else {
            showNotification('please enter the valid user name or password', 'error');
        }
        
        document.getElementById('login-username').value = '';
        document.getElementById('login-password').value = '';
        hideLoader();
    }, 1500);
}

function signUp() {
    showLoader();
    
    setTimeout(() => {
        const fullname = document.getElementById('signin-fullname').value.trim();
        const email = document.getElementById('signin-email').value.trim();
        const phone = document.getElementById('signin-phone').value.trim();
        const password = document.getElementById('signin-password').value.trim();
        const confirmPassword = document.getElementById('signin-confirm-password').value.trim();
        
        // Validation
        if (!fullname || !email || !phone || !password || !confirmPassword) {
            showNotification('Please fill in all required fields', 'error');
            hideLoader();
            return;
        }
        
        // Validate role selection
        if (!selectedRole) {
            showNotification('Please select a role', 'error');
            hideLoader();
            return;
        }
        
        // Validate email format
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
            showNotification('Please enter a valid email address', 'error');
            hideLoader();
            return;
        }
        
        // Validate phone number (basic validation)
        const phoneRegex = /^[0-9\-\+\s\(\)]{10,}$/;
        if (!phoneRegex.test(phone)) {
            showNotification('Please enter a valid phone number', 'error');
            hideLoader();
            return;
        }
        
        // Validate password strength
        if (password.length < 6) {
            showNotification('Password must be at least 6 characters long', 'error');
            hideLoader();
            return;
        }
        
        // Check if passwords match
        if (password !== confirmPassword) {
            showNotification('Passwords do not match', 'error');
            hideLoader();
            return;
        }
        
        // Check if email already exists
        if (users.find(u => u.email === email)) {
            showNotification('Email already registered', 'error');
            hideLoader();
            return;
        }
        
        // Create new user - use email as username
        const dateTime = getCurrentDateTime();
        const newUser = {
            id: generateId('user'),
            username: email, // Use email as username
            fullname: fullname,
            email: email,
            phone: phone,
            password: password,
            role: selectedRole,
            loginTimes: [],
            logoutTimes: [],
            invoiceHistory: [],
            targets: [],
            assignedInvoices: [],
            registrationDate: dateTime.date,
            registrationTime: dateTime.time
        };

        // Save to Firebase Database
        if (window.setDoc && window.db) {
            window.setDoc(window.doc(window.db, "users", newUser.id), newUser)
            .then(() => {
                console.log("User saved to database");
                window.sendSystemNotification('admin', `New User Signup: ${fullname} (${selectedRole})`);
            })
            .catch((error) => {
                console.error("Error saving user:", error);
                showNotification("Error saving account to database", "error");
            });
        } else {
            // Fallback if DB not ready yet
            users.push(newUser);
        }        
        
        // Send signup notification email (async - don't wait for it)
        setTimeout(() => {
            const emailData = {
                fullname: fullname,
                email: email,
                phone: phone,
                role: selectedRole,
                registrationDate: dateTime.date,
                registrationTime: dateTime.time,
                id: newUser.id
            };
            
            sendSignupNotification(emailData)
                .catch(err => console.log('Email sending failed silently:', err));
        }, 100);
        
        // Clear form
        document.getElementById('signin-fullname').value = '';
        document.getElementById('signin-email').value = '';
        document.getElementById('signin-phone').value = '';
        document.getElementById('signin-password').value = '';
        document.getElementById('signin-confirm-password').value = '';
        selectedRole = null;
        document.getElementById('role-status-button').className = 'status-bubbles';
        document.getElementById('role-status-button').querySelector('.text').textContent = 'Select Role';
        
        showNotification('Account created successfully! Please login.', 'success');
        switchAuthTab('login');
        
        hideLoader();
    }, 1500);
}

function logout() {
    showLoader();
    
    setTimeout(() => {
        if (currentUser) {
            // --- FIX START: Save Logout Time to Database ---
            const newLogoutTime = new Date().toISOString();
            
            // 1. Update local array
            if (!currentUser.logoutTimes) currentUser.logoutTimes = [];
            currentUser.logoutTimes.push(newLogoutTime);

            // 2. Send update to Firebase
            if (window.updateDoc && window.db) {
                window.updateDoc(window.doc(window.db, "users", currentUser.id), { 
                    logoutTimes: currentUser.logoutTimes 
                }).catch(err => console.error("Failed to update offline status:", err));
            }
            // --- FIX END ---

            currentUser = null;
        }
        
        hideAllSections();
        document.getElementById('auth-section').style.display = 'block';
        showNotification('Logged out successfully', 'info');
        
        hideLoader();
    }, 1000);
}

        // Navigation Functions
function showAdminSection(section) {
    // Remove active class from all nav buttons
    document.querySelectorAll('#admin-dashboard .nav-btn').forEach(btn => btn.classList.remove('active'));
    // Add active class to clicked button
    event.target.classList.add('active');
    
    // Hide all sections
    document.querySelectorAll('#admin-dashboard .section').forEach(sec => sec.classList.remove('active'));
    
    // Show selected section
    if (section === 'dashboard') {
        document.getElementById('admin-dashboard-section').classList.add('active');
        renderAdminDashboardSection();
    } else {
        document.getElementById(`admin-${section}`).classList.add('active');
    }
    
    // Reset month filters to current month when switching sections
    const currentMonth = getCurrentMonth();
    if (section === 'dashboard') {
        document.getElementById('dashboard-month-filter').value = currentMonth;
        currentDashboardMonth = currentMonth;
    } else if (section === 'profiles') {
        document.getElementById('profiles-month-filter').value = currentMonth;
        currentProfilesMonth = currentMonth;
    } else if (section === 'cancelled') {
        document.getElementById('cancelled-month-filter').value = currentMonth;
        currentCancelledMonth = currentMonth;
    } else if (section === 'invoices') {
        document.getElementById('invoices-month-filter').value = currentMonth;
        currentInvoicesMonth = currentMonth;
    } else if (section === 'finance') {
        document.getElementById('finance-month-filter').value = currentMonth;
        currentFinanceMonth = currentMonth;
    }
    
    // Render section-specific content
    switch(section) {
        case 'dashboard':
            renderAdminDashboardSection();
            break;
        case 'employees':
            renderEmployeesTable();
            break;
        case 'targets':
            renderAdminTargetsTable();
            break;
        case 'profiles':
            renderAdminProfilesTable();
            break;
        case 'cancelled':
            renderAdminCancelledTable();
            break;
        case 'invoices':
            renderAdminInvoicesTable();
            break;
        case 'finance':
            renderFinanceSection();
            break;
        case 'attendence':
            if (!document.getElementById('attendance-date-filter').value) {
                document.getElementById('attendance-date-filter').value = new Date().toISOString().split('T')[0];
            }
            renderAttendanceSection();
            break;  
            case 'split':
                        renderAdminSplitTable();
                        break;          
    }
}

// Target Assignment Functions
let currentEmployeeFilter = 'all';
let selectedEmployeeForTarget = null;

function renderAdminTargetsTable() {
    const tbody = document.querySelector('#admin-targets-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Get all non-admin employees
    const allEmployees = users.filter(u => u.role !== 'admin');
    
    // Filter employees based on current filter
    let filteredEmployees = allEmployees;
    
    switch(currentEmployeeFilter) {
        case 'assigned':
            filteredEmployees = allEmployees.filter(emp => emp.targets && emp.targets.length > 0);
            break;
        case 'not-assigned':
            filteredEmployees = allEmployees.filter(emp => !emp.targets || emp.targets.length === 0);
            break;
        case 'all':
        default:
            filteredEmployees = allEmployees;
    }
    
    if (filteredEmployees.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px;">
                No employees found
            </td>
        `;
        tbody.appendChild(row);
        return;
    }

    filteredEmployees.forEach(employee => {
        const assignedTargets = employee.targets || [];
        const activeTargets = assignedTargets.filter(target => target.status === 'Active');
        const completedTargets = assignedTargets.filter(target => target.status === 'Completed');
        
        const assignedAmount = activeTargets.reduce((sum, target) => sum + (parseFloat(target.amount) || 0), 0);
        const achievedAmount = completedTargets.reduce((sum, target) => sum + (parseFloat(target.amount) || 0), 0);
        const progressPercent = assignedAmount > 0 ? (achievedAmount / assignedAmount) * 100 : 0;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${employee.username}</td>
            <td>${employee.role.charAt(0).toUpperCase() + employee.role.slice(1)}</td>
            <td>AED ${assignedAmount.toFixed(2)}</td>
            <td>AED ${achievedAmount.toFixed(2)}</td>
            <td>
                <div style="background: var(--border-color); height: 20px; border-radius: 10px; overflow: hidden; position: relative;">
                    <div style="background: linear-gradient(90deg, var(--accent), #764ba2); height: 100%; width: ${progressPercent}%; border-radius: 10px; transition: width 0.5s ease;"></div>
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; color: var(--text-main);">
                        ${progressPercent.toFixed(1)}%
                    </div>
                </div>
            </td>
            <td>
                <button class="bubbles btn-small" onclick="openAssignTargetModal('${employee.id}')">
                    <span class="text">Assign Target</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function searchEmployees() {
    const searchTerm = document.getElementById('employee-search').value.toLowerCase().trim();
    const tbody = document.querySelector('#admin-targets-table tbody');
    tbody.innerHTML = '';

    let filteredEmployees = users.filter(u => u.role !== 'admin');

    if (searchTerm) {
        filteredEmployees = filteredEmployees.filter(emp => 
            emp.username.toLowerCase().includes(searchTerm)
        );
    }

    // Apply current filter
    switch(currentEmployeeFilter) {
        case 'assigned':
            filteredEmployees = filteredEmployees.filter(emp => emp.targets && emp.targets.length > 0);
            break;
        case 'not-assigned':
            filteredEmployees = filteredEmployees.filter(emp => !emp.targets || emp.targets.length === 0);
            break;
    }

    if (filteredEmployees.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px;">
                ${searchTerm ? 'No employees found for "' + searchTerm + '"' : 'No employees found'}
            </td>
        `;
        tbody.appendChild(row);
        return;
    }

    filteredEmployees.forEach(employee => {
        const assignedTargets = employee.targets || [];
        const activeTargets = assignedTargets.filter(target => target.status === 'Active');
        const completedTargets = assignedTargets.filter(target => target.status === 'Completed');
        
        const assignedAmount = activeTargets.reduce((sum, target) => sum + (parseFloat(target.amount) || 0), 0);
        const achievedAmount = completedTargets.reduce((sum, target) => sum + (parseFloat(target.amount) || 0), 0);
        const progressPercent = assignedAmount > 0 ? (achievedAmount / assignedAmount) * 100 : 0;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${employee.username}</td>
            <td>${employee.role.charAt(0).toUpperCase() + employee.role.slice(1)}</td>
            <td>AED ${assignedAmount.toFixed(2)}</td>
            <td>AED ${achievedAmount.toFixed(2)}</td>
            <td>
                <div style="background: var(--border-color); height: 20px; border-radius: 10px; overflow: hidden; position: relative;">
                    <div style="background: linear-gradient(90deg, var(--accent), #764ba2); height: 100%; width: ${progressPercent}%; border-radius: 10px; transition: width 0.5s ease;"></div>
                    <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; color: var(--text-main);">
                        ${progressPercent.toFixed(1)}%
                    </div>
                </div>
            </td>
            <td>
                <button class="bubbles btn-small" onclick="openAssignTargetModal('${employee.id}')">
                    <span class="text">Assign Target</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}
function updateEmployeeMonthlyGross() {
    if (!currentUser || currentUser.role === 'admin') return;
    
    const userTargets = currentUser.targets || [];
    const activeTargets = userTargets.filter(target => target.status === 'Active');
    const completedTargets = userTargets.filter(target => target.status === 'Completed');
    
    const assignedAmount = activeTargets.reduce((sum, target) => sum + (parseFloat(target.amount) || 0), 0);
    const achievedAmount = completedTargets.reduce((sum, target) => sum + (parseFloat(target.amount) || 0), 0);
    
    // Update the monthly gross section based on user role
    if (currentUser.role === 'passenger') {
        document.getElementById('monthly-target').textContent = `AED ${assignedAmount.toFixed(2)}`;
        document.getElementById('monthly-achieved').textContent = `AED ${achievedAmount.toFixed(2)}`;
    } else if (currentUser.role === 'driver') {
        document.getElementById('driver-monthly-target').textContent = `AED ${assignedAmount.toFixed(2)}`;
        document.getElementById('driver-monthly-achievement').textContent = `AED ${achievedAmount.toFixed(2)}`;
    }
}
function filterEmployees(filterType) {
    currentEmployeeFilter = filterType;
    
    // Update active button
    document.querySelectorAll('#admin-targets .nav-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Re-apply search and filter
    searchEmployees();
}

function openAssignTargetModal(employeeId) {
    const employee = users.find(u => u.id === employeeId);
    if (!employee) {
        showNotification('Employee not found', 'error');
        return;
    }
    
    selectedEmployeeForTarget = employeeId;
    document.getElementById('target-employee-name').textContent = employee.username;
    
    // Clear form
    document.getElementById('target-amount-input').value = '';
    
    // Set default deadline to 30 days from now
    const defaultDeadline = new Date();
    defaultDeadline.setDate(defaultDeadline.getDate() + 30);
    document.getElementById('target-deadline').value = defaultDeadline.toISOString().split('T')[0];
    
    // Show modal
    document.getElementById('assign-target-modal').style.display = 'block';
}

function closeAssignTargetModal() {
    document.getElementById('assign-target-modal').style.display = 'none';
    selectedEmployeeForTarget = null;
    
    // Clear form fields
    document.getElementById('target-amount-input').value = '';
    document.getElementById('target-deadline').value = '';
}
function debugTargetAmountElement() {
    const element = document.getElementById('target-amount');
    console.log('Full element details:', element);
    console.log('Element tag name:', element?.tagName);
    console.log('Element outer HTML:', element?.outerHTML);
    console.log('Element inner HTML:', element?.innerHTML);
    
    // Check if it's inside another container
    const parent = element?.parentElement;
    console.log('Parent element:', parent);
    console.log('Parent HTML:', parent?.outerHTML);
}
function assignTargetToEmployee() {
    if (!selectedEmployeeForTarget) {
        showNotification('No employee selected', 'error'); return;
    }

    const amountValue = document.getElementById('target-amount-input').value.trim();
    const deadlineValue = document.getElementById('target-deadline').value;

    if (!amountValue || !deadlineValue) {
        showNotification('Please fill all fields', 'error'); return;
    }

    const employee = users.find(u => u.id === selectedEmployeeForTarget);
    if (!employee) return;

    const newTarget = {
        id: generateId('target'),
        amount: parseFloat(amountValue),
        deadline: deadlineValue,
        status: 'Active',
        assignedDate: getCurrentDateTime().date,
        assignedBy: currentUser.id,
        achievedAmount: 0
    };

    // SAVE TO DATABASE
    if (window.updateDoc && window.db) {
        let currentTargets = employee.targets || [];
        currentTargets.push(newTarget);
        window.updateDoc(window.doc(window.db, "users", employee.id), { targets: currentTargets });
        window.sendSystemNotification(employee.id, `Admin assigned you a new target: AED ${amountValue}`);
    }

    closeAssignTargetModal();
    showNotification(`Target assigned to ${employee.username}`, 'success');
}

function showPassengerSection(section) {
    // 1. Remove active class from all buttons
    document.querySelectorAll('#passenger-dashboard .nav-btn').forEach(btn => btn.classList.remove('active'));
    
    // 2. Add active class to the correct button safely
    // If triggered by click, use event.target
    if (window.event && window.event.target && window.event.target.classList.contains('nav-btn')) {
        window.event.target.classList.add('active');
    } else {
        // If triggered by code (login), find the button manually
        const targetBtn = document.querySelector(`#passenger-dashboard .nav-btn[onclick*="'${section}'"]`);
        if (targetBtn) targetBtn.classList.add('active');
    }
    
    // 3. Hide all sections
    document.querySelectorAll('#passenger-dashboard .section').forEach(sec => sec.classList.remove('active'));
    
    // 4. Show selected section
    if (section === 'dashboard') {
        document.getElementById('passenger-dashboard-section').classList.add('active');
        renderPassengerDashboardSection();
    } else {
        const targetSection = document.getElementById(`passenger-${section}`);
        if (targetSection) targetSection.classList.add('active');
    }
    
    // 5. Render specific content
    switch(section) {
        case 'dashboard':
            renderPassengerDashboardSection();
            break;
        case 'monthly-gross':
            renderMonthlyGrossSection();
            break;
        case 'profiles':
            renderPassengerProfilesTable();
            break;
        case 'profile':
            renderPassengerTargetsTable();
            break;
        case 'settings':
            renderPassengerSettings();
            break;
    }
}

function showDriverSection(section) {
    document.querySelectorAll('#driver-dashboard .nav-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    document.querySelectorAll('#driver-dashboard .section').forEach(sec => sec.classList.remove('active'));
    
    // Show selected section
    if (section === 'dashboard') {
        document.getElementById('driver-dashboard-section').classList.add('active');
        renderDriverDashboardSection();
    } else {
        document.getElementById(`driver-${section}`).classList.add('active');
    }
    
    // Render section-specific content
    switch(section) {
        case 'dashboard':
            renderDriverDashboardSection();
            break;
        case 'home':
            updateDriverStats();
            break;
        case 'monthly-gross':
            renderDriverMonthlyGross(); // Ensure this is called
            break;
        case 'invoices':
            renderDriverInvoicesTable();
            break;
        case 'drivers':
            renderDriversTable();
            break;
        case 'earnings':
            renderDriverEarnings();
            break;
        case 'settings':
            renderDriverSettings();
            break;
    }
}
function populatePassengerAgentDropdown() {
    const container = document.getElementById('passenger-agent-options');
    if (!container) return;
    
    container.innerHTML = '';
    
    // Filter for users with role 'passenger'
    const passengerAgents = users.filter(u => u.role === 'passenger');
    
    passengerAgents.forEach(agent => {
        const div = document.createElement('div');
        div.className = 'choice-option';
        // Use Full name, fallback to username
        div.textContent = agent.fullname || agent.username; 
        div.setAttribute('data-value', agent.fullname || agent.username);
        
        // Add click event manually since these are dynamic
        div.addEventListener('click', function(e) {
            e.stopPropagation();
            const box = document.getElementById('passenger-agent-choice');
            box.querySelector('span:first-child').textContent = this.textContent;
            box.classList.add('selected');
            document.getElementById('passenger-agent-container').classList.remove('active');
        });
        
        container.appendChild(div);
    });
}
        // Password Change Function
        function changePassword(userType) {
            showLoader();
            
            setTimeout(() => {
                let newPasswordId;
                switch(userType) {
                    case 'admin':
                        newPasswordId = 'admin-new-password';
                        break;
                    case 'passenger':
                        newPasswordId = 'passenger-new-password';
                        break;
                    case 'driver':
                        newPasswordId = 'driver-new-password';
                        break;
                }
                
                const newPassword = document.getElementById(newPasswordId).value.trim();
                
                if (!newPassword) {
                    showNotification('Please enter a new password', 'error');
                    hideLoader();
                    return;
                }
                
                if (newPassword.length < 6) {
                    showNotification('Password must be at least 6 characters long', 'error');
                    hideLoader();
                    return;
                }
                
                currentUser.password = newPassword;
                document.getElementById(newPasswordId).value = '';
                showNotification('Password updated successfully', 'success');
                
                hideLoader();
            }, 1000);
        }

        // Dashboard Rendering Functions
                function renderAdminDashboard() {
            renderAdminDashboardSection(); // This will render the dashboard table
            renderAdminInvoicesTable();
            renderEmployeesTable();
            renderFinanceSection();
        }

        function renderAdminDashboard() {
    const tbody = document.querySelector('#admin-dashboard-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Get all profiles (invoices)
    const allProfiles = invoices;
    
    if (allProfiles.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px;">
                No passenger profiles found
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    // Sort by date (newest first)
    const sortedProfiles = sortInvoicesByDate(allProfiles);
    
    sortedProfiles.forEach(profile => {
        const driver = profile.driverId ? users.find(u => u.id === profile.driverId) : null;
        const passenger = users.find(u => u.id === profile.passengerId);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${profile.passengerName || 'N/A'}</td>
            <td>${profile.passengerAgent || (passenger ? passenger.username : 'N/A')}</td>
            <td>AED ${profile.totalBudget.toFixed(2)}</td>
            <td>${driver ? driver.username : 'Not Assigned'}</td>
            <td>
                <span class="status-badge ${getPickupStatusClass(profile.pickupStatus)}">
                    ${getPickupStatusText(profile.pickupStatus)}
                </span>
            </td>
            <td>
                <button class="bubbles btn-small" onclick="viewInvoiceDetails('${profile.id}')">
                    <span class="text">View Profile</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function renderPassengerDashboard() {
    // Show the dashboard section by default
    showPassengerSection('dashboard');
    updatePassengerStats();
    renderMonthlyGrossSection(); // Add this line
    renderPassengerProfilesTable();
    renderPassengerTargetsTable();
    renderPassengerSettings();
    hideLoader();
}

function renderDriverDashboard() {
    renderDriverDashboardSection();
    updateDriverStats();
    renderDriverInvoicesTable();
    renderDriverEarnings();
    renderDriverSettings();
    
}

        // Admin Dashboard Functions
window.filterEmployeesByRole = function(role) {
    currentEmployeeRoleFilter = role;
    
    // Update active button UI
    const buttons = document.querySelectorAll('#admin-employees .nav-btn');
    buttons.forEach(btn => {
        if(btn.getAttribute('onclick').includes(`'${role}'`)) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    
    renderEmployeesTable();
};

function renderEmployeesTable() {
    const tbody = document.querySelector('#employees-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    // Filter employees by Role
    let filteredUsers = window.users.filter(u => u.role !== 'admin');

    if (currentEmployeeRoleFilter !== 'all') {
        filteredUsers = filteredUsers.filter(u => u.role === currentEmployeeRoleFilter);
    }

    if (filteredUsers.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align: center; padding: 20px;">No employees found in this category.</td></tr>`;
        return;
    }

    filteredUsers.forEach(user => {
        const workingHours = calculateWorkingHours(user.id);
        const earnings = calculateEmployeeEarnings(user.id, 'total');

        const logins = user.loginTimes || [];
        const logouts = user.logoutTimes || [];
        const lastLogin = logins.length > 0 ? logins[logins.length - 1] : "1970-01-01";
        const lastLogout = logouts.length > 0 ? logouts[logouts.length - 1] : "1970-01-01";
        const isOnline = lastLogin > lastLogout;

        const displayName = user.fullname || user.username;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${displayName}</td> 
            <td>${user.username}</td>
            <td>${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</td>
            <td>${workingHours.toFixed(1)} hours</td>
            <td>AED ${earnings.toFixed(2)}</td>
            <td>
                <span class="status-badge ${isOnline ? 'status-paid' : 'status-unpaid'}">
                    ${isOnline ? 'Online' : 'Offline'}
                </span>
            </td>
        `;
        tbody.appendChild(row);
    });
}
function renderAdminDashboardSection() {
    const tbody = document.querySelector('#admin-dashboard-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Get all profiles (invoices)
    const allProfiles = invoices;
    
    if (allProfiles.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px;">
                No passenger profiles found
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    // Sort by date (newest first)
    const sortedProfiles = sortInvoicesByDate(allProfiles);
    
    sortedProfiles.forEach(profile => {
        const driver = profile.driverId ? users.find(u => u.id === profile.driverId) : null;
        const passenger = users.find(u => u.id === profile.passengerId);
        
        // Driver assignment dropdown
        // Driver assignment with table choice box
const availableDrivers = users.filter(user => user.role === 'driver');
driverAssignment = `
    <div class="table-choice-container" id="dashboard-driver-container-${profile.id}">
        <div class="table-choice-box ${profile.driverId ? 'selected' : ''}" id="dashboard-driver-choice-${profile.id}">
            <span>${profile.driverAgent || 'Not Assigned Yet'}</span>
            <span></span>
        </div>
        <div class="table-choice-options">
        ${availableDrivers.map(driver => 
            `<div class="table-choice-option" data-value="${driver.id}">${driver.fullname || driver.username}</div>`
        ).join('')}
            ${profile.driverId ? `<div class="table-choice-option" data-value="unassign">Unassign Driver</div>` : ''}
        </div>
    </div>
`;
        
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${profile.passengerName || 'N/A'}</td>
            <td>${profile.passengerAgent || (passenger ? passenger.username : 'N/A')}</td>
            <td>AED ${profile.totalBudget.toFixed(2)}</td>
            <td>${driverAssignment}</td>
            <td>
                <span class="status-badge ${getPickupStatusClass(profile.pickupStatus)}">
                    ${getPickupStatusText(profile.pickupStatus)}
                </span>
            </td>
            <td>
    <div class="driver-actions">
        <button class="bubbles btn-small btn-edit" onclick="editProfile('${profile.id}')">
            <span class="text">Edit</span>
        </button>
        <button class="bubbles btn-small" onclick="viewInvoiceDetails('${profile.id}')">
            <span class="text">View</span>
        </button>
    </div>
</td>
        `;
        tbody.appendChild(row);
    });
}
function renderAdminProfilesTable() {
    const tbody = document.querySelector('#admin-profiles-table tbody');
    tbody.innerHTML = '';
    
    // Filter profiles that are not yet confirmed or canceled
    const pendingProfiles = invoices.filter(inv => inv.pickupStatus === 'no status yet' || !inv.pickupStatus);
    
    if (pendingProfiles.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px;">
                No pending passenger profiles found
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    // Sort by date (newest first)
    const sortedProfiles = sortInvoicesByDate(pendingProfiles);
    
    // Get all available drivers
    const availableDrivers = users.filter(user => user.role === 'driver');
    
    sortedProfiles.forEach(profile => {
        // Initialize pickupStatus if not exists
        if (!profile.pickupStatus) {
            profile.pickupStatus = 'no status yet';
        }
        
        // Determine display text for pickup status
        let pickupStatusText = 'Not Yet';
        if (profile.pickupStatus === 'pickup confirmed') pickupStatusText = 'Pickup Confirmed';
        else if (profile.pickupStatus === 'canceled') pickupStatusText = 'Canceled';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${profile.passengerName || 'N/A'}</td>
            <td>${profile.passengerAgent || 'N/A'}</td>
            <td>AED ${profile.totalBudget.toFixed(2)}</td>
            <td>
                <div class="table-choice-container" id="driver-agent-container-${profile.id}">
                    <div class="table-choice-box ${profile.driverAgent ? 'selected' : ''}" id="driver-agent-choice-${profile.id}">
                        <span>${profile.driverAgent || 'Not Assigned Yet'}</span>
                        <span></span>
                    </div>
                    <div class="table-choice-options">
                        ${availableDrivers.map(driver => 
                            `<div class="table-choice-option" data-value="${driver.id}">${driver.username}</div>`
                        ).join('')}
                    </div>
                </div>
            </td>
            <td>
                <div class="table-choice-container" id="pickup-status-container-${profile.id}">
                    <div class="table-choice-box ${profile.pickupStatus !== 'no status yet' ? 'selected' : ''}" id="pickup-status-choice-${profile.id}">
                        <span>${pickupStatusText}</span>
                        <span></span>
                    </div>
                    <div class="table-choice-options">
                        <div class="table-choice-option" data-value="no status yet">Not Yet</div>
                        <div class="table-choice-option" data-value="pickup confirmed">Pickup Confirmed</div>
                        <div class="table-choice-option" data-value="canceled">Canceled</div>
                    </div>
                </div>
            </td>
            <td>
                <button class="bubbles btn-small" onclick="viewInvoiceDetails('${profile.id}')">
                    <span class="text">View Profile</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Initialize admin table choice boxes after rendering
    initializeAdminTableChoiceBoxes();
}
function renderAdminCancelledTable() {
    const tbody = document.querySelector('#admin-cancelled-table tbody');
    tbody.innerHTML = '';
    
    // Filter profiles that are cancelled - be more specific
    const cancelledProfiles = invoices.filter(inv => inv.pickupStatus === 'canceled');
    
    console.log('Cancelled profiles found:', cancelledProfiles.length); // Debug log
    
    // Filter by month - use cancelledDate if available, otherwise use date
    const filteredProfiles = filterByMonth(cancelledProfiles, currentCancelledMonth, 'cancelledDate');
    
    if (filteredProfiles.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px;">
                No cancelled passenger profiles found for selected month
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    // Sort by date (newest first)
    const sortedProfiles = sortInvoicesByDate(filteredProfiles);
    
    sortedProfiles.forEach(profile => {
        const driver = profile.driverId ? users.find(u => u.id === profile.driverId) : null;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${profile.id}</td>
            <td>${profile.passengerAgent || 'N/A'}</td>
            <td>AED ${profile.totalBudget.toFixed(2)}</td>
            <td>${driver ? driver.username : 'Not Assigned'}</td>
            <td>${profile.cancelledDate || profile.date}</td>
            <td>
                <button class="bubbles btn-small" onclick="viewInvoiceDetails('${profile.id}')">
                    <span class="text">View Profile</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}
function assignDriverAgent(profileId, driverId) {
    const profile = invoices.find(inv => inv.id === profileId);
    const driver = users.find(u => u.id === driverId);
    if (!profile || !driver) return;

    // SAVE TO DATABASE
    if (window.updateDoc && window.db) {
        window.updateDoc(window.doc(window.db, "invoices", profileId), {
            driverId: driverId,
            // Use Full Name if available, else username
            driverAgent: driver.fullname || driver.username 
        });
        showNotification(`Driver assigned to ${profileId}`, 'success');
        window.sendSystemNotification(driverId, `You have been assigned to profile/invoice #${profileId}`);
    }
}

function updatePickupStatus(profileId, newStatus) {
    const profile = invoices.find(inv => inv.id === profileId);
    if (!profile) return;

    let updates = { pickupStatus: newStatus };
    
    // Auto-update other fields based on status logic
    if (newStatus === 'canceled') {
        updates.cancelledDate = getCurrentDateTime().date;
        updates.paymentStatus = 'cancelled';
    }
    if (newStatus === 'pickup confirmed') {
        updates.paymentStatus = 'unpaid';
    }

    // SAVE TO DATABASE
    if (window.updateDoc && window.db) {
        window.updateDoc(window.doc(window.db, "invoices", profileId), updates);
        showNotification(`Status updated to ${newStatus}`, 'success');
    }
}

let currentEditingProfileId = null;

function editProfile(profileId) {
    showLoader();
    
    setTimeout(() => {
        const profile = invoices.find(inv => inv.id === profileId);
        if (!profile) {
            showNotification('Profile not found', 'error');
            hideLoader();
            return;
        }
        
        currentEditingProfileId = profileId;
        
        // Populate the edit modal
        document.getElementById('edit-profile-id').textContent = `Profile #${profile.id}`;
        document.getElementById('edit-total-budget').value = profile.totalBudget;
        document.getElementById('edit-service-charges').value = profile.serviceCharges;
        
        // Calculate and show initial values
        calculateEditBudget();
        
        // Show modal
        document.getElementById('edit-budget-modal').style.display = 'block';
        
        hideLoader();
    }, 500);
}

function closeEditBudgetModal() {
    document.getElementById('edit-budget-modal').style.display = 'none';
    currentEditingProfileId = null;
    
    // Clear form
    document.getElementById('edit-total-budget').value = '';
    document.getElementById('edit-service-charges').value = '';
    document.getElementById('edit-calculated-results').style.display = 'none';
}

function calculateEditBudget() {
    const totalBudget = parseFloat(document.getElementById('edit-total-budget').value);
    const serviceCharges = parseFloat(document.getElementById('edit-service-charges').value);
    
    if (isNaN(totalBudget) || isNaN(serviceCharges)) {
        document.getElementById('edit-calculated-results').style.display = 'none';
        return;
    }
    
    if (totalBudget <= serviceCharges) {
        document.getElementById('edit-calculated-results').style.display = 'none';
        return;
    }
    
    const transportAmount = totalBudget - serviceCharges;
    
    // Get the profile to calculate daily budget
    const profile = invoices.find(inv => inv.id === currentEditingProfileId);
    if (profile) {
        const monthlyDays = profile.monthlyDays || (profile.daysPerWeek * 4);
        const dailyBudget = transportAmount / monthlyDays;
        
        document.getElementById('edit-transport-amount-result').textContent = transportAmount.toFixed(2);
        document.getElementById('edit-daily-budget-result').textContent = dailyBudget.toFixed(2);
        document.getElementById('edit-calculated-results').style.display = 'block';
    }
}
function updateBudget() {
    showLoader();
    setTimeout(() => {
        if (!currentEditingProfileId) { hideLoader(); return; }

        const profile = invoices.find(inv => inv.id === currentEditingProfileId);
        
        // 1. Capture the Old Budget
        const oldBudget = profile.totalBudget;

        const newTotalBudget = parseFloat(document.getElementById('edit-total-budget').value);
        const newServiceCharges = parseFloat(document.getElementById('edit-service-charges').value);

        if (isNaN(newTotalBudget) || isNaN(newServiceCharges)) {
            showNotification('Invalid values', 'error'); hideLoader(); return;
        }

        const transportAmount = newTotalBudget - newServiceCharges;
        const monthlyDays = profile.monthlyDays || (profile.daysPerWeek * 4);
        const dailyBudget = transportAmount / monthlyDays;

        // SAVE TO DATABASE
        if (window.updateDoc && window.db) {
            window.updateDoc(window.doc(window.db, "invoices", profile.id), {
                totalBudget: newTotalBudget,
                serviceCharges: newServiceCharges,
                transportAmount: transportAmount,
                dailyBudget: dailyBudget
            });

            // --- NEW NOTIFICATION LOGIC START ---
            const notifMessage = `Admin changed your profile of the passenger ${profile.passengerName} from budget AED ${oldBudget.toFixed(2)} to budget AED ${newTotalBudget.toFixed(2)}`;

            // 1. Notify the Creator (Passenger Agent)
            if (profile.passengerId) {
                window.sendSystemNotification(profile.passengerId, notifMessage);
            }

            // 2. Notify the Driver (if assigned)
            if (profile.driverId) {
                window.sendSystemNotification(profile.driverId, notifMessage);
            }
            // --- NEW NOTIFICATION LOGIC END ---
        }

        closeEditBudgetModal();
        showNotification('Budget updated successfully', 'success');
        hideLoader();
    }, 1000);
}

function refreshAllTables() {
    // Refresh admin tables if admin dashboard is active
    if (document.getElementById('admin-dashboard').classList.contains('active')) {
        renderAdminDashboardSection();
        renderAdminProfilesTable();
        renderAdminCancelledTable();
        renderAdminInvoicesTable();
        renderFinanceSection();
        renderAdminTargetsTable(); // Ensure targets table refreshes
        renderEmployeesTable();    // Ensure employees table refreshes
    }
    
    // Refresh passenger tables if passenger dashboard is active
    if (document.getElementById('passenger-dashboard').classList.contains('active')) {
        renderPassengerDashboardSection();
        renderPassengerProfilesTable();
        updatePassengerStats();
        renderPassengerTargetsTable(); // Ensure targets refresh
        renderMonthlyGrossSection();   // Ensure monthly gross refreshes
    }
    
    // Refresh driver tables if driver dashboard is active
    if (document.getElementById('driver-dashboard').classList.contains('active')) {
        renderDriverDashboardSection();
        renderDriverInvoicesTable();
        renderDriverEarnings();
        renderDriverTargetsTable(); // New: Updates the targets table
        renderDriverMonthlyGross(); // New: Updates the monthly gross section
        renderDriversTable();       // Ensure drivers list refreshes
        updateDriverStats();        // Ensure top stats refresh
    }
}
function renderAdminInvoicesTable() {
    const tbody = document.querySelector('#admin-invoices-table tbody');
    tbody.innerHTML = '';
    
    // Filter invoices that are confirmed pickups
    const confirmedInvoices = invoices.filter(inv => inv.pickupStatus === 'pickup confirmed');
    
    // Filter based on current filter
    let filteredInvoices = confirmedInvoices;
    
    switch(currentAdminFilter) {
        case 'unpaid':
            filteredInvoices = confirmedInvoices.filter(inv => inv.paymentStatus === 'unpaid');
            break;
        case 'paid':
            filteredInvoices = confirmedInvoices.filter(inv => inv.paymentStatus === 'paid');
            break;
        case 'all':
        default:
            filteredInvoices = confirmedInvoices;
    }
    
    if (filteredInvoices.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="7" style="text-align: center; padding: 20px;">
                No invoices found
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    // Sort by date (newest first)
    filteredInvoices = sortInvoicesByDate(filteredInvoices);
    
    filteredInvoices.forEach(invoice => {
        // Calculate driver side payment (10% of remaining budget after service charges)
        const remainingBudget = invoice.totalBudget - invoice.serviceCharges;
        const driverSidePayment = remainingBudget * 0.10;
        
        // Payment status
        const paymentStatus = invoice.paymentStatus || 'unpaid';
        const paymentStatusClass = paymentStatus === 'paid' ? 'status-paid' : 'status-unpaid';
        const paymentStatusText = paymentStatus === 'paid' ? 'Paid' : 'Not Yet';
        
        // Service charges payment status
        const serviceChargesStatus = invoice.serviceChargesPaid ? 'Paid' : 'Not Yet';
        const serviceChargesStatusClass = invoice.serviceChargesPaid ? 'status-paid' : 'status-unpaid';
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${invoice.passengerAgent || 'N/A'}</td>
            <td>AED ${(invoice.driverCharges || 0).toFixed(2)}</td>
            <td>AED ${invoice.serviceCharges.toFixed(2)}</td>
            <td>
                <div class="table-choice-container" id="payment-status-container-${invoice.id}">
                    <div class="table-choice-box ${paymentStatusClass} ${paymentStatus === 'paid' ? 'selected' : ''}" id="payment-status-choice-${invoice.id}">
                        <span>${paymentStatusText}</span>
                        <span></span>
                    </div>
                    <div class="table-choice-options">
                        <div class="table-choice-option" data-value="unpaid">Not Yet</div>
                        <div class="table-choice-option" data-value="paid">Paid</div>
                    </div>
                </div>
            </td>
            <td>
                <div class="table-choice-container" id="service-charges-status-container-${invoice.id}">
                    <div class="table-choice-box ${serviceChargesStatusClass} ${invoice.serviceChargesPaid ? 'selected' : ''}" id="service-charges-status-choice-${invoice.id}">
                        <span>${serviceChargesStatus}</span>
                        <span></span>
                    </div>
                    <div class="table-choice-options">
                        <div class="table-choice-option" data-value="unpaid">Not Yet</div>
                        <div class="table-choice-option" data-value="paid">Paid</div>
                    </div>
                </div>
            </td>
            <td>
                <button class="bubbles btn-small" onclick="viewInvoiceDetails('${invoice.id}')">
                    <span class="text">View Profile</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Initialize admin table choice boxes after rendering
    initializeAdminTableChoiceBoxes();
}
        // FIXED: Payment status function with proper updates
async function updatePaymentStatus(invoiceId, newStatus) {
    const invoice = invoices.find(inv => inv.id === invoiceId);
    if (!invoice) return;

    let updates = { paymentStatus: newStatus, status: newStatus };

    if (window.updateDoc && window.db) {
        // --- LOGIC: MARKING AS PAID ---
        if (newStatus === 'paid') {
            const dateTime = getCurrentDateTime();
            
            // Calculate Commission Base (15% of Driver Charges)
            const baseCommission = (invoice.driverCharges || 0) * 0.25;

            // --- SPLIT LOGIC START ---
            let creatorShare = baseCommission;
            let splitShare = 0;

            if (invoice.isSplit && invoice.splitWithId) {
                creatorShare = baseCommission / 2;
                splitShare = baseCommission / 2;
            }
            // --- SPLIT LOGIC END ---

            // A. Give Commission to Creator
            if (invoice.passengerId) {
                await addCommissionToUser(invoice.passengerId, invoice.id, creatorShare, 'driver_payment_commission', dateTime.date);
            }

            // B. Give Commission to Split Agent
            if (invoice.isSplit && invoice.splitWithId) {
                await addCommissionToUser(invoice.splitWithId, invoice.id, splitShare, 'driver_payment_commission', dateTime.date);
            }

            // C. Give Commission to Driver Agent
            if (invoice.driverId) {
                await addCommissionToUser(invoice.driverId, invoice.id, baseCommission, 'driver_payment_commission', dateTime.date);
            }
            
            showNotification('Payment marked paid. Commissions distributed.', 'success');
        }

        // --- LOGIC: MARKING AS UNPAID ---
        if (newStatus === 'unpaid') {
            // Remove commissions from everyone
            removeCommissions(invoiceId, 'driver_payment_commission');
            showNotification('Payment marked unpaid. Commissions reversed.', 'info');
        }

        // Save Invoice Status
        window.updateDoc(window.doc(window.db, "invoices", invoiceId), updates);
    }
}
// Helper to add commission to a specific user
async function addCommissionToUser(userId, invoiceId, amount, type, date) {
    const user = window.users.find(u => u.id === userId);
    if (!user) return;

    const entry = {
        invoiceId: invoiceId,
        amount: amount,
        date: date,
        type: type,
        description: `Commission for invoice ${invoiceId} ${amount < (amount * 2) ? '(Split)' : ''}`
    };

    let currentComms = user.commissionEarnings || [];
    currentComms.push(entry);
    
    // Save to DB
    await window.updateDoc(window.doc(window.db, "users", userId), { commissionEarnings: currentComms });
}

// Helper to remove commissions (Modified to clean up Split Agents too)
function removeCommissions(invoiceId, commissionType) {
    // Iterate through ALL users in the system to find anyone who got money for this invoice
    window.users.forEach(user => {
        if (user.commissionEarnings) {
            const originalLength = user.commissionEarnings.length;
            
            // Filter out the specific commission entry
            const newComms = user.commissionEarnings.filter(c => 
                !(c.invoiceId === invoiceId && c.type === commissionType)
            );

            // If we removed something, update the database for this user
            if (newComms.length < originalLength) {
                if (window.updateDoc && window.db) {
                    window.updateDoc(window.doc(window.db, "users", user.id), { commissionEarnings: newComms });
                    console.log(`Removed commission from ${user.username}`);
                }
            }
        }
    });
}
// Update the updateServiceChargesStatus function
// [Image of split commission logic diagram]
async function updateServiceChargesStatus(invoiceId, newStatus) {
    const invoice = invoices.find(inv => inv.id === invoiceId);
    if (!invoice) { showNotification('Invoice not found', 'error'); return; }

    const wasAlreadyPaid = invoice.serviceChargesPaid;
    // Update local status immediately for UI responsiveness
    invoice.serviceChargesPaid = (newStatus === 'paid');

    // Update UI choice box
    const choiceBox = document.getElementById(`service-charges-status-choice-${invoiceId}`);
    if (choiceBox) {
        const isPaid = newStatus === 'paid';
        choiceBox.querySelector('span:first-child').textContent = isPaid ? 'Paid' : 'Not Yet';
        choiceBox.className = `table-choice-box ${isPaid ? 'status-paid' : 'status-unpaid'} ${isPaid ? 'selected' : ''}`;
    }

    if (window.updateDoc && window.db) {
        // --- LOGIC: MARKING AS PAID ---
        if (newStatus === 'paid' && !wasAlreadyPaid) {
            const dateTime = getCurrentDateTime();
            
            // 1. Add to Admin Finance
            const transaction = {
                invoiceId: invoice.id,
                amount: invoice.serviceCharges,
                date: dateTime.date,
                time: dateTime.time,
                type: 'service_charges',
                description: `Service charges for invoice ${invoice.id}`
            };
            finance.transactions.push(transaction);
            finance.totalPaid += invoice.serviceCharges;

            // 2. Calculate Commission Base (15% of Service Charges)
            let baseCommission = invoice.serviceCharges * 0.25;
            
            // --- SPLIT LOGIC START ---
            let creatorShare = baseCommission;
            let splitShare = 0;

            if (invoice.isSplit && invoice.splitWithId) {
                creatorShare = baseCommission / 2;
                splitShare = baseCommission / 2;
                console.log(`Profile Split! Creator: AED ${creatorShare}, Split Agent: AED ${splitShare}`);
            }
            // --- SPLIT LOGIC END ---

            // A. Give Commission to Creator (Passenger Agent)
            if (invoice.passengerId) {
                await addCommissionToUser(invoice.passengerId, invoice.id, creatorShare, 'service_charges_commission', dateTime.date);
            }

            // B. Give Commission to Split Agent (If Split)
            if (invoice.isSplit && invoice.splitWithId) {
                await addCommissionToUser(invoice.splitWithId, invoice.id, splitShare, 'service_charges_commission', dateTime.date);
            }

            // C. Give Commission to Driver Agent (Full Amount, drivers don't usually split)
            if (invoice.driverId) {
                await addCommissionToUser(invoice.driverId, invoice.id, baseCommission, 'service_charges_commission', dateTime.date);
            }

            showNotification(`Service charges marked paid. Commission distributed.`, 'success');
        } 
        
        // --- LOGIC: MARKING AS UNPAID (REVERSAL) ---
        else if (newStatus === 'unpaid' && wasAlreadyPaid) {
            // Remove from Admin Finance
            const tIndex = finance.transactions.findIndex(t => t.invoiceId === invoiceId && t.type === 'service_charges');
            if (tIndex !== -1) {
                const removed = finance.transactions.splice(tIndex, 1)[0];
                finance.totalPaid -= removed.amount;
            }

            // Remove Commissions from ALL involved users (Creator, Split Agent, Driver)
            removeCommissions(invoiceId, 'service_charges_commission');
            
            showNotification(`Service charges marked unpaid. Commissions reversed.`, 'info');
        }

        // Update Invoice Status in DB
        window.updateDoc(window.doc(window.db, "invoices", invoiceId), {
            serviceChargesPaid: (newStatus === 'paid')
        });
    }

    renderFinanceSection();
    renderSalarySection();
}

// Helper function to remove commissions when payment is reversed
function removeCommissions(invoiceId, commissionType) {
    // Remove commissions from all users for this invoice
    users.forEach(user => {
        if (user.commissionEarnings) {
            const initialLength = user.commissionEarnings.length;
            user.commissionEarnings = user.commissionEarnings.filter(
                commission => !(commission.invoiceId === invoiceId && commission.type === commissionType)
            );
            if (user.commissionEarnings.length < initialLength) {
                console.log(`Removed commissions for user ${user.username}, invoice ${invoiceId}`);
            }
        }
    });
    console.log(`Commissions removed for invoice ${invoiceId}, type: ${commissionType}`);
}

// Update the calculateEmployeeCommission function to use ONLY the new commission system
function calculateEmployeeCommission(employeeId) {
    const employee = users.find(u => u.id === employeeId);
    if (!employee) return 0;
    
    const currentMonth = currentFinanceMonth;
    let totalCommission = 0;
    
    // Calculate ONLY from commission earnings (new system) - REMOVE old calculation
    if (employee.commissionEarnings) {
        const monthCommissions = employee.commissionEarnings.filter(commission => 
            commission.date.startsWith(currentMonth)
        );
        totalCommission = monthCommissions.reduce((sum, commission) => sum + commission.amount, 0);
    }
    
    // REMOVED: The old calculation that was causing double counting for drivers
    // if (employee.role === 'driver') {
    //     const driverTransactions = finance.transactions.filter(t => 
    //         t.driverId === employeeId && 
    //         t.type === 'driver_payment' &&
    //         t.date.startsWith(currentMonth)
    //     );
    //     totalCommission += driverTransactions.reduce((sum, t) => sum + (t.amount * 0.15), 0);
    // }
    
    return totalCommission;
}

// Also check if there's any other function that might be adding commissions
// Add this debug function to check current commissions
function debugCommissions(employeeId) {
    const employee = users.find(u => u.id === employeeId);
    if (employee && employee.commissionEarnings) {
        console.log('Current commissions for', employee.username, ':', employee.commissionEarnings);
    }
}

// Update the updateServiceChargesStatus function with corrected commission logic
function updateServiceChargesStatus(invoiceId, newStatus) {
    const invoice = invoices.find(inv => inv.id === invoiceId);
    
    if (!invoice) {
        showNotification('Invoice not found', 'error');
        return;
    }
    
    const wasAlreadyPaid = invoice.serviceChargesPaid;
    invoice.serviceChargesPaid = (newStatus === 'paid');
    
    // Update UI
    const choiceBox = document.getElementById(`service-charges-status-choice-${invoiceId}`);
    if (choiceBox) {
        const isPaid = newStatus === 'paid';
        choiceBox.querySelector('span:first-child').textContent = isPaid ? 'Paid' : 'Not Yet';
        choiceBox.className = `table-choice-box ${isPaid ? 'status-paid' : 'status-unpaid'} ${isPaid ? 'selected' : ''}`;
    }
    
    if (newStatus === 'paid' && !wasAlreadyPaid) {
        const dateTime = getCurrentDateTime();
        
        // Add transaction
        finance.transactions.push({
            invoiceId: invoice.id,
            amount: invoice.serviceCharges,
            date: dateTime.date,
            time: dateTime.time,
            type: 'service_charges'
        });
        
        finance.totalPaid += invoice.serviceCharges;

        // Calculate commission - 15% of service charges for BOTH employees
        const commissionAmount = invoice.serviceCharges * 0.15;

        // Add commission to passenger employee
        if (invoice.passengerId) {
            const passengerEmployee = users.find(u => u.id === invoice.passengerId);
            if (passengerEmployee) {
                if (!passengerEmployee.commissionEarnings) passengerEmployee.commissionEarnings = [];
                passengerEmployee.commissionEarnings.push({
                    invoiceId: invoice.id,
                    amount: commissionAmount,
                    date: dateTime.date,
                    type: 'service_charges_commission'
                });
            }
        }

        // Add SAME commission to driver
        if (invoice.driverId) {
            const driver = users.find(u => u.id === invoice.driverId);
            if (driver) {
                if (!driver.commissionEarnings) driver.commissionEarnings = [];
                driver.commissionEarnings.push({
                    invoiceId: invoice.id,
                    amount: commissionAmount,
                    date: dateTime.date,
                    type: 'service_charges_commission'
                });
            }
        }
        
        showNotification(`Service charges for invoice ${invoiceId} marked as paid`, 'success');
    } else if (newStatus === 'unpaid' && wasAlreadyPaid) {
        // Remove transaction
        const transactionIndex = finance.transactions.findIndex(t => 
            t.invoiceId === invoiceId && t.type === 'service_charges'
        );
        
        if (transactionIndex !== -1) {
            finance.transactions.splice(transactionIndex, 1)[0];
            finance.totalPaid -= invoice.serviceCharges;
            
            // Remove commissions from both employees
            users.forEach(user => {
                if (user.commissionEarnings) {
                    user.commissionEarnings = user.commissionEarnings.filter(
                        commission => !(commission.invoiceId === invoiceId && commission.type === 'service_charges_commission')
                    );
                }
            });
        }
        
        showNotification(`Service charges for invoice ${invoiceId} marked as unpaid`, 'info');
    }
    
    renderFinanceSection();
    renderSalarySection();
}

// Helper function to remove commissions when payment is reversed
function removeCommissions(invoiceId, commissionType) {
    // Remove commissions from all users for this invoice
    users.forEach(user => {
        if (user.commissionEarnings) {
            user.commissionEarnings = user.commissionEarnings.filter(
                commission => !(commission.invoiceId === invoiceId && commission.type === commissionType)
            );
        }
    });
    console.log(`Commissions removed for invoice ${invoiceId}, type: ${commissionType}`);
}

// Update the calculateEmployeeCommission function to include the new commission system
function calculateEmployeeCommission(employeeId) {
    const employee = users.find(u => u.id === employeeId);
    if (!employee || !employee.commissionEarnings) return 0;
    
    const currentMonth = currentFinanceMonth;
    const monthCommissions = employee.commissionEarnings.filter(commission => 
        commission.date.startsWith(currentMonth)
    );
    
    // REMOVE the old calculation - only use commissionEarnings
    return monthCommissions.reduce((sum, commission) => sum + commission.amount, 0);
}

// Update the updateServiceChargesStatus function with corrected commission logic
function updateServiceChargesStatus(invoiceId, newStatus) {
    const invoice = invoices.find(inv => inv.id === invoiceId);
    
    if (!invoice) {
        showNotification('Invoice not found', 'error');
        return;
    }
    
    // Store old status for comparison
    const wasAlreadyPaid = invoice.serviceChargesPaid;
    
    // Update service charges payment status
    invoice.serviceChargesPaid = (newStatus === 'paid');
    
    // Update the choice box text and styling
    const choiceBox = document.getElementById(`service-charges-status-choice-${invoiceId}`);
    if (choiceBox) {
        const isPaid = newStatus === 'paid';
        choiceBox.querySelector('span:first-child').textContent = isPaid ? 'Paid' : 'Not Yet';
        
        // Update the class for styling
        choiceBox.className = `table-choice-box ${isPaid ? 'status-paid' : 'status-unpaid'} ${isPaid ? 'selected' : ''}`;
    }
    
    if (newStatus === 'paid' && !wasAlreadyPaid) {
        showNotification(`Service charges for invoice ${invoiceId} marked as paid`, 'success');
        
        // Add to finance transactions ONLY if it wasn't already paid
        const dateTime = getCurrentDateTime();
        const transaction = {
            invoiceId: invoice.id,
            amount: invoice.serviceCharges,
            date: dateTime.date,
            time: dateTime.time,
            type: 'service_charges',
            description: `Service charges payment for invoice ${invoice.id}`
        };
        
        finance.transactions.push(transaction);
        finance.totalPaid += invoice.serviceCharges;
        
        // CORRECTED: Add 15% commission of service charges to BOTH passenger employee AND driver
        const commissionAmount = invoice.serviceCharges * 0.15;
        
        // Add commission to passenger employee who created this profile
        if (invoice.passengerId) {
            const passengerEmployee = users.find(u => u.id === invoice.passengerId);
            if (passengerEmployee) {
                if (!passengerEmployee.commissionEarnings) passengerEmployee.commissionEarnings = [];
                passengerEmployee.commissionEarnings.push({
                    invoiceId: invoice.id,
                    amount: commissionAmount,
                    date: dateTime.date,
                    type: 'service_charges_commission',
                    description: `15% commission from service charges for invoice ${invoice.id}`
                });
                console.log('Passenger employee commission added:', commissionAmount);
            }
        }
        
        // Add SAME commission amount to driver assigned to this profile
        if (invoice.driverId) {
            const driver = users.find(u => u.id === invoice.driverId);
            if (driver) {
                if (!driver.commissionEarnings) driver.commissionEarnings = [];
                driver.commissionEarnings.push({
                    invoiceId: invoice.id,
                    amount: commissionAmount, // SAME amount as passenger employee
                    date: dateTime.date,
                    type: 'service_charges_commission',
                    description: `15% commission from service charges for invoice ${invoice.id}`
                });
                console.log('Driver commission added:', commissionAmount);
            }
        }
        
    } else if (newStatus === 'unpaid' && wasAlreadyPaid) {
        showNotification(`Service charges for invoice ${invoiceId} marked as unpaid`, 'info');
        
        // Remove from finance transactions if changing from paid to unpaid
        const transactionIndex = finance.transactions.findIndex(t => 
            t.invoiceId === invoiceId && t.type === 'service_charges'
        );
        
        if (transactionIndex !== -1) {
            const removedTransaction = finance.transactions.splice(transactionIndex, 1)[0];
            finance.totalPaid -= removedTransaction.amount;
            
            // Remove commissions when payment is reversed
            removeCommissions(invoiceId, 'service_charges_commission');
        }
    }
    
    // Refresh the finance section
    renderFinanceSection();
    renderSalarySection();
}

// Helper function to remove commissions when payment is reversed
function removeCommissions(invoiceId, commissionType) {
    // Remove commissions from all users for this invoice
    users.forEach(user => {
        if (user.commissionEarnings) {
            user.commissionEarnings = user.commissionEarnings.filter(
                commission => !(commission.invoiceId === invoiceId && commission.type === commissionType)
            );
        }
    });
    console.log(`Commissions removed for invoice ${invoiceId}, type: ${commissionType}`);
}

// Update the calculateEmployeeCommission function to include the new commission system
 

function updateServiceChargesStatus(invoiceId, newStatus) {
    const invoice = invoices.find(inv => inv.id === invoiceId);
    
    if (!invoice) {
        showNotification('Invoice not found', 'error');
        return;
    }
    
    // Store old status for comparison
    const wasAlreadyPaid = invoice.serviceChargesPaid;
    
    // Update service charges payment status
    invoice.serviceChargesPaid = (newStatus === 'paid');
    
    // Update the choice box text and styling
    const choiceBox = document.getElementById(`service-charges-status-choice-${invoiceId}`);
    if (choiceBox) {
        const isPaid = newStatus === 'paid';
        choiceBox.querySelector('span:first-child').textContent = isPaid ? 'Paid' : 'Not Yet';
        
        // Update the class for styling
        choiceBox.className = `table-choice-box ${isPaid ? 'status-paid' : 'status-unpaid'} ${isPaid ? 'selected' : ''}`;
    }
    
    if (newStatus === 'paid' && !wasAlreadyPaid) {
        showNotification(`Service charges for invoice ${invoiceId} marked as paid`, 'success');
        
        // Add to finance transactions ONLY if it wasn't already paid
        const dateTime = getCurrentDateTime();
        const transaction = {
            invoiceId: invoice.id,
            amount: invoice.serviceCharges,
            date: dateTime.date,
            time: dateTime.time,
            type: 'service_charges',
            description: `Service charges payment for invoice ${invoice.id}`
        };
        
        finance.transactions.push(transaction);
        finance.totalPaid += invoice.serviceCharges;
        
        // NEW: Add 15% commission to BOTH passenger employee AND driver
        const passengerCommission = invoice.serviceCharges * 0.15;
        const driverCommission = invoice.serviceCharges * 0.15;
        
        // Add commission to passenger employee who created this profile
        if (invoice.passengerId) {
            const passengerEmployee = users.find(u => u.id === invoice.passengerId);
            if (passengerEmployee) {
                if (!passengerEmployee.commissionEarnings) passengerEmployee.commissionEarnings = [];
                passengerEmployee.commissionEarnings.push({
                    invoiceId: invoice.id,
                    amount: passengerCommission,
                    date: dateTime.date,
                    type: 'service_charges_commission',
                    description: `15% commission from service charges for invoice ${invoice.id}`
                });
                console.log('Passenger employee commission added:', passengerCommission);
            }
        }
        
        // Add commission to driver assigned to this profile
        if (invoice.driverId) {
            const driver = users.find(u => u.id === invoice.driverId);
            if (driver) {
                if (!driver.commissionEarnings) driver.commissionEarnings = [];
                driver.commissionEarnings.push({
                    invoiceId: invoice.id,
                    amount: driverCommission,
                    date: dateTime.date,
                    type: 'service_charges_commission',
                    description: `15% commission from service charges for invoice ${invoice.id}`
                });
                console.log('Driver commission added:', driverCommission);
            }
        }
        
    } else if (newStatus === 'unpaid' && wasAlreadyPaid) {
        showNotification(`Service charges for invoice ${invoiceId} marked as unpaid`, 'info');
        
        // Remove from finance transactions if changing from paid to unpaid
        const transactionIndex = finance.transactions.findIndex(t => 
            t.invoiceId === invoiceId && t.type === 'service_charges'
        );
        
        if (transactionIndex !== -1) {
            const removedTransaction = finance.transactions.splice(transactionIndex, 1)[0];
            finance.totalPaid -= removedTransaction.amount;
            
            // NEW: Remove commissions when payment is reversed
            removeCommissions(invoiceId, 'service_charges_commission');
        }
    }
    
    // Refresh the finance section
    renderFinanceSection();
    renderSalarySection();
}

        function renderFinanceSection() {
            const today = new Date().toISOString().split('T')[0];
            const thisWeek = getWeekStart(new Date());
            const thisMonth = new Date().toISOString().substr(0, 7);
            
            const dailyEarnings = finance.transactions
                .filter(t => t.date === today)
                .reduce((sum, t) => sum + t.amount, 0);
            
            const weeklyEarnings = finance.transactions
                .filter(t => t.date >= thisWeek)
                .reduce((sum, t) => sum + t.amount, 0);
            
            const monthlyEarnings = finance.transactions
                .filter(t => t.date.startsWith(thisMonth))
                .reduce((sum, t) => sum + t.amount, 0);
            
            document.getElementById('daily-earnings').textContent = `AED ${dailyEarnings.toFixed(2)}`;
            document.getElementById('weekly-earnings').textContent = `AED ${weeklyEarnings.toFixed(2)}`;
            document.getElementById('monthly-earnings').textContent = `AED ${monthlyEarnings.toFixed(2)}`;
            document.getElementById('total-earnings').textContent = `AED ${finance.totalPaid.toFixed(2)}`;
            
            // Render finance table
            const tbody = document.querySelector('#finance-table tbody');
            tbody.innerHTML = '';
            
            finance.transactions.slice().reverse().forEach(transaction => {
                const driver = users.find(u => u.id === transaction.driverId);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.date}</td>
                    <td>${transaction.time}</td>
                    <td>${transaction.invoiceId}</td>
                    <td>AED ${transaction.amount.toFixed(2)}</td>
                    <td>${driver ? driver.username : 'Unknown'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Passenger Dashboard Functions
        function updatePassengerStats() {
            const userInvoices = invoices.filter(inv => inv.passengerId === currentUser.id);
            const userTargets = currentUser.targets || [];
            
            document.getElementById('passenger-invoices-count').textContent = userInvoices.length;
            document.getElementById('passenger-targets-count').textContent = userTargets.length;
        }

        function renderPassengerProfilesTable() {
            const tbody = document.querySelector('#passenger-profiles-table tbody');
            tbody.innerHTML = '';
            
            const userProfiles = invoices.filter(inv => inv.passengerId === currentUser.id);
            
            if (userProfiles.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" style="text-align: center; padding: 20px;">
                        No passenger profiles created yet
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            // Sort by date (newest first)
            const sortedProfiles = sortInvoicesByDate(userProfiles);
            
            sortedProfiles.forEach(profile => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${profile.id}</td>
                    <td>${profile.passengerName || 'N/A'}</td>
                    <td>${profile.passengerPhone || 'N/A'}</td>
                    <td>${profile.date}</td>
                    <td><span class="status-${profile.status}">${profile.status.charAt(0).toUpperCase() + profile.status.slice(1)}</span></td>
                    <td>
                        <button class="bubbles btn-small" onclick="viewProfileDetails('${profile.id}')">
                            <span class="text">View Details</span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function viewProfileDetails(profileId) {
            // Reuse the existing invoice modal to show profile details
            viewInvoiceDetails(profileId);
        }

        function filterPassengerProfiles(filterType) {
            // Update active button
            document.querySelectorAll('#passenger-profiles .nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderPassengerProfilesTable();
        }

        function renderPassengerTargetsTable() {
            const tbody = document.querySelector('#passenger-targets-table tbody');
            tbody.innerHTML = '';
            
            const userTargets = currentUser.targets || [];
            
            // Update profile stats
            const userInvoices = invoices.filter(inv => inv.passengerId === currentUser.id);
            const paidServiceCharges = userInvoices.filter(inv => inv.serviceChargesPaid).length;
            const completedTargets = userTargets.filter(target => target.status === 'Completed').length;
            
            document.getElementById('profile-total-invoices').textContent = userInvoices.length;
            document.getElementById('profile-completed-targets').textContent = completedTargets;
            document.getElementById('profile-service-charges').textContent = `AED ${(userInvoices.filter(inv => inv.serviceChargesPaid).reduce((sum, inv) => sum + inv.serviceCharges, 0)).toFixed(2)}`;
            
            userTargets.forEach(target => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${target.admin}</td>
                    <td>${target.deadline}</td>
                    <td><span class="status-${target.status.toLowerCase()}">${target.status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }
function renderDriverTargetsTable() {
    const tbody = document.querySelector('#driver-targets-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Safety check if user has targets
    const userTargets = currentUser.targets || [];
    
    if (userTargets.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 20px;">No targets assigned yet</td></tr>`;
        return;
    }
    
    // Sort by deadline (newest first)
    userTargets.sort((a, b) => new Date(b.deadline) - new Date(a.deadline));

    userTargets.forEach(target => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>AED ${parseFloat(target.amount).toFixed(2)}</td>
            <td>${target.deadline}</td>
            <td>${target.assignedDate}</td>
            <td><span class="status-badge ${target.status === 'Completed' ? 'status-paid' : 'status-unpaid'}">${target.status}</span></td>
        `;
        tbody.appendChild(row);
    });
}
        function renderPassengerSettings() {
            const userInvoices = invoices.filter(inv => inv.passengerId === currentUser.id);
            const pendingPayments = userInvoices.filter(inv => !inv.serviceChargesPaid).length;
            
            document.getElementById('settings-total-invoices').textContent = userInvoices.length;
            document.getElementById('settings-pending-payments').textContent = pendingPayments;
        }

        // Driver Dashboard Functions
function updateDriverStats() {
    const assignedInvoices = invoices.filter(inv => inv.driverId === currentUser.id);
    const completedJobs = assignedInvoices.filter(inv => inv.paymentStatus === 'paid');
    
    document.getElementById('driver-assigned-count').textContent = assignedInvoices.length;
    document.getElementById('driver-completed-count').textContent = completedJobs.length;
}

    function renderDriverInvoicesTable() {
    const tbody = document.querySelector('#driver-invoices-table tbody');
    tbody.innerHTML = '';
    
    const assignedInvoices = invoices.filter(inv => inv.driverId === currentUser.id);
    
    // Filter invoices based on current filter
    let filteredInvoices = assignedInvoices;
    
    switch(currentDriverFilter) {
        case 'unpaid':
            filteredInvoices = assignedInvoices.filter(inv => inv.status === 'unpaid');
            break;
        case 'paid':
            filteredInvoices = assignedInvoices.filter(inv => inv.status === 'paid');
            break;
        case 'all':
        default:
            filteredInvoices = assignedInvoices;
    }
    
    // Sort by date (newest first)
    filteredInvoices = sortInvoicesByDate(filteredInvoices);
    
    filteredInvoices.forEach(invoice => {
        // Use the correct amount and description
        const amount = invoice.transportAmount || invoice.amount;
        const description = invoice.passengerName ? 
            `${invoice.passengerName} - ${invoice.rideType} ${invoice.rideWay}` : 
            invoice.description;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${invoice.id}</td>
            <td>${invoice.passengerName || 'N/A'}</td>
            <td>AED ${amount.toFixed(2)}</td>
            <td>${description}</td>
            <td><span class="status-${invoice.status}">${invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1)}</span></td>
            <td>
                <button class="bubbles btn-small" onclick="viewInvoiceDetails('${invoice.id}')">
                    <span class="text">View Details</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}
function renderDriverEarnings() {
    const today = new Date().toISOString().split('T')[0];
    const thisWeek = getWeekStart(new Date());
    const thisMonth = new Date().toISOString().substr(0, 7);
    
    const driverTransactions = finance.transactions.filter(t => t.driverId === currentUser.id);
    
    // NEW: Calculate earnings using the new formula (15% of 10% of transport amount)
    const dailyEarnings = driverTransactions
        .filter(t => t.date === today)
        .reduce((sum, t) => {
            // Since transactions store the full 10%, we need to calculate 15% of that
            const fifteenPercentOfTen = t.amount * 0.15;
            return sum + fifteenPercentOfTen;
        }, 0);
    
    const weeklyEarnings = driverTransactions
        .filter(t => t.date >= thisWeek)
        .reduce((sum, t) => {
            const fifteenPercentOfTen = t.amount * 0.15;
            return sum + fifteenPercentOfTen;
        }, 0);
    
    const monthlyEarnings = driverTransactions
        .filter(t => t.date.startsWith(thisMonth))
        .reduce((sum, t) => {
            const fifteenPercentOfTen = t.amount * 0.15;
            return sum + fifteenPercentOfTen;
        }, 0);
    
    const totalEarnings = driverTransactions
        .reduce((sum, t) => {
            const fifteenPercentOfTen = t.amount * 0.15;
            return sum + fifteenPercentOfTen;
        }, 0);
    
    document.getElementById('driver-daily-earnings').textContent = `AED ${dailyEarnings.toFixed(2)}`;
    document.getElementById('driver-weekly-earnings').textContent = `AED ${weeklyEarnings.toFixed(2)}`;
    document.getElementById('driver-monthly-earnings').textContent = `AED ${monthlyEarnings.toFixed(2)}`;
    document.getElementById('driver-total-earnings').textContent = `AED ${totalEarnings.toFixed(2)}`;
}

        function renderDriverSettings() {
            const assignedInvoices = invoices.filter(inv => inv.driverId === currentUser.id);
            const completedJobs = assignedInvoices.filter(inv => inv.status === 'paid');
            const successRate = assignedInvoices.length > 0 ? (completedJobs.length / assignedInvoices.length * 100) : 0;
            
            document.getElementById('driver-total-jobs').textContent = assignedInvoices.length;
            document.getElementById('driver-success-rate').textContent = `${successRate.toFixed(1)}%`;
        }
        // Passenger Dashboard Functions
// Passenger Dashboard Functions - EXACT COPY OF ADMIN DASHBOARD
function renderPassengerDashboardSection() {
    const tbody = document.querySelector('#passenger-dashboard-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Get ALL profiles (like admin dashboard)
    const allProfiles = invoices;
    
    if (allProfiles.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px;">
                No passenger profiles found
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    // Sort by date (newest first)
    const sortedProfiles = sortInvoicesByDate(allProfiles);
    
    sortedProfiles.forEach(profile => {
        const driver = profile.driverId ? users.find(u => u.id === profile.driverId) : null;
        const passenger = users.find(u => u.id === profile.passengerId);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${profile.id}</td>
            <td>${profile.passengerAgent || (passenger ? passenger.username : 'N/A')}</td>
            <td>AED ${profile.totalBudget.toFixed(2)}</td>
            <td>${driver ? driver.username : 'Not Assigned'}</td>
            <td>
                <span class="status-badge ${getPickupStatusClass(profile.pickupStatus)}">
                    ${getPickupStatusText(profile.pickupStatus)}
                </span>
            </td>
            <td>
                <div class="driver-actions">
                    <button class="bubbles btn-small" onclick="viewInvoiceDetails('${profile.id}')">
                        <span class="text">View</span>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}



function updatePassengerDashboardStats() {
    const userProfiles = invoices.filter(inv => inv.passengerId === currentUser.id);
    const activeProfiles = userProfiles.filter(inv => inv.pickupStatus === 'pickup confirmed');
    const pendingProfiles = userProfiles.filter(inv => inv.pickupStatus === 'no status yet');
    const totalRevenue = userProfiles.reduce((sum, inv) => sum + inv.serviceCharges, 0);

    document.getElementById('passenger-total-profiles').textContent = userProfiles.length;
    document.getElementById('passenger-active-profiles').textContent = activeProfiles.length;
    document.getElementById('passenger-pending-profiles').textContent = pendingProfiles.length;
    document.getElementById('passenger-total-revenue').textContent = `AED ${totalRevenue.toFixed(2)}`;
}

function renderPassengerDashboardTable() {
    const tbody = document.querySelector('#passenger-dashboard-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const userProfiles = invoices.filter(inv => inv.passengerId === currentUser.id);
    
    if (userProfiles.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="7" style="text-align: center; padding: 20px;">
                No passenger profiles created yet
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    // Sort by date (newest first)
    const sortedProfiles = sortInvoicesByDate(userProfiles);
    
    sortedProfiles.forEach(profile => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${profile.id}</td>
            <td>${profile.passengerName || 'N/A'}</td>
            <td>AED ${profile.totalBudget.toFixed(2)}</td>
            <td>${profile.driverAgent || 'Not Assigned'}</td>
            <td>
                <span class="status-badge ${getPickupStatusClass(profile.pickupStatus)}">
                    ${getPickupStatusText(profile.pickupStatus)}
                </span>
            </td>
            <td>
                <span class="status-badge ${profile.paymentStatus === 'paid' ? 'status-paid' : 'status-unpaid'}">
                    ${profile.paymentStatus === 'paid' ? 'Paid' : 'Not Yet'}
                </span>
            </td>
            <td>
                <div class="driver-actions">
                    <button class="bubbles btn-small" onclick="viewInvoiceDetails('${profile.id}')">
                        <span class="text">View</span>
                    </button>
                    ${profile.pickupStatus === 'no status yet' ? `
                    <button class="bubbles btn-small btn-edit" onclick="editPassengerProfile('${profile.id}')">
                        <span class="text">Edit</span>
                    </button>
                    ` : ''}
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function editPassengerProfile(profileId) {
    const profile = invoices.find(inv => inv.id === profileId);
    if (!profile) {
        showNotification('Profile not found', 'error');
        return;
    }
    
    showNotification(`Editing passenger profile ${profileId} - This would open an edit form`, 'info');
}

// Driver Dashboard Functions
// Driver Dashboard Functions - EXACT COPY OF ADMIN DASHBOARD
// Driver Dashboard Functions - EXACT COPY OF ADMIN DASHBOARD
function renderDriverDashboardSection() {
    const tbody = document.querySelector('#driver-dashboard-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Get ALL profiles (like admin dashboard)
    const allProfiles = invoices;
    
    if (allProfiles.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px;">
                No passenger profiles found
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    // Sort by date (newest first)
    const sortedProfiles = sortInvoicesByDate(allProfiles);
    
    sortedProfiles.forEach(profile => {
        const driver = profile.driverId ? users.find(u => u.id === profile.driverId) : null;
        const passenger = users.find(u => u.id === profile.passengerId);
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${profile.id}</td>
            <td>${profile.passengerAgent || (passenger ? passenger.username : 'N/A')}</td>
            <td>AED ${profile.totalBudget.toFixed(2)}</td>
            <td>${driver ? driver.username : 'Not Assigned'}</td>
            <td>
                <span class="status-badge ${getPickupStatusClass(profile.pickupStatus)}">
                    ${getPickupStatusText(profile.pickupStatus)}
                </span>
            </td>
            <td>
                <div class="driver-actions">
                    <button class="bubbles btn-small" onclick="viewInvoiceDetails('${profile.id}')">
                        <span class="text">View</span>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updateDriverDashboardStats() {
    const assignedInvoices = invoices.filter(inv => inv.driverId === currentUser.id);
    const completedJobs = assignedInvoices.filter(inv => inv.pickupStatus === 'pickup confirmed');
    const pendingJobs = assignedInvoices.filter(inv => inv.pickupStatus === 'no status yet');
    
    const driverTransactions = finance.transactions.filter(t => t.driverId === currentUser.id);
    const totalEarnings = driverTransactions.reduce((sum, t) => sum + t.amount, 0);

    document.getElementById('driver-total-assigned').textContent = assignedInvoices.length;
    document.getElementById('driver-completed-jobs').textContent = completedJobs.length;
    document.getElementById('driver-pending-jobs').textContent = pendingJobs.length;
    document.getElementById('driver-total-earnings-dash').textContent = `AED ${totalEarnings.toFixed(2)}`;
}

function renderDriverDashboardTable() {
    const tbody = document.querySelector('#driver-dashboard-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const assignedInvoices = invoices.filter(inv => inv.driverId === currentUser.id);
    
    if (assignedInvoices.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="7" style="text-align: center; padding: 20px;">
                No assigned jobs yet
            </td>
        `;
        tbody.appendChild(row);
        return;
    }
    
    // Sort by date (newest first)
    const sortedInvoices = sortInvoicesByDate(assignedInvoices);
    
    sortedInvoices.forEach(invoice => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${invoice.id}</td>
            <td>${invoice.passengerName || 'N/A'}</td>
            <td>${invoice.pickupTime || 'N/A'}</td>
            <td>AED ${invoice.transportAmount.toFixed(2)}</td>
            <td>
                <span class="status-badge ${getPickupStatusClass(invoice.pickupStatus)}">
                    ${getPickupStatusText(invoice.pickupStatus)}
                </span>
            </td>
            <td>
                <span class="status-badge ${invoice.paymentStatus === 'paid' ? 'status-paid' : 'status-unpaid'}">
                    ${invoice.paymentStatus === 'paid' ? 'Paid' : 'Not Yet'}
                </span>
            </td>
            <td>
                <div class="driver-actions">
                    <button class="bubbles btn-small" onclick="viewInvoiceDetails('${invoice.id}')">
                        <span class="text">View</span>
                    </button>
                    ${invoice.pickupStatus === 'no status yet' ? `
                    <button class="bubbles btn-small btn-success" onclick="confirmPickup('${invoice.id}')">
                        <span class="text">Confirm Pickup</span>
                    </button>
                    ` : ''}
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function confirmPickup(profileId) {
    const profile = invoices.find(inv => inv.id === profileId);
    if (!profile) {
        showNotification('Profile not found', 'error');
        return;
    }
    
    if (confirm('Are you sure you want to confirm pickup for this passenger?')) {
        profile.pickupStatus = 'pickup confirmed';
        profile.paymentStatus = 'unpaid';
        
        showNotification(`Pickup confirmed for profile ${profileId}`, 'success');
        // Notify the passenger
        if(profile.passengerId) {
            window.sendSystemNotification(profile.passengerId, `Your pickup for Invoice #${profile.id} has been CONFIRMED by the driver.`);
        }

        // Notify the Admin
        window.sendSystemNotification('admin', `Driver confirmed pickup for Invoice #${profile.id} (Passenger: ${profile.passengerName}).`);
        renderDriverDashboardSection();
        renderDriverInvoicesTable();
        
        if (users.find(u => u.role === 'admin' && u.loginTimes.length > u.logoutTimes.length)) {
            renderAdminProfilesTable();
            renderAdminInvoicesTable();
        }
    }
}
// Driver Details Section Functions
// Driver Details Section Functions
window.driversList = [];
function showAddDriverModal() {
    document.getElementById('add-driver-modal').style.display = 'block';
}

function closeAddDriverModal() {
    document.getElementById('add-driver-modal').style.display = 'none';
    // Clear form fields
    document.getElementById('new-driver-name').value = '';
    document.getElementById('new-driver-phone').value = '';
    document.getElementById('new-driver-from').value = '';
    document.getElementById('new-driver-to').value = '';
}

function addNewDriver() {
    const name = document.getElementById('new-driver-name').value.trim();
    const phone = document.getElementById('new-driver-phone').value.trim();
    const fromLocation = document.getElementById('new-driver-from').value.trim();
    const toLocation = document.getElementById('new-driver-to').value.trim();

    if (!name || !phone) { showNotification('Fill details', 'error'); return; }

    const newDriver = {
        id: generateId('drv'),
        name: name, phone: phone,
        fromLocation: fromLocation, toLocation: toLocation,
        status: 'active',
        dateAdded: getCurrentDateTime().date
    };

    // SAVE TO DATABASE
    if (window.setDoc && window.db) {
        window.setDoc(window.doc(window.db, "drivers_list", newDriver.id), newDriver);
    }

    closeAddDriverModal();
    showNotification('Driver added', 'success');
}
function searchDrivers() {
    const searchTerm = document.getElementById('driver-search').value.toLowerCase().trim();
    const tbody = document.querySelector('#drivers-table tbody');
    tbody.innerHTML = '';

    let filteredDrivers = driversList;

    if (searchTerm) {
        filteredDrivers = driversList.filter(driver => 
            driver.fromLocation.toLowerCase().includes(searchTerm) ||
            driver.toLocation.toLowerCase().includes(searchTerm)
        );
    }

    if (filteredDrivers.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px;">
                ${searchTerm ? 'No drivers found for "' + searchTerm + '"' : 'No drivers added yet. Click "Add Drivers" to get started.'}
            </td>
        `;
        tbody.appendChild(row);
        return;
    }

    filteredDrivers.forEach(driver => {
        const row = document.createElement('tr');
        
        // Highlight matching locations
        const fromLocation = highlightSearchTerm(driver.fromLocation, searchTerm);
        const toLocation = highlightSearchTerm(driver.toLocation, searchTerm);
        
        row.innerHTML = `
            <td>${driver.name}</td>
            <td>${driver.phone}</td>
            <td>${fromLocation}</td>
            <td>${toLocation}</td>
            <td><span class="status-${driver.status}">${driver.status.charAt(0).toUpperCase() + driver.status.slice(1)}</span></td>
            <td>
                <button class="bubbles btn-small btn-danger" onclick="deleteDriver('${driver.id}')">
                    <span class="text">Delete</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function highlightSearchTerm(text, searchTerm) {
    if (!searchTerm) return text;
    
    const regex = new RegExp(`(${searchTerm})`, 'gi');
    return text.replace(regex, '<mark style="background: var(--accent); color: var(--bg-main); padding: 2px 4px; border-radius: 3px;">AED 1</mark>');
}
function renderDriversTable() {
    const tbody = document.querySelector('#drivers-table tbody');
    tbody.innerHTML = '';

    if (driversList.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td colspan="6" style="text-align: center; padding: 20px;">
                No drivers added yet. Click "Add Drivers" to get started.
            </td>
        `;
        tbody.appendChild(row);
        return;
    }

    driversList.forEach(driver => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${driver.name}</td>
            <td>${driver.phone}</td>
            <td>${driver.fromLocation}</td>
            <td>${driver.toLocation}</td>
            <td><span class="status-${driver.status}">${driver.status.charAt(0).toUpperCase() + driver.status.slice(1)}</span></td>
            <td>
                <button class="bubbles btn-small btn-danger" onclick="deleteDriver('${driver.id}')">
                    <span class="text">Delete</span>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function deleteDriver(driverId) {
    if (confirm('Delete this driver?')) {
        // DELETE FROM DATABASE
        if (window.deleteDoc && window.db) {
            window.deleteDoc(window.doc(window.db, "drivers_list", driverId));
            showNotification('Driver deleted', 'success');
        }
    }
}// Update the showDriverSection function to handle the new section
// Find the existing showDriverSection function and update the switch case:
function showDriverSection(section) {
    // Remove active class from all nav buttons
    document.querySelectorAll('#driver-dashboard .nav-btn').forEach(btn => btn.classList.remove('active'));
    
    // Add active class to clicked button
    if (event && event.target) {
        event.target.classList.add('active');
    }
    
    // Hide all sections
    document.querySelectorAll('#driver-dashboard .section').forEach(sec => sec.classList.remove('active'));

    // Show selected section
    if (section === 'dashboard') {
        document.getElementById('driver-dashboard-section').classList.add('active');
        renderDriverDashboardSection();
    } else {
        const targetSection = document.getElementById(`driver-${section}`);
        if (targetSection) {
            targetSection.classList.add('active');
        }
    }

    // Render section-specific content
    switch(section) {
        case 'dashboard': 
            renderDriverDashboardSection(); 
            break;
        case 'home': 
            updateDriverStats(); 
            break;
        case 'monthly-gross': 
            renderDriverMonthlyGross(); 
            break;
        case 'targets': 
            renderDriverTargetsTable(); 
            break;
        case 'invoices': 
            renderDriverInvoicesTable(); 
            break;
        case 'drivers': 
            renderDriversTable(); 
            break;
        case 'earnings': 
            renderDriverEarnings(); 
            break;
        case 'settings': 
            renderDriverSettings(); 
            break;
    }
}
        // Utility Functions for Calculations
        function calculateWorkingHours(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return 0;
            
            let totalHours = 0;
            const loginTimes = user.loginTimes.map(t => new Date(t));
            const logoutTimes = user.logoutTimes.map(t => new Date(t));
            
            for (let i = 0; i < Math.min(loginTimes.length, logoutTimes.length); i++) {
                const sessionHours = (logoutTimes[i] - loginTimes[i]) / (1000 * 60 * 60);
                totalHours += sessionHours;
            }
            
            return totalHours;
        }

        function calculateEmployeeEarnings(userId, period) {
            const driverTransactions = finance.transactions.filter(t => t.driverId === userId);
            
            switch(period) {
                case 'daily':
                    const today = new Date().toISOString().split('T')[0];
                    return driverTransactions
                        .filter(t => t.date === today)
                        .reduce((sum, t) => sum + t.amount, 0);
                case 'weekly':
                    const thisWeek = getWeekStart(new Date());
                    return driverTransactions
                        .filter(t => t.date >= thisWeek)
                        .reduce((sum, t) => sum + t.amount, 0);
                case 'monthly':
                    const thisMonth = new Date().toISOString().substr(0, 7);
                    return driverTransactions
                        .filter(t => t.date.startsWith(thisMonth))
                        .reduce((sum, t) => sum + t.amount, 0);
                case 'total':
                default:
                    return driverTransactions.reduce((sum, t) => sum + t.amount, 0);
            }
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff)).toISOString().split('T')[0];
        }

        // Invoice Management Functions
        function calculateFare() {
            // FIXED: Properly check if values are selected
            if (!selectedPassengerType) {
                document.getElementById("fare-result").innerHTML = '<div style="color: #dc3545; font-weight: bold;"> Please select passenger type!</div>';
                document.getElementById("fare-result").style.display = 'block';
                return;
            }

            if (!selectedRideWay) {
                document.getElementById("fare-result").innerHTML = '<div style="color: #dc3545; font-weight: bold;"> Please select ride type!</div>';
                document.getElementById("fare-result").style.display = 'block';
                return;
            }

            let passengerType = parseInt(selectedPassengerType);
            let way = parseInt(selectedRideWay);
            let distance = parseFloat(document.getElementById("distance").value);
            let days = parseInt(document.getElementById("days").value);

            if (isNaN(distance) || isNaN(days)) {
                document.getElementById("fare-result").innerHTML = '<div style="color: #dc3545; font-weight: bold;"> Fill all fields!</div>';
                document.getElementById("fare-result").style.display = 'block';
                return;
            }

            let baseFare = 0, maxKm = 0;

            if (distance <= 15) { baseFare = 1200; maxKm = 15; }
            else if (distance <= 20) { baseFare = 1400; maxKm = 20; }
            else if (distance <= 25) { baseFare = 1500; maxKm = 25; }
            else if (distance <= 30) { baseFare = 1700; maxKm = 30; }
            else if (distance <= 45) { baseFare = 2200; maxKm = 45; }
            else if (distance <= 60) { baseFare = 2600; maxKm = 60; }
            else if (distance <= 70) { baseFare = 2900; maxKm = 70; }
            else if (distance <= 80) { baseFare = 3200; maxKm = 80; }
            else if (distance <= 90) { baseFare = 3500; maxKm = 90; }
            else if (distance <= 100) { baseFare = 3800; maxKm = 100; }
            else if (distance <= 110) { baseFare = 4000; maxKm = 110; }
            else if (distance <= 120) { baseFare = 4300; maxKm = 120; }
            else if (distance <= 130) { baseFare = 4500; maxKm = 130; }
            else if (distance <= 140) { baseFare = 4800; maxKm = 140; }
            else if (distance <= 160) { baseFare = 5500; maxKm = 160; }
            else {
                document.getElementById("fare-result").innerHTML = '<div style="color: #dc3545; font-weight: bold;"> Distance exceeds maximum limit (160 km)</div>';
                document.getElementById("fare-result").style.display = 'block';
                return;
            }

            // Step 1: Fare per km
            let perKm = baseFare / maxKm;

            // Step 2: Multiply by actual km
            let ans2 = perKm * distance;

            // Step 3: Divide by passenger type basis (5 for one-time, 20 for permanent)
            let divisor = (passengerType === 1) ? 5 : 20;
            let ans3 = ans2 / divisor;

            // Step 4: Multiply by days
            let totalPrivate = ans3 * days;

            // Step 5: One Way = 60% of private
            if (way === 1) totalPrivate *= 0.6;

            // Step 6: Shared always = 60% of private
            let totalShared = totalPrivate * 0.6;

            // Step 7: Add service charges
            let withServicePrivate = totalPrivate * 1.2;
            let withServiceShared = totalShared * 1.2;

            document.getElementById("fare-result").innerHTML =
                "<h4>Calculated Fare Results:</h4>" +
                "<div style='background: rgba(26, 29, 37, 0.8); padding: 15px; border-radius: 8px; margin: 10px 0;'>" +
                "<b>Private Fare:</b><br>" +
                "Base: " + totalPrivate.toFixed(2) + " AED <br>" +
                "With 20% Service Charges: " + withServicePrivate.toFixed(2) + " AED </div>" +
                "<div style='background: rgba(26, 29, 37, 0.8); padding: 15px; border-radius: 8px; margin: 10px 0;'>" +
                "<b>Shared Fare:</b><br>" +
                "Base: " + totalShared.toFixed(2) + " AED <br>" +
                "With 20% Service Charges: " + withServiceShared.toFixed(2) + " AED </div>";

            document.getElementById("fare-result").style.display = 'block';
            document.getElementById("nextBtn").style.display = 'block';
        }

        function showRateList() {
            const rateList = [
                { range: "Up to 15 km", fare: "1200 AED " },
                { range: "16-20 km", fare: "1400 AED " },
                { range: "21-25 km", fare: "1500 AED " },
                { range: "26-30 km", fare: "1700 AED " },
                { range: "31-45 km", fare: "2200 AED " },
                { range: "46-60 km", fare: "2600 AED " },
                { range: "61-70 km", fare: "2900 AED " },
                { range: "71-80 km", fare: "3200 AED " },
                { range: "81-90 km", fare: "3500 AED " },
                { range: "91-100 km", fare: "3800 AED " },
                { range: "101-110 km", fare: "4000 AED " },
                { range: "111-120 km", fare: "4300 AED " },
                { range: "121-130 km", fare: "4500 AED " },
                { range: "131-140 km", fare: "4800 AED " },
                { range: "141-160 km", fare: "5500 AED " }
            ];

            const tbody = document.getElementById('rate-list-body');
            tbody.innerHTML = '';
            
            rateList.forEach(rate => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${rate.range}</td>
                    <td>${rate.fare}</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('rate-list-modal').style.display = 'block';
        }

        function closeRateList() {
            document.getElementById('rate-list-modal').style.display = 'none';
        }

        function useCalculatedFare() {
            // This function can be used to auto-fill the create profile form with calculated values
            showNotification('You can now create a profile using the calculated fare', 'info');
            // You can add logic here to auto-fill the create profile form
        }
// Add this function to handle real-time calculation
function calculateTransportAmount() {
    const totalBudget = parseFloat(document.getElementById('total-budget').value) || 0;
    const serviceCharges = parseFloat(document.getElementById('service-charges').value) || 0;
    const driverCharges = parseFloat(document.getElementById('driver-charges').value) || 0;
    
    const transportAmount = totalBudget - serviceCharges - driverCharges;
    
    // This updates the HIDDEN input field (Required for Database)
    document.getElementById('transport-amount').value = transportAmount.toFixed(2);
    
    // Update the calculated results display if visible
    if (document.getElementById('calculated-results').style.display === 'block') {
        const monthlyDays = selectedDaysPerWeek ? parseInt(selectedDaysPerWeek) * 4 : 0;
        const dailyBudget = monthlyDays > 0 ? transportAmount / monthlyDays : 0;
        
        document.getElementById('daily-budget-result').textContent = dailyBudget.toFixed(2);
        
        // REMOVED: document.getElementById('transport-amount-result').textContent = ... 
        // We removed this line because you deleted the HTML element.
    }
}

// Add event listeners for real-time calculation
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('total-budget').addEventListener('input', calculateTransportAmount);
    document.getElementById('service-charges').addEventListener('input', calculateTransportAmount);
    document.getElementById('driver-charges').addEventListener('input', calculateTransportAmount);
});
function calculateAndCreateInvoice() {
    showLoader();
    
    setTimeout(() => {
        // Get all form values
        const passengerName = document.getElementById('passenger-name').value.trim();
        const passengerPhone = document.getElementById('passenger-phone').value.trim();
        const pickupTime = document.getElementById('pickup-time').value;
        const dropoffTime = document.getElementById('dropoff-time').value;
        const totalBudget = parseFloat(document.getElementById('total-budget').value);
        const serviceCharges = parseFloat(document.getElementById('service-charges').value);
        const driverCharges = parseFloat(document.getElementById('driver-charges').value);
        const passengerAgentChoice = document.getElementById('passenger-agent-choice').querySelector('span:first-child').textContent;
        const passengerAgent = (passengerAgentChoice === 'Select Passenger Agent') ? '' : passengerAgentChoice;
        const passengerNationality = document.getElementById('passenger-nationality').value.trim();
        const pickupLocation = document.getElementById('pickup-location').value.trim();
        const dropoffLocation = document.getElementById('dropoff-location').value.trim();
        const routeLink = document.getElementById('route-link').value.trim();
        const profileNote = document.getElementById('profile-note').value.trim(); // Get the note

        // Get selected values directly from the choice boxes
        const daysPerWeekText = document.getElementById('days-per-week-choice').querySelector('span:first-child').textContent;
        const rideWayText = document.getElementById('ride-way-profile-choice').querySelector('span:first-child').textContent;
        const rideTypeText = document.getElementById('ride-type-choice').querySelector('span:first-child').textContent;
        const genderText = document.getElementById('passenger-gender-choice').querySelector('span:first-child').textContent;

        // Validation
        if (!passengerName || !passengerPhone || !totalBudget || !serviceCharges || !driverCharges || !passengerAgent)  {
            showNotification('Please fill in all required fields', 'error');
            hideLoader();
            return;
        }

        if (totalBudget <= (serviceCharges + driverCharges)) {
            showNotification('Total budget must be greater than service charges + driver charges', 'error');
            hideLoader();
            return;
        }

        // FIXED: Check if default selection text is still there
        if (daysPerWeekText === 'Select Days per Week' || !selectedDaysPerWeek) {
            showNotification('Please select number of days per week', 'error');
            hideLoader();
            return;
        }

        if (rideWayText === 'Select Ride Way' || !selectedRideWayProfile) {
            showNotification('Please select ride way', 'error');
            hideLoader();
            return;
        }

        if (rideTypeText === 'Select Ride Type' || !selectedRideType) {
            showNotification('Please select ride type', 'error');
            hideLoader();
            return;
        }

        if (genderText === 'Select Gender' || !selectedGender) {
            showNotification('Please select gender', 'error');
            hideLoader();
            return;
        }

        // Calculate transport amount
        const transportAmount = totalBudget - serviceCharges - driverCharges;
        const monthlyDays = parseInt(selectedDaysPerWeek) * 4; // 4 weeks in a month
        const dailyBudget = totalBudget / monthlyDays;

        // Show calculated results
        // Show calculated results
        document.getElementById('calculated-results').style.display = 'block';
        document.getElementById('daily-budget-result').textContent = dailyBudget.toFixed(2);
        // Transport amount display removed

        // Create invoice object
        const dateTime = getCurrentDateTime();
        const newInvoice = {
            id: generateId('inv'),
            passengerId: currentUser.id,
            passengerName: passengerName,
            passengerPhone: passengerPhone,
            pickupTime: pickupTime,
            dropoffTime: dropoffTime,
            daysPerWeek: parseInt(selectedDaysPerWeek),
            monthlyDays: monthlyDays,
            rideWay: selectedRideWayProfile,
            rideType: selectedRideType,
            totalBudget: totalBudget,
            serviceCharges: serviceCharges,
            driverCharges: driverCharges, // NEW: Store driver charges separately
            transportAmount: transportAmount,
            dailyBudget: dailyBudget,
            passengerAgent: passengerAgent,
            passengerNationality: passengerNationality,
            passengerGender: selectedGender,
            pickupLocation: pickupLocation,
            dropoffLocation: dropoffLocation,
            routeLink: routeLink,
            note: profileNote, // Save the note
            serviceChargesPaid: false,
            driverId: null,
            driverAgent: null,
            status: 'unpaid',
            pickupStatus: 'no status yet', 
            paymentStatus: 'unpaid', 
            date: dateTime.date,
            time: dateTime.time
        };

        // Save Invoice to Firebase
        if (window.setDoc && window.db) {
            window.setDoc(window.doc(window.db, "invoices", newInvoice.id), newInvoice)
            .then(() => {
                console.log("Invoice saved");
                window.sendSystemNotification('admin', `New Invoice #${newInvoice.id} created by ${passengerName}`);
                // Also save the invoice ID to the current user's history in DB
                let userRef = window.doc(window.db, "users", currentUser.id);
                // We need to update the user's invoice history in the DB too
                // Note: For simplicity, we just save the invoice now.
            });
        }
        currentUser.invoiceHistory.push(newInvoice.id);

        // Clear form
        document.querySelectorAll('#passenger-invoice input, #passenger-invoice select').forEach(element => {
            if (element.type !== 'button') {
                element.value = '';
            }
        });
        
        // Reset choice boxes
        document.getElementById('days-per-week-choice').querySelector('span:first-child').textContent = 'Select Days per Week';
        document.getElementById('passenger-agent-choice').querySelector('span:first-child').textContent = 'Select Passenger Agent';
        document.getElementById('passenger-agent-choice').classList.remove('selected');        
        document.getElementById('ride-way-profile-choice').querySelector('span:first-child').textContent = 'Select Ride Way';
        document.getElementById('ride-type-choice').querySelector('span:first-child').textContent = 'Select Ride Type';
        document.getElementById('passenger-gender-choice').querySelector('span:first-child').textContent = 'Select Gender';
        
        // Remove selected class
        document.getElementById('days-per-week-choice').classList.remove('selected');
        document.getElementById('ride-way-profile-choice').classList.remove('selected');
        document.getElementById('ride-type-choice').classList.remove('selected');
        document.getElementById('passenger-gender-choice').classList.remove('selected');
        
        selectedDaysPerWeek = null;
        selectedRideWayProfile = null;
        selectedRideType = null;
        selectedGender = null;
        
        document.getElementById('calculated-results').style.display = 'none';

        // Refresh ALL relevant tables
        renderPassengerProfilesTable();
        updatePassengerStats();
        
        // Also refresh admin invoices table if admin is logged in
        if (users.find(u => u.role === 'admin' && u.loginTimes.length > u.logoutTimes.length)) {
            renderAdminProfilesTable();
        }

        showNotification(`Passenger profile ${newInvoice.id} created successfully!`, 'success');
        
        // Simulate admin notification
        setTimeout(() => {
            const loggedInAdmin = users.find(u => u.role === 'admin' && u.loginTimes.length > u.logoutTimes.length);
            if (loggedInAdmin) {
                showNotification(`New invoice ${newInvoice.id} received from ${currentUser.username}`, 'info');
            }
        }, 1000);
        
        hideLoader();
    }, 1500);
}

        function assignInvoiceToDriver(invoiceId, driverId) {
            if (!driverId) return;
            
            const invoice = invoices.find(inv => inv.id === invoiceId);
            const driver = users.find(u => u.id === driverId);
            
            if (!invoice || !driver) {
                showNotification('Invalid invoice or driver', 'error');
                return;
            }
            
            invoice.driverId = driverId;
            driver.assignedInvoices.push(invoiceId);
            
            renderAdminInvoicesTable();
            showNotification(`Invoice ${invoiceId} assigned to ${driver.username}`, 'success');
            
            // Simulate driver notification
            setTimeout(() => {
                if (currentUser.role === 'driver' && currentUser.id === driverId) {
                    showNotification(`New invoice ${invoiceId} assigned to you`, 'info');
                }
            }, 1000);
        }
// Assign driver to profile (for dashboard)
function assignDriverToProfile(profileId, driverId) {
    const profile = invoices.find(inv => inv.id === profileId);
    const driver = users.find(u => u.id === driverId);
    
    if (profile && driver) {
        profile.driverId = driverId;
        profile.driverAgent = driver.username;
        renderAdminDashboardSection();
        showNotification(`Driver ${driver.username} assigned to profile ${profileId}`, 'success');
    }
    
    // Hide dropdown
    document.querySelectorAll('.driver-dropdown').forEach(d => {
        d.classList.remove('show');
    });
}

// Unassign driver from profile (for dashboard)
function unassignDriverFromProfile(profileId) {
    const profile = invoices.find(inv => inv.id === profileId);
    
    if (profile) {
        profile.driverId = null;
        profile.driverAgent = null;
        renderAdminDashboardSection();
        showNotification(`Driver unassigned from profile ${profileId}`, 'info');
    }
    
    // Hide dropdown
    document.querySelectorAll('.driver-dropdown').forEach(d => {
        d.classList.remove('show');
    });
}
        // function markInvoicePaid(invoiceId) {
        //     showLoader();
            
        //     setTimeout(() => {
        //         const invoice = invoices.find(inv => inv.id === invoiceId);
                
        //         if (!invoice) {
        //             showNotification('Invoice not found', 'error');
        //             hideLoader();
        //             return;
        //         }
                
        //         if (invoice.status === 'paid') {
        //             showNotification('Invoice is already marked as paid', 'info');
        //             hideLoader();
        //             return;
        //         }
                
        //         // Calculate 10% of transport budget
        //         const transportBudget = invoice.transportAmount || (invoice.amount - (invoice.serviceCharges || 0));
        //         const driverPayment = transportBudget * 0.10;
                
        //         // Update invoice status
        //         invoice.status = 'paid';
        //         invoice.paymentStatus = 'paid';
        //         invoice.driverPayment = driverPayment;
                
        //         // Add driver payment to finance transactions
        //         const dateTime = getCurrentDateTime();
        //         const transaction = {
        //             invoiceId: invoice.id,
        //             amount: driverPayment,
        //             date: dateTime.date,
        //             time: dateTime.time,
        //             driverId: currentUser.id,
        //             type: 'driver_payment',
        //             description: `Driver payment (10%) for invoice ${invoice.id}`
        //         };
                
        //         finance.transactions.push(transaction);
        //         finance.totalPaid += driverPayment;
                
        //         // Refresh relevant displays
        //         renderDriverInvoicesTable();
        //         renderDriverEarnings();
        //         updateDriverStats();
                
        //         showNotification(`Invoice ${invoiceId} marked as paid. AED ${driverPayment.toFixed(2)} (10% of transport budget) added to earnings.`, 'success');
                
        //         hideLoader();
        //     }, 1000);
        // }

        function payServiceCharges(invoiceId) {
            showLoader();
            
            setTimeout(() => {
                const invoice = invoices.find(inv => inv.id === invoiceId);
                
                if (!invoice) {
                    showNotification('Invoice not found', 'error');
                    hideLoader();
                    return;
                }
                
                if (invoice.serviceChargesPaid) {
                    showNotification('Service charges already paid', 'info');
                    hideLoader();
                    return;
                }
                
                // Mark service charges as paid
                invoice.serviceChargesPaid = true;
                
                // Add service charges to admin finance
                const dateTime = getCurrentDateTime();
                const transaction = {
                    invoiceId: invoice.id,
                    amount: invoice.serviceCharges,
                    date: dateTime.date,
                    time: dateTime.time,
                    type: 'service_charges',
                    description: `Service charges for invoice ${invoice.id}`
                };
                
                finance.transactions.push(transaction);
                finance.totalPaid += invoice.serviceCharges;
                
                // Refresh displays
                renderPassengerProfilesTable();
                showNotification(`Service charges of AED ${invoice.serviceCharges.toFixed(2)} paid successfully`, 'success');
                
                hideLoader();
            }, 1000);
        }

        function viewInvoiceDetails(invoiceId) {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) {
                showNotification('Invoice not found', 'error');
                return;
            }
        
            // Header & Passenger Info
            document.getElementById('invoice-modal-id').textContent = `Invoice #${invoice.id}`;
            document.getElementById('modal-passenger-name').textContent = invoice.passengerName || 'N/A';
            document.getElementById('modal-passenger-phone').textContent = invoice.passengerPhone || 'N/A';
            document.getElementById('modal-passenger-gender').textContent = invoice.passengerGender || 'N/A';
            document.getElementById('modal-passenger-nationality').textContent = invoice.passengerNationality || 'N/A';
            document.getElementById('modal-passenger-agent').textContent = invoice.passengerAgent || 'N/A';
        
            // Ride Details (Updated with Monthly Days)
            document.getElementById('modal-pickup-time').textContent = invoice.pickupTime || 'N/A';
            document.getElementById('modal-dropoff-time').textContent = invoice.dropoffTime || 'N/A';
            document.getElementById('modal-days-week').textContent = `${invoice.daysPerWeek} Days`;
            
            // Logic: Calculate monthly days (Days per week * 4)
            const monthlyDays = invoice.monthlyDays || (parseInt(invoice.daysPerWeek) * 4);
            document.getElementById('modal-monthly-days').textContent = `${monthlyDays} Days`;
            
            document.getElementById('modal-ride-way').textContent = invoice.rideWay === 'one-way' ? 'One Way' : 'Two Way';
            document.getElementById('modal-ride-type').textContent = invoice.rideType ? invoice.rideType.charAt(0).toUpperCase() + invoice.rideType.slice(1) : 'N/A';
            
            // Populate Note
            document.getElementById('modal-note').textContent = invoice.note || 'No specific notes provided.';
        
            // Financials
            document.getElementById('modal-total-budget').textContent = (invoice.totalBudget || 0).toFixed(2);
            document.getElementById('modal-service-charges').textContent = (invoice.serviceCharges || 0).toFixed(2);
            document.getElementById('modal-driver-charges').textContent = (invoice.driverCharges || 0).toFixed(2);
            document.getElementById('modal-daily-budget').textContent = (invoice.dailyBudget || 0).toFixed(2);
            document.getElementById('modal-status').textContent = invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1);
            
            // Map Links
            document.getElementById('modal-pickup-link').href = invoice.pickupLocation || '#';
            document.getElementById('modal-dropoff-link').href = invoice.dropoffLocation || '#';
            document.getElementById('modal-route-link').href = invoice.routeLink || '#';
        
            // Show modal
            document.getElementById('invoice-modal').style.display = 'block';
        
            // Re-attach download triggers
            document.getElementById('download-passenger-pdf-btn').onclick = () => window.generatePDFInvoice(invoiceId, 'passenger');
            document.getElementById('download-driver-pdf-btn').onclick = () => window.generatePDFInvoice(invoiceId, 'driver');
            document.getElementById('copy-details-btn').onclick = () => window.copyInvoiceDetails(invoiceId);
        }

        function closeInvoiceModal() {
            document.getElementById('invoice-modal').style.display = 'none';
        }

        // Filter and Sort Functions
        // Admin Invoice Filtering
        function filterAdminInvoices(filterType) {
            currentAdminFilter = filterType;
            
            // Update active button
            document.querySelectorAll('#admin-invoices .nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderAdminInvoicesTable();
        }

        // Passenger Invoice Filtering
        function filterPassengerInvoices(filterType) {
            currentPassengerFilter = filterType;
            
            // Update active button
            document.querySelectorAll('#passenger-invoice .nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderPassengerProfilesTable();
        }

        // Driver Invoice Filtering
        function filterDriverInvoices(filterType) {
            currentDriverFilter = filterType;
            
            // Update active button
            document.querySelectorAll('#driver-invoices .nav-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderDriverInvoicesTable();
        }

        // Sort invoices by date (newest first)
        function sortInvoicesByDate(invoicesArray) {
            return invoicesArray.sort((a, b) => {
                const dateA = new Date(a.date + ' ' + a.time);
                const dateB = new Date(b.date + ' ' + b.time);
                return dateB - dateA; // Newest first
            });
        }

        // Initialize the application
        function init() {
            // --- FIX START: Handle Browser Close / Tab Close ---
            window.addEventListener('beforeunload', function(event) {
                if (currentUser) {
                    // 1. Create timestamp
                    const newLogoutTime = new Date().toISOString();
                    
                    // 2. Update local array to ensure the payload is correct
                    if (!currentUser.logoutTimes) currentUser.logoutTimes = [];
                    currentUser.logoutTimes.push(newLogoutTime);

                    // 3. Send update to Firebase immediately
                    // Note: We do not use logout() here because we don't want to trigger UI animations on a closing window
                    if (window.updateDoc && window.db) {
                        window.updateDoc(window.doc(window.db, "users", currentUser.id), { 
                            logoutTimes: currentUser.logoutTimes 
                        }).catch(err => console.log("Close update sent"));
                    }
                }
            });
            // --- FIX END ---

            // Set up event listeners for Enter key on login forms
            document.getElementById('login-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    login();
                }
            });
            
            document.getElementById('signin-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    signUp();
                }
            });
// Auto-logout at 12:00 AM check (runs every minute)
            setInterval(() => {
                const now = new Date();
                // Check if time is 00:00 (Midnight) and someone is logged in
                if (now.getHours() === 0 && now.getMinutes() === 0 && currentUser) {
                    showNotification('System Auto-Logout: End of Day', 'info');
                    logout();
                }
            }, 60000);

            initializeMonthFilters();
        }
// --- 1. Function to Send Notification to DB ---
window.sendSystemNotification = async function(targetUserId, message) {
    if (!window.db || !window.updateDoc || !window.doc || !window.users) return;

    const dateTime = getCurrentDateTime();
    const newNote = {
        message: message,
        date: dateTime.date,
        time: dateTime.time,
        read: false
    };

    // If target is 'admin', send to ALL admins
    if (targetUserId === 'admin') {
        const admins = window.users.filter(u => u.role === 'admin');
        admins.forEach(admin => {
            const currentNotes = admin.systemNotifications || [];
            currentNotes.push(newNote);
            window.updateDoc(window.doc(window.db, "users", admin.id), { systemNotifications: currentNotes });
        });
        console.log("Notification sent to Admins");
    } 
    // Send to specific user (Driver/Passenger/Employee)
    else {
        const user = window.users.find(u => u.id === targetUserId);
        if (user) {
            const currentNotes = user.systemNotifications || [];
            currentNotes.push(newNote);
            window.updateDoc(window.doc(window.db, "users", targetUserId), { systemNotifications: currentNotes });
            console.log(`Notification sent to ${user.username}`);
        }
    }
};

// --- 2. Function to Check & Display on Login ---
window.checkLoginNotifications = function() {
    if (!currentUser || !currentUser.systemNotifications || currentUser.systemNotifications.length === 0) return;

    const listContainer = document.getElementById('center-notification-list');
    listContainer.innerHTML = '';

    currentUser.systemNotifications.forEach(note => {
        const div = document.createElement('div');
        div.className = 'notification-item';
        div.innerHTML = `
            <div style="font-size: 0.8em; color: var(--text-secondary); margin-bottom: 5px;">${note.date} at ${note.time}</div>
            <div>${note.message}</div>
        `;
        listContainer.appendChild(div);
    });

    document.getElementById('center-notification-modal').style.display = 'block';
};

// --- 3. Function to Dismiss (Clear from DB) ---
window.dismissCenterNotifications = function() {
    if (!currentUser) return;

    // Clear notifications in DB
    if (window.updateDoc && window.db) {
        window.updateDoc(window.doc(window.db, "users", currentUser.id), { systemNotifications: [] });
    }
    
    // Clear local current user state
    currentUser.systemNotifications = [];
    
    document.getElementById('center-notification-modal').style.display = 'none';
};
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', init);
        // --- EXPOSE FUNCTIONS TO HTML ---
    // User Management
    window.switchAuthTab = switchAuthTab;
    window.login = login;
    window.signUp = signUp;
    window.logout = logout;
    window.changePassword = changePassword;
    
    // Modals & Forms
    window.showForgotPasswordModal = showForgotPasswordModal;
    window.closeForgotPasswordModal = closeForgotPasswordModal;
    window.sendPasswordReset = sendPasswordReset;
    window.closeInvoiceModal = closeInvoiceModal;
    window.viewInvoiceDetails = viewInvoiceDetails;
    
    // Navigation
    window.showAdminSection = showAdminSection;
    window.showPassengerSection = showPassengerSection;
    window.showDriverSection = showDriverSection;
    window.showFinanceSubSection = showFinanceSubSection;
    
    // Admin Functions
    window.filterEmployees = filterEmployees;
    window.searchEmployees = searchEmployees;
    window.openAssignTargetModal = openAssignTargetModal;
    window.closeAssignTargetModal = closeAssignTargetModal;
    window.assignTargetToEmployee = assignTargetToEmployee;
    window.renderAttendanceSection = renderAttendanceSection;
    window.viewAttendanceDetails = viewAttendanceDetails;
    window.updateAttendanceModal = updateAttendanceModal;
    window.closeAttendanceModal = closeAttendanceModal;
    
    // Admin Tables
    window.filterAdminInvoices = filterAdminInvoices;
    window.editProfile = editProfile;
    window.closeEditBudgetModal = closeEditBudgetModal;
    window.updateBudget = updateBudget;
    
    // Split Profile
    window.openSplitProfileSelector = openSplitProfileSelector;
    window.closeSplitModals = closeSplitModals;
    window.renderSplitProfileSelectionTable = renderSplitProfileSelectionTable;
    window.selectProfileForSplit = selectProfileForSplit;
    window.renderSplitEmployeeSelectionTable = renderSplitEmployeeSelectionTable;
    window.confirmSplit = confirmSplit;
    window.removeSplit = removeSplit;
    
    // Finance
    window.showAddExpenseModal = showAddExpenseModal;
    window.closeAddExpenseModal = closeAddExpenseModal;
    window.addNewExpense = addNewExpense;
    window.deleteExpense = deleteExpense;
    window.searchEmployeesForSalary = searchEmployeesForSalary;
    window.showPartialPaymentModal = showPartialPaymentModal;
    window.closePartialPaymentModal = closePartialPaymentModal;
    window.processPartialPayment = processPartialPayment;
    window.markSalaryPaid = markSalaryPaid;
    
    // Passenger Functions
    window.showRateList = showRateList;
    window.closeRateList = closeRateList;
    window.calculateFare = calculateFare;
    window.useCalculatedFare = useCalculatedFare;
    window.calculateAndCreateInvoice = calculateAndCreateInvoice;
    window.filterPassengerProfiles = filterPassengerProfiles;
    window.editPassengerProfile = editPassengerProfile;
    
    // Driver Functions
    window.filterDriverInvoices = filterDriverInvoices;
    window.confirmPickup = confirmPickup;
    window.searchDrivers = searchDrivers;
    window.showAddDriverModal = showAddDriverModal;
    window.closeAddDriverModal = closeAddDriverModal;
    window.addNewDriver = addNewDriver;
    window.deleteDriver = deleteDriver;

    console.log("All functions exposed to window.");
    </script>
    <!-- Edit Budget Modal -->
    <div id="edit-budget-modal" class="invoice-modal">
        <div class="invoice-modal-content" style="max-width: 500px;">
            <button class="close-modal" onclick="closeEditBudgetModal()">&times;</button>
            <div class="invoice-header">
                <h2>Edit Profile Budget</h2>
                <p id="edit-profile-id">Profile #</p>
            </div>
            
            <div class="invoice-form">
                <div class="inputbox">
                    <input type="number" id="edit-total-budget" step="0.01" required="required">
                    <span>Total Budget (AED )</span>
                    <i></i>
                </div>
                <div class="inputbox">
                    <input type="number" id="edit-service-charges" step="0.01" required="required">
                    <span>Service Charges (AED )</span>
                    <i></i>
                </div>
                
                <div id="edit-calculated-results" style="background: rgba(26, 29, 37, 0.8); padding: 15px; border-radius: 8px; margin: 15px 0; display: none;">
                    <h4>Updated Results:</h4>
                    <p><strong>New Transport Amount:</strong> AED <span id="edit-transport-amount-result">0.00</span></p>
                    <p><strong>New Daily Budget:</strong> AED <span id="edit-daily-budget-result">0.00</span></p>
                </div>
                
                <div class="form-row">
                    <button class="bubbles btn-success" onclick="updateBudget()">
                        <span class="text">Update Budget</span>
                    </button>
                    <button class="bubbles btn-secondary" onclick="closeEditBudgetModal()">
                        <span class="text">Cancel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Assign Target Modal -->
    <div id="assign-target-modal" class="invoice-modal">
        <div class="invoice-modal-content" style="max-width: 500px;">
            <button class="close-modal" onclick="closeAssignTargetModal()">&times;</button>
            <div class="invoice-header">
                <h2>Assign Target</h2>
                <p id="target-employee-name">Employee Name</p>
            </div>
            
            <div class="invoice-form">
                <div class="form-row">
                    <div class="inputbox">
                        <input type="number" id="target-amount-input" step="1" required="required">
                        <span>Target Amount (AED )</span>
                        <i></i>
                    </div>
                    <div class="inputbox">
                        <input type="date" id="target-deadline" required="required">
                        <span>Deadline</span>
                        <i></i>
                    </div>
                </div>
                
                <div class="form-row">
                    <button class="bubbles btn-success" onclick="assignTargetToEmployee()">
                        <span class="text">Assign Target</span>
                    </button>
                    <button class="bubbles btn-secondary" onclick="closeAssignTargetModal()">
                        <span class="text">Cancel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Add Expense Modal -->
    <div id="add-expense-modal" class="invoice-modal">
        <div class="invoice-modal-content" style="max-width: 500px;">
            <button class="close-modal" onclick="closeAddExpenseModal()">&times;</button>
            <div class="invoice-header">
                <h2>Add New Expense</h2>
                <p>Record company expenses</p>
            </div>
            
            <div class="invoice-form">
                <div class="inputbox">
                    <input type="text" id="expense-type" required="required">
                    <span>Expense Type (e.g., Fuel, Maintenance, Office)</span>
                    <i></i>
                </div>
                <div class="inputbox">
                    <input type="number" id="expense-amount" step="0.01" required="required">
                    <span>Amount (AED )</span>
                    <i></i>
                </div>
                <div class="inputbox">
                    <input type="text" id="expense-description" required="required">
                    <span>Description</span>
                    <i></i>
                </div>
                
                <div class="form-row">
                    <button class="bubbles btn-success" onclick="addNewExpense()">
                        <span class="text">Save Expense</span>
                    </button>
                    <button class="bubbles btn-secondary" onclick="closeAddExpenseModal()">
                        <span class="text">Cancel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Forgot Password Modal -->
    <div id="forgot-password-modal" class="invoice-modal">
        <div class="invoice-modal-content" style="max-width: 400px;">
            <button class="close-modal" onclick="closeForgotPasswordModal()">&times;</button>
            <div class="invoice-header">
                <h2>Reset Password</h2>
                <p>Enter your email to receive a new password</p>
            </div>
            
            <div class="invoice-form">
                <div class="inputbox">
                    <input type="email" id="forgot-password-email" required="required">
                    <span>Email Address</span>
                    <i></i>
                </div>
                
                <div id="forgot-password-message" style="margin: 15px 0; padding: 10px; border-radius: 5px; display: none;"></div>
                
                <div class="form-row">
                    <button class="bubbles btn-success" onclick="sendPasswordReset()">
                        <span class="text">Send New Password</span>
                    </button>
                    <button class="bubbles btn-secondary" onclick="closeForgotPasswordModal()">
                        <span class="text">Cancel</span>
                    </button>
                </div>
            </div>
        </div>
    </div>    
    <div id="center-notification-modal" class="invoice-modal" style="z-index: 3000;">
        <div class="invoice-modal-content" style="max-width: 500px; text-align: center;">
            <button class="close-modal" onclick="dismissCenterNotifications()"></button> 
            <div class="invoice-header">
                <h2 style="color: var(--accent);">New Notifications</h2>
            </div>
            <div id="center-notification-list" style="margin-bottom: 30px; text-align: left;">
            </div>
            <button class="bubbles" onclick="dismissCenterNotifications()">
                <span class="text">Mark as Read & Close</span>
            </button>
        </div>
    </div>
</body>
</html>


